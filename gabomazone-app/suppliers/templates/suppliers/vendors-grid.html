{% extends 'base.html' %}
{% load static %}

{%block head%}
{{ block.super }}
<style>
    /* Masquer le preloader immédiatement pour cette page */
    #preloader-active {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
    
    /* S'assurer qu'il n'y a qu'un seul header et qu'il reste toujours visible */
    body > header.flavoriz-header:not(:first-of-type),
    body > .flavoriz-header:not(:first-of-type),
    .flavoriz-header ~ .flavoriz-header,
    header.flavoriz-header + header.flavoriz-header {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
    }
    
    /* Forcer le header à rester visible et fixe */
    .flavoriz-header {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 9999 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        transform: translateY(0) !important;
    }
</style>
{%endblock head%}

{%block body%}
<!-- ===== Suppliers List Page FLAVORIZ Design ===== -->
<main class="main pages shop-page-main" style="padding-top: 100px; padding-bottom: 100px; min-height: calc(100vh - 200px); background: linear-gradient(135deg, #FDF8F3 0%, #FFF9F5 100%);">
    <div class="container shop-page-container" style="max-width: 1400px; margin: 0 auto; padding: 0 24px; box-sizing: border-box;">
        <!-- Breadcrumb -->
        <nav style="margin-bottom: 20px; font-size: 13px; color: #6B7280; display: flex; align-items: center; gap: 6px;">
            <a href="{%url 'home:index'%}" style="color: var(--color-orange); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;">
                <i class="fi-rs-home"></i> <span>Accueil</span>
            </a>
            <span style="color: #9CA3AF;">/</span>
            <span style="color: #6B7280; font-weight: 500;">Magasins</span>
        </nav>

        <!-- Page Header -->
        <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
                <h1 style="font-size: 32px; font-weight: 700; color: #1F2937; margin: 0 0 6px 0; font-family: var(--font-primary);">Magasins Partenaires</h1>
                <p style="font-size: 14px; color: #6B7280; margin: 0;">Découvrez nos magasins partenaires</p>
            </div>
        </div>

        <!-- Section de recherche rétractable (masquée par défaut) -->
        <div class="vendors-search-form-container collapsed" style="max-width: 900px; margin: 0 auto 28px;">
            <div class="vendors-search-collapse-header" id="vendors-search-collapse-header" role="button" tabindex="0" aria-expanded="false" aria-controls="vendors-search-collapse-body" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: 2px solid #F3F4F6; cursor: pointer; transition: all 0.3s ease; margin-bottom: 0;">
                <span style="font-size: 15px; font-weight: 600; color: #1F2937; display: flex; align-items: center; gap: 10px;">
                    <i class="fi-rs-search" style="color: var(--color-orange); font-size: 18px;"></i>
                    Recherche et filtres
                </span>
                <i class="fi-rs-angle-small-down vendors-search-collapse-chevron" id="vendors-search-collapse-chevron" style="font-size: 20px; color: #6B7280; transition: transform 0.3s ease;"></i>
            </div>
            <div class="vendors-search-collapse-body" id="vendors-search-collapse-body" style="overflow: hidden;">
            <form id="vendors-search-form" class="vendors-search-form" style="background: white; border-radius: 0 0 20px 20px; padding: 12px 12px 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: 2px solid #F3F4F6; border-top: none; transition: all 0.3s ease;">
                <div class="vendors-search-row" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <div class="vendors-search-input-wrapper" style="flex: 1; min-width: 200px; display: flex; align-items: center; gap: 12px; padding: 0 16px; background: #FAFAFA; border-radius: 16px; border: 1px solid #E5E7EB; transition: all 0.2s ease;">
                        <i class="fi-rs-search" style="font-size: 18px; color: var(--color-orange); flex-shrink: 0;"></i>
                        <input type="text" id="vendor-search-q" name="q" placeholder="Rechercher un magasin..."
                               class="vendors-search-input" autocomplete="off"
                               style="flex: 1; border: none; outline: none; font-size: 15px; padding: 12px 0; color: #1F2937; font-family: var(--font-secondary); background: transparent;">
                    </div>
                    <input type="text" id="vendor-filter-city" name="city" placeholder="Ville"
                           style="width: 120px; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 13px; background: #FAFAFA; color: #1F2937; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary);"
                           autocomplete="off">
                    <!-- Liste déroulante Catégorie (custom) -->
                    <div class="flavoriz-dropdown" id="dropdown-category-wrap" style="position: relative; min-width: 180px;">
                        <input type="hidden" id="vendor-filter-category" name="category" value="">
                        <button type="button" class="flavoriz-dropdown-trigger" id="dropdown-category-trigger" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="dropdown-category-label">
                            <span class="flavoriz-dropdown-label" id="dropdown-category-label">Toutes les catégories</span>
                            <i class="fi-rs-angle-small-down flavoriz-dropdown-chevron"></i>
                        </button>
                        <div class="flavoriz-dropdown-panel" id="dropdown-category-panel" role="listbox" hidden>
                            <div class="flavoriz-dropdown-option" role="option" data-value="" data-label="Toutes les catégories" tabindex="0">Toutes les catégories</div>
                            {% for cat in super_categories %}
                            <div class="flavoriz-dropdown-option" role="option" data-value="{{ cat.slug }}" data-label="{{ cat.name }}" tabindex="0">{{ cat.name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- Liste déroulante Tri (custom) -->
                    <div class="flavoriz-dropdown" id="dropdown-order-wrap" style="position: relative; min-width: 160px;">
                        <input type="hidden" id="vendor-filter-order" name="order" value="recent">
                        <button type="button" class="flavoriz-dropdown-trigger" id="dropdown-order-trigger" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="dropdown-order-label">
                            <span class="flavoriz-dropdown-label" id="dropdown-order-label">Plus récents</span>
                            <i class="fi-rs-angle-small-down flavoriz-dropdown-chevron"></i>
                        </button>
                        <div class="flavoriz-dropdown-panel" id="dropdown-order-panel" role="listbox" hidden>
                            <div class="flavoriz-dropdown-option" role="option" data-value="recent" data-label="Plus récents" tabindex="0">Plus récents</div>
                            <div class="flavoriz-dropdown-option" role="option" data-value="popular" data-label="Plus populaires" tabindex="0">Plus populaires</div>
                        </div>
                    </div>
                    <button type="submit" id="vendor-search-btn" class="vendors-search-submit-btn" style="background: linear-gradient(135deg, var(--color-orange) 0%, #E65A1F 100%); color: white; border: none; border-radius: 16px; padding: 12px 28px; cursor: pointer; font-size: 15px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3); white-space: nowrap;">
                        <i class="fi-rs-search" style="font-size: 16px;"></i>
                        <span>Rechercher</span>
                    </button>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button type="button" id="vendor-reset-filters" style="background: none; border: none; color: #6B7280; font-size: 13px; cursor: pointer; padding: 4px 8px; display: inline-flex; align-items: center; gap: 6px; transition: color 0.2s ease;">
                        <i class="fi-rs-cross-small" style="font-size: 14px;"></i>
                        <span>Réinitialiser les filtres</span>
                    </button>
                </div>
            </form>
            </div>
        </div>

        <!-- Results Count -->
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 24px; padding: 18px 24px; background: white; border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); border: 1px solid #F3F4F6;">
            <p style="font-size: 14px; color: #6B7280; margin: 0; display: flex; align-items: center; gap: 6px;">
                <i class="fi-rs-store" style="color: var(--color-orange); font-size: 16px;"></i>
                <span>Nous avons trouvé <strong id="vendors-number" style="color: var(--color-orange); font-weight: 700;">0</strong> magasin(s)</span>
            </p>
                            </div>

        <!-- Vendors Grid (cartes de taille articles, comme la grille produits) -->
        <div id="vendors-list" class="vendors-grid flavoriz-vendors-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; width: 100%; max-width: 100%; box-sizing: border-box; padding: 0;">
            <!-- Vendors will be loaded here via AJAX -->
        </div>
                
        <!-- Loading Spinner -->
        <div id="spinner-box" class="not-visible" style="text-align: center; padding: 60px 20px;">
            <div class="flavoriz-spinner" style="margin: 0 auto;"></div>
            <p style="margin-top: 20px; color: #6B7280; font-size: 14px;">Chargement des magasins...</p>
            </div>

        <!-- Empty Box -->
        <div id="empty-box" class="not-visible" style="text-align: center; padding: 80px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
            <i class="fi-rs-store" style="font-size: 64px; color: #D1D5DB; opacity: 0.5; margin-bottom: 16px; display: block;"></i>
            <h2 style="font-size: 24px; font-weight: 600; color: #1F2937; margin-bottom: 12px;">Aucun magasin trouvé</h2>
            <p style="font-size: 16px; color: #6B7280; margin: 0;">Les magasins partenaires seront bientôt disponibles.</p>
                      </div>

        <!-- Load More Button -->
        <div id="loading-box" class="not-visible" style="text-align: center; padding: 40px 20px;">
            <button id="load-btn" type="button" 
                    style="padding: 14px 32px; background: var(--color-orange); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3); display: inline-flex; align-items: center; gap: 8px;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255, 123, 44, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 123, 44, 0.3)'">
                <i class="fi-rs-arrow-down"></i>
                <span>Charger plus</span>
            </button>
        </div>
    </div>
</main>

<style>
.not-visible {
    display: none !important;
}

#load-btn:hover {
    background: #E65A1F !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(255, 123, 44, 0.4) !important;
}

/* Section recherche rétractable */
.vendors-search-collapse-header:hover {
    border-color: rgba(255, 123, 44, 0.3) !important;
    background: #FDFCFB !important;
}
.vendors-search-collapse-header:focus {
    outline: none;
    border-color: var(--color-orange) !important;
    box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.12);
}
.vendors-search-form-container.collapsed .vendors-search-collapse-header {
    border-radius: 20px;
    margin-bottom: 0;
}
.vendors-search-form-container.collapsed .vendors-search-collapse-chevron {
    transform: rotate(-90deg);
}
/* Marges horizontales */
.shop-page-main .shop-page-container { padding-left: 24px !important; padding-right: 24px !important; box-sizing: border-box !important; }
@media (max-width: 768px) {
    .shop-page-main .shop-page-container { padding-left: 16px !important; padding-right: 16px !important; }
}

/* Transition fluide section recherche magasins */
.vendors-search-collapse-body {
    overflow: hidden;
    max-height: 420px;
    transition: max-height 0.45s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s ease;
}
.vendors-search-form-container.collapsed .vendors-search-collapse-body {
    max-height: 0 !important;
    opacity: 0;
    margin-top: 0;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
}
.vendors-search-collapse-chevron {
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Barre de recherche magasins - style moderne */
.vendors-search-form-container { width: 100%; }
.vendors-search-form:focus-within,
.vendors-search-form:hover {
    border-color: rgba(255, 123, 44, 0.3) !important;
}
.vendors-search-form:has(.vendors-search-input-wrapper:focus-within) {
    box-shadow: 0 6px 24px rgba(255, 123, 44, 0.12) !important;
    border-color: var(--color-orange) !important;
}
.vendors-search-input-wrapper:focus-within {
    border-color: var(--color-orange) !important;
    box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1) !important;
}
.vendors-search-input-wrapper:hover {
    border-color: #D1D5DB !important;
}
.vendors-search-form input[type="text"][name="city"]:hover {
    border-color: #D1D5DB !important;
}
.vendors-search-form input[type="text"][name="city"]:focus {
    border-color: var(--color-orange) !important;
    outline: none !important;
}

/* Listes déroulantes personnalisées */
.flavoriz-dropdown-trigger {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 12px 14px;
    border: 2px solid #E5E7EB;
    border-radius: 12px;
    font-size: 13px;
    background: #FAFAFA;
    color: #1F2937;
    cursor: pointer;
    outline: none;
    transition: all 0.2s ease;
    font-family: var(--font-secondary);
    text-align: left;
    min-height: 44px;
}
.flavoriz-dropdown-trigger:hover {
    border-color: #D1D5DB;
    background: #F9FAFB;
}
.flavoriz-dropdown-trigger:focus {
    border-color: var(--color-orange);
    box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.12);
}
.flavoriz-dropdown.open .flavoriz-dropdown-trigger {
    border-color: var(--color-orange);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1);
}
.flavoriz-dropdown-label {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.flavoriz-dropdown-chevron {
    font-size: 16px;
    color: #6B7280;
    flex-shrink: 0;
    transition: transform 0.2s ease;
}
.flavoriz-dropdown.open .flavoriz-dropdown-chevron {
    transform: rotate(180deg);
    color: var(--color-orange);
}
.flavoriz-dropdown-panel {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    right: 0;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 2px 10px rgba(0, 0, 0, 0.06);
    border: 1px solid #E5E7EB;
    max-height: 280px;
    overflow-y: auto;
    z-index: 1000;
    padding: 6px 0;
}
.flavoriz-dropdown-panel[hidden] {
    display: none !important;
}
.flavoriz-dropdown-option {
    padding: 12px 16px;
    font-size: 14px;
    color: #1F2937;
    cursor: pointer;
    transition: background 0.15s ease, color 0.15s ease;
    font-family: var(--font-secondary);
    display: flex;
    align-items: center;
    gap: 10px;
    border: none;
    width: 100%;
    text-align: left;
    background: none;
}
.flavoriz-dropdown-option:hover {
    background: #FDF8F3;
    color: var(--color-orange);
}
.flavoriz-dropdown-option.selected {
    background: rgba(255, 123, 44, 0.1);
    color: var(--color-orange);
    font-weight: 600;
}
.flavoriz-dropdown-option:focus {
    outline: none;
    background: #F3F4F6;
}
.flavoriz-dropdown-option:focus:hover,
.flavoriz-dropdown-option.selected:hover {
    background: #FDF8F3;
}
.vendors-search-submit-btn:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(255, 123, 44, 0.4) !important;
}
#vendor-reset-filters:hover { color: var(--color-orange) !important; }

/* Grille magasins desktop : même taille que les cartes articles (4 colonnes, gap 20px) */
.flavoriz-vendors-grid {
    display: grid !important;
    gap: 20px !important;
    margin-bottom: 24px !important;
}
@media (min-width: 1200px) {
    .flavoriz-vendors-grid {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 20px !important;
    }
}
@media (min-width: 992px) and (max-width: 1199px) {
    .flavoriz-vendors-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 20px !important;
    }
}
@media (min-width: 768px) and (max-width: 991px) {
    .flavoriz-vendors-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 18px !important;
    }
}
@media (min-width: 600px) and (max-width: 767px) {
    .flavoriz-vendors-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 16px !important;
    }
}
@media (max-width: 599px) {
    .flavoriz-vendors-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
    }
}

/* Cartes magasins : style article (comme flavoriz-product-card) */
.vendor-card {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    background: white !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
    border: 1px solid #F3F4F6 !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    text-decoration: none !important;
    color: inherit !important;
}
.vendor-card:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(255, 123, 44, 0.15) !important;
    border-color: rgba(255, 123, 44, 0.25) !important;
}
.vendor-card-image {
    width: 100% !important;
    aspect-ratio: 1 !important;
    overflow: hidden !important;
    background: linear-gradient(135deg, #FDF8F3 0%, #FFE5D4 100%) !important;
    position: relative !important;
}
.vendor-card-image img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    transition: transform 0.35s ease !important;
}
.vendor-card:hover .vendor-card-image img {
    transform: scale(1.06) !important;
}
.vendor-card-body {
    padding: 16px !important;
    display: flex !important;
    flex-direction: column !important;
    flex: 1 !important;
    min-height: 0 !important;
}
.vendor-card-title {
    font-size: 15px !important;
    font-weight: 700 !important;
    color: #1F2937 !important;
    margin: 0 0 6px 0 !important;
    line-height: 1.35 !important;
    display: -webkit-box !important;
    -webkit-line-clamp: 2 !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
}
.vendor-card-meta {
    font-size: 12px !important;
    color: #6B7280 !important;
    margin: 0 !important;
    line-height: 1.4 !important;
}

@media (max-width: 599px) {
    .vendor-card-image { aspect-ratio: 1 !important; }
    .vendor-card-body { padding: 12px !important; }
    .vendor-card-title { font-size: 14px !important; }
}

@media (max-width: 768px) {
    .main.pages {
        padding-top: 80px !important;
        padding-bottom: 60px !important;
    }
    h1 { font-size: 24px !important; }
    .vendors-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
    }
    .vendors-search-row {
        flex-direction: column !important;
        align-items: stretch !important;
    }
    .vendors-search-input-wrapper { min-width: 100% !important; }
    #vendor-filter-city { width: 100% !important; box-sizing: border-box !important; }
    #dropdown-category-wrap,
    #dropdown-order-wrap { min-width: 100% !important; }
    .vendors-search-submit-btn { width: 100% !important; justify-content: center !important; }
}
</style>
{%endblock body%}

{%block script%}
{{ block.super }}
    <script src="{% static 'assets/js/vendor/jquery-3.6.0.min.js'%}"></script>
<script>
(function() {
    'use strict';
    
    let visible = 12;
    const vendorsList = document.getElementById('vendors-list');
    const spinnerBox = document.getElementById('spinner-box');
    const emptyBox = document.getElementById('empty-box');
    const loadingBox = document.getElementById('loading-box');
    const loadBtn = document.getElementById('load-btn');
    const vendorsNumber = document.getElementById('vendors-number');
    const searchForm = document.getElementById('vendors-search-form');
    const searchInput = document.getElementById('vendor-search-q');
    const cityInput = document.getElementById('vendor-filter-city');
    const categorySelect = document.getElementById('vendor-filter-category');
    const orderSelect = document.getElementById('vendor-filter-order');
    const resetBtn = document.getElementById('vendor-reset-filters');
    const collapseHeader = document.getElementById('vendors-search-collapse-header');
    const collapseBody = document.getElementById('vendors-search-collapse-body');
    const collapseContainer = document.querySelector('.vendors-search-form-container');
    
    function initSearchCollapse() {
        if (!collapseHeader || !collapseBody || !collapseContainer) return;
        var stored = sessionStorage.getItem('vendors-search-collapsed');
        if (stored !== '0') {
            collapseContainer.classList.add('collapsed');
            collapseHeader.setAttribute('aria-expanded', 'false');
        } else {
            collapseHeader.setAttribute('aria-expanded', 'true');
        }
        collapseHeader.addEventListener('click', function() {
            var isCollapsed = collapseContainer.classList.toggle('collapsed');
            collapseHeader.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
            sessionStorage.setItem('vendors-search-collapsed', isCollapsed ? '1' : '0');
        });
        collapseHeader.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                collapseHeader.click();
            }
        });
    }
    
    function initCustomDropdowns() {
        var dropdowns = [
            { wrap: 'dropdown-category-wrap', trigger: 'dropdown-category-trigger', panel: 'dropdown-category-panel', hidden: 'vendor-filter-category', labelEl: 'dropdown-category-label' },
            { wrap: 'dropdown-order-wrap', trigger: 'dropdown-order-trigger', panel: 'dropdown-order-panel', hidden: 'vendor-filter-order', labelEl: 'dropdown-order-label' }
        ];
        dropdowns.forEach(function(d) {
            var wrap = document.getElementById(d.wrap);
            var trigger = document.getElementById(d.trigger);
            var panel = document.getElementById(d.panel);
            var hidden = document.getElementById(d.hidden);
            var labelEl = document.getElementById(d.labelEl);
            if (!wrap || !trigger || !panel || !hidden) return;
            function close() {
                wrap.classList.remove('open');
                panel.setAttribute('hidden', '');
                trigger.setAttribute('aria-expanded', 'false');
            }
            function open() {
                wrap.classList.add('open');
                panel.removeAttribute('hidden');
                trigger.setAttribute('aria-expanded', 'true');
            }
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var isOpen = wrap.classList.contains('open');
                document.querySelectorAll('.flavoriz-dropdown.open').forEach(function(w) {
                    if (w !== wrap) {
                        w.classList.remove('open');
                        var p = w.querySelector('.flavoriz-dropdown-panel');
                        if (p) p.setAttribute('hidden', '');
                    }
                });
                if (isOpen) close(); else open();
            });
            panel.querySelectorAll('.flavoriz-dropdown-option').forEach(function(opt) {
                opt.addEventListener('click', function(e) {
                    e.preventDefault();
                    var val = opt.getAttribute('data-value');
                    var label = opt.getAttribute('data-label');
                    hidden.value = val || '';
                    if (labelEl) labelEl.textContent = label;
                    panel.querySelectorAll('.flavoriz-dropdown-option').forEach(function(o) { o.classList.remove('selected'); });
                    opt.classList.add('selected');
                    close();
                });
                opt.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        opt.click();
                    }
                });
            });
            wrap.querySelectorAll('.flavoriz-dropdown-option').forEach(function(opt) {
                if (opt.getAttribute('data-value') === (hidden.value || '')) opt.classList.add('selected');
            });
        });
        document.addEventListener('click', function() {
            document.querySelectorAll('.flavoriz-dropdown.open').forEach(function(w) {
                w.classList.remove('open');
                var p = w.querySelector('.flavoriz-dropdown-panel');
                if (p) p.setAttribute('hidden', '');
            });
        });
        document.querySelectorAll('.flavoriz-dropdown').forEach(function(w) {
            w.addEventListener('click', function(e) { e.stopPropagation(); });
        });
    }
    
    function getSearchParams() {
        const q = (searchInput && searchInput.value) ? searchInput.value.trim() : '';
        const city = (cityInput && cityInput.value) ? cityInput.value.trim() : '';
        const category = (categorySelect && categorySelect.value) ? categorySelect.value.trim() : '';
        const order = (orderSelect && orderSelect.value) ? orderSelect.value.trim() : 'recent';
        return { q: q, city: city, category: category, order: order };
    }
    
    function buildVendorsUrl(numVendors) {
        const base = '{% url "suppliers:vendors-ajax" %}';
        const params = new URLSearchParams();
        params.set('num_vendors', String(numVendors));
        const sp = getSearchParams();
        if (sp.q) params.set('q', sp.q);
        if (sp.city) params.set('city', sp.city);
        if (sp.category) params.set('category', sp.category);
        if (sp.order) params.set('order', sp.order);
        return base + '?' + params.toString();
    }
    
    function handleGetVendors(sorted) {
        if (window.isLoadingVendors) {
            return;
        }
        window.isLoadingVendors = true;
        
        if (sorted) {
            vendorsList.innerHTML = "";
            visible = 12;
        }
        
        spinnerBox.classList.remove('not-visible');
        emptyBox.classList.add('not-visible');
        loadingBox.classList.add('not-visible');
        
        const url = buildVendorsUrl(visible);
        
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            spinnerBox.classList.add('not-visible');
            window.isLoadingVendors = false;
            
            if (data.vendors_size !== undefined) {
                vendorsNumber.textContent = data.vendors_size;
            }
            
            if (data.data && data.data.length > 0) {
                data.data.forEach(function(vendor) {
                    const vendorCard = createVendorCard(vendor);
                    vendorsList.appendChild(vendorCard);
                });
                
                if (data.max) {
                    loadingBox.classList.add('not-visible');
                } else {
                    loadingBox.classList.remove('not-visible');
                }
            } else {
                if (vendorsList.children.length === 0) {
                    emptyBox.classList.remove('not-visible');
                }
                loadingBox.classList.add('not-visible');
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des magasins:', error);
            spinnerBox.classList.add('not-visible');
            window.isLoadingVendors = false;
            if (vendorsList.children.length === 0) {
                emptyBox.classList.remove('not-visible');
            }
            loadingBox.classList.add('not-visible');
        });
    }
    
    function createVendorCard(vendor) {
        const imageUrl = vendor.image ? '/media/' + vendor.image : '{% static "assets/imgs/theme/icons/icon-store.svg" %}';
        const displayName = (vendor.display_name || (vendor.user && vendor.user.username) || 'Magasin').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const slug = vendor.slug || '';
        const sinceText = vendor.since_text || '';
        const avgRating = vendor.average_rating != null ? Number(vendor.average_rating) : 0;
        const totalRatings = vendor.total_ratings != null ? parseInt(vendor.total_ratings, 10) : 0;
        const ratingLabel = totalRatings > 0
            ? (avgRating.toFixed(1).replace('.', ',') + ' ★ · ' + totalRatings + ' avis')
            : 'Aucun avis';
        const metaText = sinceText ? sinceText + (totalRatings > 0 ? ' · ' + ratingLabel : '') : (totalRatings > 0 ? ratingLabel : 'Nouveau');

        const card = document.createElement('a');
        card.href = '/suppliers/vendor-details/' + (slug || '');
        card.className = 'vendor-card';

        card.innerHTML = `
            <div class="vendor-card-image">
                <img src="${imageUrl}" alt="${displayName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; background: linear-gradient(135deg, #FDF8F3 0%, #FFE5D4 100%);">
                    <i class="fi-rs-store" style="font-size: 48px; color: var(--color-orange);"></i>
                </div>
            </div>
            <div class="vendor-card-body">
                <h3 class="vendor-card-title">${displayName}</h3>
                <p class="vendor-card-meta">${metaText}</p>
            </div>
        `;

        return card;
    }
    
    // Form submit: search with filters
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            visible = 12;
            handleGetVendors(true);
        });
    }
    
    // Reset filters
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            if (searchInput) searchInput.value = '';
            if (cityInput) cityInput.value = '';
            if (categorySelect) categorySelect.value = '';
            if (orderSelect) orderSelect.value = 'recent';
            var catLabel = document.getElementById('dropdown-category-label');
            var orderLabel = document.getElementById('dropdown-order-label');
            if (catLabel) catLabel.textContent = 'Toutes les catégories';
            if (orderLabel) orderLabel.textContent = 'Plus récents';
            document.querySelectorAll('#dropdown-category-panel .flavoriz-dropdown-option').forEach(function(o) {
                o.classList.remove('selected');
                if ((o.getAttribute('data-value') || '') === '') o.classList.add('selected');
            });
            document.querySelectorAll('#dropdown-order-panel .flavoriz-dropdown-option').forEach(function(o) {
                o.classList.remove('selected');
                if (o.getAttribute('data-value') === 'recent') o.classList.add('selected');
            });
            visible = 12;
            handleGetVendors(true);
        });
    }
    
    initCustomDropdowns();
    initSearchCollapse();
    
    // Initial load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            handleGetVendors(true);
        });
    } else {
        handleGetVendors(true);
    }
    
    // Load more button
    if (loadBtn) {
        loadBtn.addEventListener('click', function() {
            visible += 12;
            handleGetVendors(false);
        });
    }
})();
</script>
{%endblock script%}
