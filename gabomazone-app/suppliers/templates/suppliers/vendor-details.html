{% extends 'base.html' %}
{% load static %}
{% load cart_template_tags %}

{%block body%}
<style>
    /* ===== Vendor Details Page - Design épuré et moderne ===== */
    .flavoriz-vendor-page {
        padding: 0;
        background: linear-gradient(180deg, #FDF8F3 0%, #FFFFFF 180px);
        min-height: calc(100vh - 200px);
    }
    
    .flavoriz-vendor-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
    }
    
    .flavoriz-vendor-breadcrumb {
        padding: 20px 0 16px;
        font-size: 13px;
        color: #6B7280;
        margin-bottom: 0;
    }
    
    .flavoriz-vendor-breadcrumb a {
        color: var(--color-orange);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
    }
    
    .flavoriz-vendor-breadcrumb a:hover {
        color: #E65A1F;
    }
    
    /* Bannière magasin – design soigné */
    .flavoriz-vendor-header {
        background: linear-gradient(165deg, #FFFFFF 0%, #FFF9F6 45%, #FFF5EF 100%);
        border-radius: 24px;
        padding: 0;
        margin-bottom: 32px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(255, 123, 44, 0.06);
        border: 1px solid rgba(255, 123, 44, 0.12);
        position: relative;
        overflow: hidden;
    }
    .flavoriz-vendor-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--color-orange) 0%, #FFB088 50%, var(--color-orange) 100%);
        opacity: 0.9;
    }
    .flavoriz-vendor-header-content {
        display: flex;
        flex-wrap: wrap;
        gap: 32px;
        align-items: flex-start;
        padding: 36px 40px 40px;
    }
    .flavoriz-vendor-avatar {
        width: 140px;
        height: 140px;
        border-radius: 24px;
        overflow: hidden;
        border: 4px solid white;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.04);
        background: linear-gradient(135deg, #FDF8F3 0%, #FFE5D4 100%);
        flex-shrink: 0;
    }
    .flavoriz-vendor-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .flavoriz-vendor-info {
        flex: 1;
        min-width: 0;
    }
    .flavoriz-vendor-info-top {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px 20px;
        margin-bottom: 14px;
    }
    .flavoriz-vendor-name {
        font-size: 30px;
        font-weight: 800;
        margin: 0;
        color: #1F2937;
        line-height: 1.2;
        letter-spacing: -0.02em;
    }
    .flavoriz-vendor-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 7px 14px;
        background: rgba(255, 123, 44, 0.12);
        color: var(--color-orange);
        border-radius: 10px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .flavoriz-vendor-badge.premium {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: #1F2937;
        box-shadow: 0 2px 8px rgba(255, 165, 0, 0.3);
    }
    .flavoriz-vendor-meta-line {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 20px 28px;
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 18px;
    }
    .flavoriz-vendor-meta-line span {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .flavoriz-vendor-meta-line i {
        color: var(--color-orange);
        font-size: 15px;
    }
    .flavoriz-vendor-description {
        font-size: 15px;
        line-height: 1.65;
        color: #4B5563;
        margin: 0 0 20px 0;
        max-width: 640px;
    }
    .flavoriz-vendor-details-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 0;
    }
    .flavoriz-vendor-detail-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #6B7280;
        padding: 10px 16px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        border: 1px solid rgba(255, 123, 44, 0.15);
    }
    .flavoriz-vendor-detail-item i {
        font-size: 16px;
        color: var(--color-orange);
        flex-shrink: 0;
    }
    .flavoriz-vendor-detail-item span {
        line-height: 1.4;
    }
    .flavoriz-vendor-social {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 22px;
        padding-top: 22px;
        border-top: 1px solid rgba(255, 123, 44, 0.12);
    }
    .flavoriz-vendor-social-title {
        font-size: 13px;
        font-weight: 600;
        color: #6B7280;
        margin-right: 4px;
    }
    .flavoriz-vendor-social-link {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 123, 44, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6B7280;
        text-decoration: none;
        transition: all 0.25s ease;
    }
    .flavoriz-vendor-social-link:hover {
        background: var(--color-orange);
        color: white;
        border-color: var(--color-orange);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3);
    }
    
    /* Section Produits */
    .flavoriz-vendor-products-section {
        background: white;
        border-radius: 20px;
        padding: 28px 32px 32px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        border: 1px solid #F3F4F6;
        margin-bottom: 32px;
    }
    
    .flavoriz-vendor-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .flavoriz-vendor-section-title {
        font-size: 22px;
        font-weight: 700;
        color: #1F2937;
        margin: 0;
    }
    
    .flavoriz-vendor-filter {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .flavoriz-vendor-filter select {
        padding: 10px 16px;
        border: 2px solid #E5E7EB;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        color: #1F2937;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%236B7280' d='M7 10L2 5h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 14px;
        padding-right: 40px;
    }
    
    .flavoriz-vendor-filter select:focus {
        outline: none;
        border-color: var(--color-orange);
        box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1);
    }
    
    .flavoriz-vendor-products-count {
        font-size: 14px;
        color: #6B7280;
        font-weight: 500;
    }
    
    /* Grille produits : même style que page Produits (4 colonnes desktop) */
    .flavoriz-vendor-products-grid.flavoriz-product-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin-bottom: 24px;
        padding: 0;
    }
    .flavoriz-vendor-products-grid.flavoriz-product-grid > * {
        width: 100%;
        min-width: 0;
        max-width: 100%;
        box-sizing: border-box;
    }
    /* Cartes produits : identiques à la page Produits */
    .flavoriz-vendor-products-section .flavoriz-product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #F3F4F6;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .flavoriz-vendor-products-section .flavoriz-product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(255, 123, 44, 0.15);
        border-color: rgba(255, 123, 44, 0.25);
    }
    .flavoriz-vendor-products-section .flavoriz-product-image-wrap {
        width: 100%;
        aspect-ratio: 1;
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, #FDF8F3 0%, #FFE5D4 100%);
    }
    .flavoriz-vendor-products-section .flavoriz-product-image-wrap .flavoriz-product-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.35s ease;
    }
    .flavoriz-vendor-products-section .flavoriz-product-card:hover .flavoriz-product-image-wrap .flavoriz-product-image {
        transform: scale(1.06);
    }
    .flavoriz-vendor-products-section .flavoriz-product-body {
        padding: 16px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .flavoriz-vendor-products-section .flavoriz-product-title {
        font-size: 13px;
        font-weight: 600;
        color: #1F2937;
        margin: 0 0 6px 0;
        line-height: 1.35;
        min-height: 36px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .flavoriz-vendor-products-section .flavoriz-product-price {
        font-size: 16px;
        font-weight: 700;
        color: var(--color-orange);
    }
    .flavoriz-vendor-products-section .flavoriz-product-card-btn:hover {
        background: var(--color-orange);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3);
    }
    
    .flavoriz-vendor-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: sticky;
        top: 100px;
    }
    
    .flavoriz-vendor-sidebar:empty {
        display: none;
    }
    
    .flavoriz-vendor-sidebar-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #F3F4F6;
    }
    
    .flavoriz-vendor-ad-banner {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .flavoriz-vendor-ad-banner:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .flavoriz-vendor-ad-banner img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Loading States */
    .flavoriz-vendor-loading {
        text-align: center;
        padding: 40px;
    }
    
    .flavoriz-vendor-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #F3F4F6;
        border-top-color: var(--color-orange);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .not-visible {
        display: none !important;
    }
    
    #loading-indicator.htmx-request {
        display: block !important;
    }
    
    @media (max-width: 1024px) {
        .flavoriz-vendor-main-content {
            grid-template-columns: 1fr !important;
        }
        .flavoriz-vendor-sidebar {
            position: static;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 16px;
        }
        .flavoriz-vendor-sidebar-card {
            flex: 1 1 280px;
            max-width: 100%;
        }
        .flavoriz-vendor-products-grid.flavoriz-product-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
        }
    }
    
    @media (max-width: 768px) {
        .flavoriz-vendor-container {
            padding: 0 16px;
        }
        .flavoriz-vendor-header {
            border-radius: 20px;
        }
        .flavoriz-vendor-header-content {
            padding: 28px 20px 28px;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 20px;
        }
        .flavoriz-vendor-avatar {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            border-width: 3px;
        }
        .flavoriz-vendor-info {
            width: 100%;
        }
        .flavoriz-vendor-info-top {
            justify-content: center;
        }
        .flavoriz-vendor-name {
            font-size: 22px;
            width: 100%;
        }
        .flavoriz-vendor-meta-line {
            justify-content: center;
            gap: 16px;
        }
        .flavoriz-vendor-description {
            text-align: center;
            margin-left: auto;
            margin-right: auto;
        }
        .flavoriz-vendor-details-grid {
            justify-content: center;
        }
        .flavoriz-vendor-social {
            justify-content: center;
        }
        .flavoriz-vendor-products-section {
            padding: 20px 16px;
            border-radius: 16px;
        }
        .flavoriz-vendor-section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        .flavoriz-vendor-section-title {
            font-size: 20px;
        }
        .flavoriz-vendor-products-grid.flavoriz-product-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .flavoriz-vendor-products-section .flavoriz-product-card {
            min-width: 0;
        }
        .flavoriz-vendor-products-section .flavoriz-product-body {
            padding: 12px;
            min-width: 0;
        }
        .flavoriz-vendor-products-section .flavoriz-product-title {
            font-size: 12px;
            min-height: 32px;
            -webkit-line-clamp: 2;
        }
        .flavoriz-vendor-products-section .flavoriz-product-price {
            font-size: 14px;
        }
        .flavoriz-vendor-products-section .flavoriz-product-card-btn {
            padding: 6px 10px;
            font-size: 12px;
        }
        .flavoriz-vendor-filter {
            width: 100%;
        }
        .flavoriz-vendor-filter select {
            width: 100%;
        }
    }
</style>

<main class="main">
    <div class="flavoriz-vendor-page">
        <div class="flavoriz-vendor-container">
            <!-- Breadcrumb -->
            <div class="flavoriz-vendor-breadcrumb">
                <a href="{% url 'home:index' %}"><i class="fi-rs-home"></i> Accueil</a>
                <span> / </span>
                <a href="{% url 'suppliers:supplier-list' %}">Vendeurs</a>
                <span> / </span>
                <span>{{vendor_detail.display_name|default:vendor_detail.user.username}}</span>
            </div>
            
            <!-- Bannière vendeur (épurée) -->
            <div class="flavoriz-vendor-header">
                <div class="flavoriz-vendor-header-content">
                    <div class="flavoriz-vendor-avatar">
                        {% if vendor_detail.image %}
                        <img src="{{ vendor_detail.image.url }}" alt="{{ vendor_detail.display_name|default:vendor_detail.user.username }}" />
                        {% else %}
                        <div style="width: 100%; height: 100%; background: linear-gradient(135deg, var(--color-orange) 0%, #E65A1F 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 42px; font-weight: 700;">
                            {{ vendor_detail.display_name|default:vendor_detail.user.username|first|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="flavoriz-vendor-info">
                        <div class="flavoriz-vendor-info-top">
                            <h1 class="flavoriz-vendor-name">{{ vendor_detail.display_name|default:vendor_detail.user.username }}</h1>
                            <span class="flavoriz-vendor-badge">
                                <i class="fi-rs-check-circle"></i>
                                Vendeur vérifié
                            </span>
                            {% if is_premium %}
                            <span class="flavoriz-vendor-badge premium">
                                <i class="fi-rs-crown"></i>
                                Premium
                            </span>
                            {% endif %}
                        </div>
                        <div class="flavoriz-vendor-meta-line">
                            <span><i class="fi-rs-calendar"></i> Membre depuis {{ vendor_detail.date|date:"F Y" }}</span>
                            <span><i class="fi-rs-star" style="color: #F59E0B;"></i> <strong style="color: #1F2937;">{{ average_rating|default:"0.0" }}</strong> {% if total_ratings > 0 %}({{ total_ratings }} avis){% else %}(Aucun avis){% endif %}</span>
                        </div>
                        {% if vendor_detail.bio %}
                        <p class="flavoriz-vendor-description">{{ vendor_detail.bio }}</p>
                        {% endif %}
                        <div class="flavoriz-vendor-details-grid">
                            {% if vendor_detail.address or vendor_detail.city or vendor_detail.country %}
                            <div class="flavoriz-vendor-detail-item">
                                <i class="fi-rs-marker"></i>
                                <span>
                                    {% if vendor_detail.address %}{{ vendor_detail.address }}{% endif %}
                                    {% if vendor_detail.city %}{% if vendor_detail.address %}, {% endif %}{{ vendor_detail.city }}{% endif %}
                                    {% if vendor_detail.post_code %} {{ vendor_detail.post_code }}{% endif %}
                                    {% if vendor_detail.country %}{% if vendor_detail.city or vendor_detail.address %}, {% endif %}{{ vendor_detail.country }}{% endif %}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        {% if vendor_social_links %}
                        <div class="flavoriz-vendor-social">
                            <span class="flavoriz-vendor-social-title">Suivez-nous</span>
                            {% if vendor_social_links.twitter %}
                            <a href="https://twitter.com/{{ vendor_social_links.twitter }}" class="flavoriz-vendor-social-link" target="_blank" rel="noopener"><i class="fi-rs-social-twitter"></i></a>
                            {% endif %}
                            {% if vendor_social_links.facebook %}
                            <a href="https://www.facebook.com/{{ vendor_social_links.facebook }}" class="flavoriz-vendor-social-link" target="_blank" rel="noopener"><i class="fi-rs-social-facebook"></i></a>
                            {% endif %}
                            {% if vendor_social_links.instagram %}
                            <a href="https://www.instagram.com/{{ vendor_social_links.instagram }}" class="flavoriz-vendor-social-link" target="_blank" rel="noopener"><i class="fi-rs-social-instagram"></i></a>
                            {% endif %}
                            {% if vendor_social_links.pinterest %}
                            <a href="https://www.pinterest.com/{{ vendor_social_links.pinterest }}" class="flavoriz-vendor-social-link" target="_blank" rel="noopener"><i class="fi-rs-social-pinterest"></i></a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Contenu principal -->
            <div class="flavoriz-vendor-main-content{% if not has_sidebar_ads %} flavoriz-vendor-main-content--no-sidebar{% endif %}" style="display: grid; grid-template-columns: {% if has_sidebar_ads %}1fr 280px{% else %}1fr{% endif %}; gap: 28px; align-items: start;">
                <div class="flavoriz-vendor-products-section">
                    <form id="vendor-sort-form"
                          hx-get="{% url 'suppliers:vendor-products-htmx' %}"
                          hx-target="#products-list"
                          hx-swap="innerHTML"
                          hx-trigger="change from:#mySelect"
                          hx-include="this"
                          hx-indicator="#loading-indicator"
                          style="margin: 0;">
                        <input type="hidden" name="vendor_id" value="{{ vendor_detail.id }}" />
                        <input type="hidden" name="page" value="1" />
                        <div class="flavoriz-vendor-section-header">
                            <h2 class="flavoriz-vendor-section-title">Produits du vendeur</h2>
                            <div class="flavoriz-vendor-filter">
                                <span class="flavoriz-vendor-products-count" id="items-number">Chargement...</span>
                                <select class="flavoriz-vendor-filter-select" id="mySelect" name="order_by">
                                    <option value="-date" selected>Date, récent à ancien</option>
                                    <option value="date">Date, ancien à récent</option>
                                    <option value="PRDPrice">Prix, croissant</option>
                                    <option value="-PRDPrice">Prix, décroissant</option>
                                </select>
                            </div>
                        </div>
                    </form>
                    
                    <div id="loading-indicator" class="htmx-indicator flavoriz-vendor-loading" style="display: none;">
                        <div class="flavoriz-vendor-spinner"></div>
                        <p style="color: #6B7280; margin: 0;">Chargement des produits...</p>
                    </div>
                    
                    <div id="products-list"
                         class="flavoriz-vendor-products-grid flavoriz-product-grid"
                         hx-get="{% url 'suppliers:vendor-products-htmx' %}?vendor_id={{ vendor_detail.id }}&page=1&order_by=-date"
                         hx-trigger="load"
                         hx-swap="innerHTML"
                         hx-target="this"
                         hx-indicator="#loading-indicator">
                        <!-- Produits chargés via HTMX (même liste que page Produits) -->
                    </div>
                </div>
                
                <!-- Sidebar (uniquement bannières pub) -->
                {% if has_sidebar_ads %}
                <aside class="flavoriz-vendor-sidebar">
                    {% for image_ad in vendor_page_ad_image|slice:":1" %}
                    <div class="flavoriz-vendor-sidebar-card" style="padding: 0; overflow: hidden;">
                        <a href="{% if image_ad.ad_URL %}{{ image_ad.ad_URL }}{% else %}#{% endif %}" class="flavoriz-vendor-ad-banner">
                            <img src="{{ image_ad.ad_mage.url }}" alt="Publicité" loading="lazy" />
                        </a>
                    </div>
                    {% endfor %}
                    {% for shop_ad in shop_page_ad|slice:":1" %}
                    <div class="flavoriz-vendor-sidebar-card" style="padding: 0; overflow: hidden;">
                        <a href="{% if shop_ad.ad_URL %}{{ shop_ad.ad_URL }}{% else %}#{% endif %}" class="flavoriz-vendor-ad-banner">
                            <img src="{{ shop_ad.ad_mage.url }}" alt="{{ shop_ad.ad_title|default:'Publicité' }}" loading="lazy" />
                        </a>
                    </div>
                    {% endfor %}
                </aside>
                {% endif %}
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'products-list' && typeof window.attachProductEventListeners === 'function') {
        window.attachProductEventListeners();
    }
});
</script>

{%endblock body%}
