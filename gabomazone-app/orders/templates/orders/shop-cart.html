{% extends 'base.html' %}
{% load static %}
{% load cart_template_tags %}

{%block head%}
{{ block.super }}
<style>
    /* Masquer le preloader immédiatement pour cette page */
    #preloader-active {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
    
    /* S'assurer qu'il n'y a qu'un seul header */
    body > header.flavoriz-header:not(:first-of-type),
    body > .flavoriz-header:not(:first-of-type),
    .flavoriz-header ~ .flavoriz-header,
    header.flavoriz-header + header.flavoriz-header {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
    }
    
    /* S'assurer qu'il n'y a qu'un seul footer */
    body > footer.flavoriz-footer:not(:first-of-type),
    body > .flavoriz-footer:not(:first-of-type),
    .flavoriz-footer ~ .flavoriz-footer,
    footer.flavoriz-footer + footer.flavoriz-footer {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
    }
</style>
{%endblock head%}

{%block body%}
{% if order_details%}
<!-- ===== Modern Cart Page FLAVORIZ Design ===== -->
<main class="main pages shop-cart-page" style="padding-bottom: 100px; min-height: calc(100vh - 140px); background: linear-gradient(135deg, #FDF8F3 0%, #FFF9F5 100%);">
<style>
    /* Panier : espacement réduit sous le header (base.html gère déjà margin-top) */
    main.main.pages.shop-cart-page {
        padding-top: 24px !important;
    }
    
    @media (max-width: 768px) {
        main.main.pages.shop-cart-page {
            padding-top: 20px !important;
        }
    }
    
    /* Section Détails de livraison rétractable */
    .cart-delivery-card .cart-delivery-body {
        max-height: 1200px;
        opacity: 1;
        padding: 0 24px 24px 24px;
        box-sizing: border-box;
    }
    .cart-delivery-card.collapsed .cart-delivery-body {
        max-height: 0;
        opacity: 0;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
        overflow: hidden;
    }
    .cart-delivery-card .cart-delivery-chevron {
        transform: rotate(0deg);
    }
    .cart-delivery-card.collapsed .cart-delivery-chevron {
        transform: rotate(-90deg);
    }
    .cart-delivery-toggle:hover,
    .cart-delivery-toggle:focus {
        background: #F3F4F6 !important;
        outline: none;
    }
    .cart-delivery-toggle:focus-visible {
        box-shadow: 0 0 0 2px rgba(255, 123, 44, 0.4);
    }
</style>
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 24px;">
        <!-- Breadcrumb -->
        <nav style="margin-bottom: 20px; font-size: 13px; color: #6B7280; display: flex; align-items: center; gap: 6px;">
            <a href="{%url 'home:index'%}" style="color: var(--color-orange); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;">
                <i class="fi-rs-home"></i> <span>Accueil</span>
            </a>
            <span style="color: #9CA3AF;">/</span>
            <span style="color: #6B7280; font-weight: 500;">Panier</span>
        </nav>

        <!-- Page Header -->
        <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
                <h1 style="font-size: 32px; font-weight: 700; color: #1F2937; margin: 0 0 6px 0; font-family: var(--font-primary);">Votre panier</h1>
                <p style="font-size: 14px; color: #6B7280; margin: 0;">Il y a <strong style="color: var(--color-orange);">{{order_details.count}}</strong> article(s) dans votre panier</p>
            </div>
            <a href="{% url 'categories:shop' %}" style="display: inline-flex; align-items: center; gap: 8px; padding: 11px 24px; background: white; color: var(--color-orange); border: 2px solid var(--color-orange); border-radius: 10px; font-size: 14px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 123, 44, 0.15);">
                <i class="fi-rs-arrow-left"></i>
                <span>Continuer les achats</span>
            </a>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 400px; gap: 24px; align-items: start;">
            <!-- Cart Items -->
            <div>
                <!-- Cart Items Cards -->
                <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 20px;">
                    {% for item in order_details %}
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); display: flex; gap: 16px; transition: all 0.3s ease; border: 1px solid #F3F4F6;">
                        <!-- Product Image -->
                        <div style="flex-shrink: 0;">
                            {% if item.peer_product %}
                                <a href="{% url 'accounts:peer-product-details' item.peer_product.PRDSlug %}">
                                    <img src="{% if item.peer_product.product_image %}{{item.peer_product.product_image.url}}{% else %}{% static 'assets/imgs/shop/product-1-1.jpg'%}{% endif %}" alt="{{item.peer_product.product_name}}" loading="lazy" decoding="async" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid #F3F4F6;" />
                                </a>
                            {% else %}
                                <a href="{% url 'products:product-details' item.product.PRDSlug %}">
                                    <img src="{% if item.product.product_image %}{{item.product.product_image.url}}{% else %}{% static 'assets/imgs/shop/product-1-1.jpg'%}{% endif %}" alt="{{item.product.product_name}}" loading="lazy" decoding="async" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid #F3F4F6;" />
                                </a>
                            {% endif %}
                        </div>
                        
                        <!-- Product Details -->
                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between; min-width: 0;">
                            <div>
                                <h3 style="font-size: 16px; font-weight: 600; color: #1F2937; margin: 0 0 6px 0; line-height: 1.4;">
                                    {% if item.peer_product %}
                                        <a href="{% url 'accounts:peer-product-details' item.peer_product.PRDSlug %}" style="color: #1F2937; text-decoration: none; transition: color 0.2s ease;">{{item.peer_product.product_name}}</a>
                                    {% else %}
                                        <a href="{% url 'products:product-details' item.product.PRDSlug %}" style="color: #1F2937; text-decoration: none; transition: color 0.2s ease;">{{item.product.product_name}}</a>
                                    {% endif %}
                                </h3>
                                {% if item.product and item.product.feedbak_average > 0 %}
                                <div style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: #6B7280; margin-bottom: 8px;">
                                    <span style="color: #FBBF24;">★★★★★</span>
                                    <span style="margin-left: 4px;">({{item.product.feedbak_number}} avis)</span>
                                </div>
                                {% endif %}
                                <div style="display: flex; align-items: center; gap: 12px; font-size: 12px; color: #6B7280; margin-top: 4px; flex-wrap: wrap;">
                                    {% if item.weight > 0 %}
                                    <span style="display: flex; align-items: center; gap: 4px;"><i class="fi-rs-weight" style="font-size: 13px;"></i>{{item.weight}} KG</span>
                                    {% endif %}
                                    <span style="display: flex; align-items: center; gap: 4px;"><i class="fi-rs-shopping-cart" style="font-size: 13px;"></i>Qté: {{item.quantity}}</span>
                                </div>
                            </div>
                            
                            <!-- Price & Actions -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #F3F4F6;">
                                <div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--color-orange);">
                                        {{ item.price|multiply_and_format:item.quantity }} FCFA
                                    </div>
                                    <div style="font-size: 12px; color: #9CA3AF; margin-top: 2px;">
                                        {{item.price|format_price}} FCFA × {{item.quantity}}
                                    </div>
                                </div>
                                <a href="{% url 'orders:remove-item' productdeatails_id=item.id %}" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #FEE2E2; color: #DC2626; border-radius: 8px; text-decoration: none; transition: all 0.2s ease; cursor: pointer;" title="Retirer du panier">
                                    <i class="fi-rs-trash" style="font-size: 16px;"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                                        </div>

                <!-- Coupon Code Card -->
                <div style="background: linear-gradient(135deg, var(--color-orange) 0%, #E65A1F 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 16px rgba(255, 123, 44, 0.25);">
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <h4 style="font-size: 18px; font-weight: 700; color: white; margin: 0 0 4px 0; display: flex; align-items: center; gap: 8px;">
                                <i class="fi-rs-ticket" style="font-size: 20px;"></i> Code promo
                                {% if has_peer_products %}
                                <i class="fi-rs-lock" style="font-size: 14px; margin-left: 4px;" title="Code promo non disponible pour les articles d'occasion"></i>
                                {% endif %}
                            </h4>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin: 0;">
                                {% if has_peer_products %}
                                Le code promo n'est disponible que pour les articles des vendeurs professionnels
                                {% else %}
                                Entrez votre code pour bénéficier d'une réduction
                                {% endif %}
                            </p>
                </div>
                        <form method="post" style="display: flex; gap: 8px; flex: 1; max-width: 350px; min-width: 200px; {% if has_peer_products %}opacity: 0.6;{% endif %}">
                            {% csrf_token %}
                            <input name="code" type="text" placeholder="Code promo..." {% if has_peer_products %}disabled{% else %}required{% endif %} style="flex: 1; padding: 11px 14px; border: none; border-radius: 8px; font-size: 13px; outline: none; background: {% if has_peer_products %}#E5E7EB{% else %}white{% endif %}; font-family: var(--font-secondary); min-width: 0; {% if has_peer_products %}cursor: not-allowed;{% endif %};" />
                            <button type="submit" {% if has_peer_products %}disabled{% endif %} style="padding: 11px 20px; background: {% if has_peer_products %}#9CA3AF{% else %}#1F2937{% endif %}; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: {% if has_peer_products %}not-allowed{% else %}pointer{% endif %}; transition: all 0.2s ease; white-space: nowrap; font-family: var(--font-primary);">
                                Appliquer
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Delivery Form Card (section rétractable) -->
                <div class="cart-delivery-card" id="cart-delivery-card" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #F3F4F6; overflow: hidden;">
                    <button type="button" class="cart-delivery-toggle" id="cart-delivery-toggle" aria-expanded="true" aria-controls="cart-delivery-body" style="width: 100%; display: flex; align-items: center; gap: 14px; margin: 0; padding: 20px 24px; border: none; background: #FAFAFA; cursor: pointer; text-align: left; font-family: inherit; transition: background 0.2s ease;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, rgba(255, 123, 44, 0.15) 0%, rgba(255, 123, 44, 0.06) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fi-rs-package" style="font-size: 22px; color: var(--color-orange); display: block; line-height: 1;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-size: 18px; font-weight: 700; color: #1F2937; margin: 0;">Détails de livraison</h4>
                            <p class="cart-delivery-toggle-hint" style="font-size: 13px; color: #6B7280; margin: 4px 0 0 0;">Cliquez pour afficher ou masquer le formulaire</p>
                        </div>
                        <span class="cart-delivery-toggle-label" style="font-size: 13px; font-weight: 600; color: var(--color-orange); flex-shrink: 0;">Masquer</span>
                        <i class="fi-rs-angle-small-down cart-delivery-chevron" style="font-size: 22px; color: var(--color-orange); transition: transform 0.3s ease; flex-shrink: 0;"></i>
                    </button>
                    <form method="post" action="{% url 'orders:payment' %}" id="cart-delivery-form">
                        {% csrf_token %}
                        <div class="cart-delivery-body" id="cart-delivery-body" style="overflow: hidden; transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; padding-top: 20px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Prénom *</label>
                                <input type="text" required name="first_name" value="{% if profile %}{{ profile.user.first_name }}{% endif %}" placeholder="Votre prénom" class="flavoriz-input" style="width: 100%; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary); background: #FAFAFA;" />
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Nom *</label>
                                <input type="text" required name="last_name" value="{% if profile %}{{ profile.user.last_name }}{% endif %}" placeholder="Votre nom" class="flavoriz-input" style="width: 100%; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary); background: #FAFAFA;" />
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Pays *</label>
                                <input type="text" id="country" name="country" value="Gabon" readonly class="flavoriz-input" style="width: 100%; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; background: #F9FAFB; transition: all 0.2s ease; font-family: var(--font-secondary); cursor: not-allowed; color: #6B7280;" />
                                <input type="hidden" name="country" value="GA" />
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Province *</label>
                                <select id="province" name="province" required class="flavoriz-input flavoriz-select" style="width: 100%; padding: 12px 14px; padding-right: 40px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; background: #FAFAFA; transition: all 0.2s ease; font-family: var(--font-secondary); cursor: pointer; appearance: none; -webkit-appearance: none; -moz-appearance: none; min-height: 44px; box-sizing: border-box; line-height: 1.5; color: #1F2937;">
                                    <option value="">Sélectionnez une province</option>
                                    <option value="Estuaire" {% if profile and profile.state == "Estuaire" %}selected{% endif %}>Estuaire</option>
                                    <option value="Haut-Ogooué" {% if profile and profile.state == "Haut-Ogooué" %}selected{% endif %}>Haut-Ogooué</option>
                                    <option value="Moyen-Ogooué" {% if profile and profile.state == "Moyen-Ogooué" %}selected{% endif %}>Moyen-Ogooué</option>
                                    <option value="Ngounié" {% if profile and profile.state == "Ngounié" %}selected{% endif %}>Ngounié</option>
                                    <option value="Nyanga" {% if profile and profile.state == "Nyanga" %}selected{% endif %}>Nyanga</option>
                                    <option value="Ogooué-Ivindo" {% if profile and profile.state == "Ogooué-Ivindo" %}selected{% endif %}>Ogooué-Ivindo</option>
                                    <option value="Ogooué-Lolo" {% if profile and profile.state == "Ogooué-Lolo" %}selected{% endif %}>Ogooué-Lolo</option>
                                    <option value="Ogooué-Maritime" {% if profile and profile.state == "Ogooué-Maritime" %}selected{% endif %}>Ogooué-Maritime</option>
                                    <option value="Woleu-Ntem" {% if profile and profile.state == "Woleu-Ntem" %}selected{% endif %}>Woleu-Ntem</option>
                                    </select>
                                </div>
                            </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Ville *</label>
                                <input type="text" id="city" name="state" required placeholder="Votre ville" class="flavoriz-input" style="width: 100%; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary); background: #FAFAFA;" value="{% if profile %}{{ profile.city }}{% endif %}" />
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Quartier *</label>
                                <input required type="text" name="city" value="{% if profile %}{{ profile.post_code }}{% endif %}" placeholder="Votre quartier" class="flavoriz-input" style="width: 100%; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary); background: #FAFAFA;" />
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Adresse *</label>
                                <input type="text" name="street" required value="{% if profile %}{{ profile.address }}{% endif %}" placeholder="Adresse complète" class="flavoriz-input" style="width: 100%; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary); background: #FAFAFA;" />
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Téléphone *</label>
                                <input required type="text" name="phone" value="{% if profile %}{{ profile.mobile_number }}{% endif %}" placeholder="Votre téléphone" class="flavoriz-input" style="width: 100%; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary); background: #FAFAFA;" />
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Email</label>
                                <input type="email" name="email_address" value="{% if profile %}{{ profile.user.email }}{% endif %}" placeholder="Votre email" class="flavoriz-input" style="width: 100%; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary); background: #FAFAFA;" />
                        </div>
                                </div>
                        </div>
                        <!-- Bouton toujours visible (hors zone rétractable) -->
                        <button type="submit" style="width: 100%; padding: 14px; margin-top: 20px; background: var(--color-orange); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px; font-family: var(--font-primary);">
                            <span>Procéder au paiement</span>
                            <i class="fi-rs-arrow-right"></i>
                        </button>
                    </form>
                            </div>
                        </div>

            <!-- Cart Summary -->
            <div style="position: sticky; top: 100px; height: fit-content;">
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); border: 1px solid #F3F4F6;">
                    <h3 style="font-size: 20px; font-weight: 700; color: #1F2937; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <i class="fi-rs-receipt" style="color: var(--color-orange); font-size: 22px;"></i>
                        <span>Résumé de la commande</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="font-size: 14px; color: #6B7280;">Sous-total</span>
                            <strong style="font-size: 16px; color: var(--color-orange); font-weight: 700;">{{f_total|format_price}} FCFA</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="font-size: 14px; color: #6B7280;">Articles</span>
                            <strong style="font-size: 15px; color: #1F2937; font-weight: 600;">{{order_details.count}}</strong>
                        </div>
                        <div style="height: 1px; background: #E5E7EB; margin: 4px 0;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="font-size: 14px; color: #6B7280;">Livraison</span>
                            <span style="font-size: 13px; color: #9CA3AF;">Calculé à l'étape suivante</span>
                            </div>
                        {% if coupon_id %}
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="font-size: 14px; color: #6B7280;">Code promo</span>
                            <span style="font-size: 14px; color: #1F2937; font-weight: 600;">{{code}} <span style="color: #10b981; font-weight: 700;">-{{value|format_price}} FCFA</span></span>
                            </div>
                        <div style="height: 1px; background: #E5E7EB; margin: 4px 0;"></div>
                        {% endif %}
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; margin-top: 4px; border-top: 2px solid #F3F4F6;">
                            <span style="font-size: 18px; font-weight: 700; color: #1F2937;">Total</span>
                            <strong style="font-size: 24px; color: var(--color-orange); font-weight: 700;">{{total|format_price}} FCFA</strong>
                            </div>
                        </div>
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(255, 123, 44, 0.08) 0%, rgba(255, 123, 44, 0.04) 100%); border-radius: 10px; border: 1px solid rgba(255, 123, 44, 0.2);">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <i class="fi-rs-shield-check" style="font-size: 18px; color: var(--color-orange); margin-top: 2px;"></i>
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: #1F2937; margin-bottom: 4px;">Paiement sécurisé</div>
                                <div style="font-size: 12px; color: #6B7280; line-height: 1.4;">Vos informations sont protégées par un chiffrement SSL</div>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% else %}
{% include "orders/cart-empty.html" %}
{% endif %}
{%endblock body%}

{%block script%}
{{ block.super }}
<script>
    // Masquer le preloader immédiatement - doit être exécuté avant tout autre script
    (function() {
        function hidePreloader() {
            const preloader = document.getElementById('preloader-active');
            if (preloader) {
                preloader.style.display = 'none';
                preloader.style.opacity = '0';
                preloader.style.visibility = 'hidden';
                preloader.style.transition = 'opacity 0.3s ease';
            }
        }
        
        // Supprimer les doublons de header
        function removeDuplicateHeaders() {
            const headers = document.querySelectorAll('header.flavoriz-header');
            if (headers.length > 1) {
                // Garder seulement le premier header, supprimer les autres
                for (let i = 1; i < headers.length; i++) {
                    headers[i].remove();
                }
            }
        }
        
        // Supprimer les doublons de footer
        function removeDuplicateFooters() {
            const footers = document.querySelectorAll('footer.flavoriz-footer');
            if (footers.length > 1) {
                // Garder seulement le premier footer, supprimer les autres
                for (let i = 1; i < footers.length; i++) {
                    footers[i].remove();
                }
            }
        }
        
        // Essayer immédiatement
        hidePreloader();
        removeDuplicateHeaders();
        removeDuplicateFooters();
        
        // Essayer après DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                hidePreloader();
                removeDuplicateHeaders();
                removeDuplicateFooters();
            });
        } else {
            hidePreloader();
            removeDuplicateHeaders();
            removeDuplicateFooters();
        }
        
        // Fallback avec window.onload
        window.addEventListener('load', function() {
            setTimeout(function() {
                hidePreloader();
                removeDuplicateHeaders();
                removeDuplicateFooters();
            }, 100);
        });
    })();
    </script>
<script>
    (function() {
        var toggle = document.getElementById('cart-delivery-toggle');
        var card = document.getElementById('cart-delivery-card');
        var body = document.getElementById('cart-delivery-body');
        var form = document.getElementById('cart-delivery-form');
        var labelEl = card && card.querySelector('.cart-delivery-toggle-label');
        var hintEl = card && card.querySelector('.cart-delivery-toggle-hint');
        var key = 'cart-delivery-collapsed';
        function setLabelAndHint(collapsed) {
            if (labelEl) labelEl.textContent = collapsed ? 'Afficher' : 'Masquer';
            if (hintEl) hintEl.textContent = collapsed ? 'Cliquez pour afficher le formulaire de livraison' : 'Cliquez pour afficher ou masquer le formulaire';
        }
        function expandSection() {
            if (card && card.classList.contains('collapsed')) {
                card.classList.remove('collapsed');
                if (toggle) toggle.setAttribute('aria-expanded', 'true');
                sessionStorage.setItem(key, '0');
                setLabelAndHint(false);
            }
        }
        if (toggle && card && body) {
            var collapsed = sessionStorage.getItem(key) === '1';
            if (window.location.search.indexOf('expand_delivery=1') !== -1) collapsed = false;
            if (collapsed) {
                card.classList.add('collapsed');
                toggle.setAttribute('aria-expanded', 'false');
                setLabelAndHint(true);
            } else {
                setLabelAndHint(false);
            }
            toggle.addEventListener('click', function() {
                collapsed = card.classList.toggle('collapsed');
                toggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
                sessionStorage.setItem(key, collapsed ? '1' : '0');
                setLabelAndHint(collapsed);
            });
        }
        if (form && card) {
            form.addEventListener('submit', function(e) {
                var deliveryBody = document.getElementById('cart-delivery-body');
                if (!deliveryBody) return;
                if (!form.checkValidity()) {
                    e.preventDefault();
                    expandSection();
                    form.reportValidity();
                    var firstInvalid = deliveryBody.querySelector('input:invalid, select:invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                        setTimeout(function() { firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
                    }
                }
            });
        }
    })();
</script>
<script>
    /**
     * ============================================================================
     * GESTION PROVINCE/VILLE - MAPPING ET MISE À JOUR AUTOMATIQUE
     * ============================================================================
     * 
     * Ce script gère la relation entre les provinces du Gabon et leurs villes
     * principales. Lorsqu'une province est sélectionnée, la ville correspondante
     * est automatiquement remplie dans le champ "Ville".
     * 
     * Fonctionnalités :
     * - Mapping des 9 provinces du Gabon vers leurs villes principales
     * - Mise à jour automatique du champ ville lors du changement de province
     * - Support de Select2 (si disponible) et du select natif (fallback)
     * - Initialisation de la ville au chargement si une province est déjà sélectionnée
     */
    
    /**
     * Mapping des provinces du Gabon vers leurs villes principales
     * 
     * Structure : { 'Nom de la province': 'Ville principale' }
     * 
     * Note: Ce mapping doit être synchronisé avec celui dans account-details.html
     * pour maintenir la cohérence dans toute l'application.
     */
    const provinceCities = {
        'Estuaire': 'Libreville',
        'Haut-Ogooué': 'Franceville',
        'Moyen-Ogooué': 'Lambaréné',
        'Ngounié': 'Mouila',
        'Nyanga': 'Tchibanga',
        'Ogooué-Ivindo': 'Makokou',
        'Ogooué-Lolo': 'Koulamoutou',
        'Ogooué-Maritime': 'Port-Gentil',
        'Woleu-Ntem': 'Oyem'
    };
    
    // Récupération des éléments DOM pour la province et la ville
    const provinceSelect = document.getElementById('province');
    const cityInput = document.getElementById('city');
    
    /**
     * Met à jour le champ ville en fonction de la province sélectionnée
     * 
     * @param {string} selectedProvince - Le nom de la province sélectionnée (trimé)
     * 
     * Comportement :
     * - Si une province valide est sélectionnée : remplit automatiquement la ville
     *   avec une animation de transition (opacité)
     * - Si aucune province n'est sélectionnée : vide le champ ville
     * 
     * Note: L'utilisateur peut toujours modifier manuellement la ville après
     * l'auto-remplissage.
     */
    function updateCityFromProvince(selectedProvince) {
        // Cas 1 : Province valide sélectionnée -> remplir la ville avec animation
        if (cityInput && selectedProvince && provinceCities[selectedProvince]) {
            // Animation de transition pour un feedback visuel
            cityInput.style.transition = 'all 0.3s ease';
            cityInput.style.opacity = '0.7';
            
            // Mise à jour de la valeur après un court délai pour l'effet visuel
            setTimeout(() => {
                cityInput.value = provinceCities[selectedProvince];
                cityInput.style.opacity = '1';
            }, 150);
        } 
        // Cas 2 : Aucune province sélectionnée -> vider le champ ville
        else if (cityInput && !selectedProvince) {
            cityInput.value = '';
        }
    }
    
    /**
     * Initialisation des event listeners pour le select natif (fallback)
     * 
     * Cette partie s'exécute même si Select2 n'est pas disponible, garantissant
     * que la fonctionnalité fonctionne dans tous les cas.
     */
    if (provinceSelect && cityInput) {
        // Écouteur d'événement pour le changement de province (select natif)
        provinceSelect.addEventListener('change', function() {
            updateCityFromProvince(this.value.trim());
        });
        
        // Initialisation au chargement : remplir la ville si une province est déjà sélectionnée
        // (utile lors du rechargement de la page avec des données pré-remplies)
        if (provinceSelect.value && provinceCities[provinceSelect.value.trim()]) {
            cityInput.value = provinceCities[provinceSelect.value.trim()];
        }
    }

    /**
     * ============================================================================
     * INITIALISATION AU CHARGEMENT DU DOM
     * ============================================================================
     * 
     * Cette section s'exécute lorsque le DOM est complètement chargé.
     * Elle gère :
     * - Les styles de focus pour tous les champs du formulaire
     * - L'initialisation de Select2 pour améliorer l'apparence du select Province
     * - La synchronisation Province/Ville avec Select2
     */
    document.addEventListener('DOMContentLoaded', function() {
        /**
         * Gestion des styles de focus pour tous les champs du formulaire
         * 
         * Applique un style cohérent (bordure orange, ombre, fond blanc) lors
         * du focus sur les champs de formulaire avec la classe 'flavoriz-input'.
         */
        const inputs = document.querySelectorAll('.flavoriz-input');
        inputs.forEach(input => {
            // Ignorer les champs en lecture seule (comme le champ Pays)
            if (input.readOnly) {
                return;
            }
            
            // Style au focus : bordure orange, ombre, fond blanc
            input.addEventListener('focus', function() {
                this.style.borderColor = 'var(--color-orange)';
                this.style.boxShadow = '0 0 0 3px rgba(255, 123, 44, 0.1)';
                this.style.background = 'white';
            });
            
            // Style au blur : retour aux styles par défaut
            input.addEventListener('blur', function() {
                this.style.borderColor = '#E5E7EB';
                this.style.boxShadow = 'none';
                // Conserver le fond gris pour les champs éditables
                if (!this.readOnly) {
                    this.style.background = '#FAFAFA';
                }
            });
        });
        
        /**
         * Initialisation de Select2 pour le select Province
         * 
         * Select2 améliore l'apparence et l'expérience utilisateur de la liste
         * déroulante avec :
         * - Un design moderne et cohérent avec le reste de l'application
         * - Des options stylisées avec hover et sélection visibles
         * - Une meilleure compatibilité cross-browser
         * 
         * Configuration :
         * - dropdownParent : assure que le dropdown s'affiche correctement dans le conteneur
         * - minimumResultsForSearch: Infinity : désactive la recherche (pas nécessaire pour 9 options)
         * - allowClear: false : empêche la suppression de la sélection (champ requis)
         */
        if (typeof jQuery !== 'undefined' && jQuery.fn.select2 && provinceSelect) {
            jQuery(provinceSelect).select2({
                dropdownParent: jQuery(provinceSelect).parent(), // Conteneur parent pour le dropdown
                minimumResultsForSearch: Infinity, // Désactiver la recherche (9 options seulement)
                placeholder: 'Sélectionnez une province',
                allowClear: false, // Champ requis, pas de suppression possible
                width: '100%' // Largeur complète du conteneur
            });
            
            /**
             * Écouteur d'événement Select2 pour la mise à jour de la ville
             * 
             * Select2 utilise ses propres événements, donc on doit écouter
             * 'select2:select' au lieu de 'change' natif.
             */
            jQuery(provinceSelect).on('select2:select', function(e) {
                const selectedProvince = e.params.data.id; // Récupérer la valeur sélectionnée
                updateCityFromProvince(selectedProvince);
            });
        }
        
        /**
         * Initialisation de la ville au chargement (double vérification)
         * 
         * Cette vérification supplémentaire s'assure que la ville est correctement
         * initialisée même si Select2 modifie le comportement du select.
         */
        if (provinceSelect && cityInput && provinceSelect.value && provinceCities[provinceSelect.value]) {
            cityInput.value = provinceCities[provinceSelect.value];
        }
    });
</script>
<style>
/**
 * ============================================================================
 * STYLES POUR LE SELECT PROVINCE - UNIFORMISATION AVEC LES AUTRES CHAMPS
 * ============================================================================
 * 
 * Ces styles garantissent que le select Province a exactement la même apparence
 * que les autres champs du formulaire (inputs text, etc.).
 * 
 * Objectifs :
 * - Hauteur identique : 44px (identique aux autres inputs)
 * - Padding identique : 12px 14px (avec padding-right: 40px pour la flèche)
 * - Bordures, border-radius et couleurs cohérentes
 * - Flèche SVG personnalisée pour remplacer la flèche native du navigateur
 * - États hover et focus cohérents avec le reste du formulaire
 */

/* ============================================================================
   STYLES DE BASE DU SELECT PROVINCE
   ============================================================================ */

select.flavoriz-input,
select.flavoriz-select {
    /* Suppression de l'apparence native du navigateur pour un contrôle total */
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    
    /* Dimensions : identiques aux autres champs du formulaire */
    width: 100% !important;
    height: 44px !important;
    min-height: 44px !important;
    max-height: 44px !important;
    
    /* Padding : identique aux autres inputs (12px 14px) + espace pour la flèche */
    padding: 12px 14px !important;
    padding-right: 40px !important; /* Espace pour la flèche SVG */
    
    /* Bordures et coins arrondis : cohérents avec le design Flavoriz */
    border: 2px solid #E5E7EB !important;
    border-radius: 10px !important;
    
    /* Typographie : identique aux autres champs */
    font-size: 13px !important;
    font-family: var(--font-secondary) !important;
    font-weight: 400 !important;
    line-height: 1.5 !important;
    color: #1F2937 !important;
    
    /* Fond et flèche SVG personnalisée */
    background: #FAFAFA !important;
    /* Flèche SVG en gris (#6B7280) positionnée à droite */
    background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236B7280"><path d="M7 10l5 5 5-5z"/></svg>') !important;
    background-repeat: no-repeat !important;
    background-position: right 12px center !important;
    background-size: 20px !important;
    
    /* Comportement et transitions */
    outline: none !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    box-sizing: border-box !important;
    display: block !important;
    margin: 0 !important;
    vertical-align: middle !important;
}

/* ============================================================================
   ÉTAT FOCUS DU SELECT
   ============================================================================ */

select.flavoriz-input:focus,
select.flavoriz-select:focus {
    /* Bordure orange et ombre lors du focus (cohérent avec les autres champs) */
    border-color: var(--color-orange) !important;
    box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1) !important;
    background-color: white !important;
    /* Flèche SVG en orange lors du focus */
    background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FF7B2C"><path d="M7 10l5 5 5-5z"/></svg>') !important;
}

/* ============================================================================
   ÉTAT HOVER DU SELECT (uniquement si pas en focus)
   ============================================================================ */

select.flavoriz-input:hover:not(:focus),
select.flavoriz-select:hover:not(:focus) {
    border-color: #D1D5DB !important;
    background-color: #F9FAFB !important;
}

/* ============================================================================
   STYLES POUR LES OPTIONS DE LA LISTE DÉROULANTE (SELECT NATIF)
   ============================================================================
   
   Note: Ces styles s'appliquent uniquement au select natif du navigateur.
   Si Select2 est utilisé, les styles Select2 ci-dessous prennent le relais.
   */

select.flavoriz-input option,
select.flavoriz-select option {
    padding: 14px 16px !important;
    font-size: 13px !important;
    color: #1F2937 !important;
    background: white !important;
    font-family: var(--font-secondary) !important;
    line-height: 1.6 !important;
    min-height: 48px !important;
    font-weight: 400 !important;
    cursor: pointer !important;
}

/* Option placeholder (première option) : style gris et italique */
select.flavoriz-input option:first-child,
select.flavoriz-select option:first-child {
    color: #9CA3AF !important;
    font-style: italic !important;
    font-weight: 400 !important;
}

/* Option sélectionnée ou survolée : fond dégradé orange */
select.flavoriz-input option:checked,
select.flavoriz-select option:checked,
select.flavoriz-input option:hover,
select.flavoriz-select option:hover {
    background: linear-gradient(135deg, rgba(255, 123, 44, 0.12) 0%, rgba(255, 123, 44, 0.08) 100%) !important;
    color: var(--color-orange) !important;
    font-weight: 600 !important;
}

/* ============================================================================
   STYLES POUR SELECT2 (si Select2 est initialisé)
   ============================================================================
   
   Ces styles s'appliquent uniquement si Select2 est utilisé pour améliorer
   l'apparence du select. Ils garantissent que Select2 respecte le design
   Flavoriz et a la même apparence que le select natif stylé.
   */

/* Position relative pour le conteneur du select Province */
#province.flavoriz-select {
    position: relative !important;
}

/* ============================================================================
   SELECT2 : STYLES DU CHAMP DE SÉLECTION
   ============================================================================ */

/* Conteneur principal du select Select2 */
.select2-container--default .select2-selection--single {
    height: 44px !important; /* Identique aux autres champs */
    border: 2px solid #E5E7EB !important;
    border-radius: 10px !important;
    background: #FAFAFA !important;
    padding: 0 !important;
}

/* Texte affiché dans le select Select2 */
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 44px !important; /* Centrage vertical */
    padding-left: 14px !important; /* Identique aux autres champs */
    padding-right: 40px !important; /* Espace pour la flèche */
    font-size: 13px !important;
    color: #1F2937 !important;
    font-family: var(--font-secondary) !important;
}

/* Flèche du select Select2 */
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 42px !important;
    right: 12px !important;
    top: 1px !important;
}

/* Style de la flèche Select2 (triangle) */
.select2-container--default .select2-selection--single .select2-selection__arrow b {
    border-color: #6B7280 transparent transparent transparent !important;
    border-width: 6px 5px 0 5px !important;
    margin-top: -3px !important;
}

/* ============================================================================
   SELECT2 : ÉTATS FOCUS ET OUVERT
   ============================================================================ */

.select2-container--default.select2-container--focus .select2-selection--single,
.select2-container--default.select2-container--open .select2-selection--single {
    border-color: var(--color-orange) !important;
    box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1) !important;
    background-color: white !important;
}

/* Flèche orange lors du focus/ouverture */
.select2-container--default.select2-container--focus .select2-selection--single .select2-selection__arrow b,
.select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
    border-color: var(--color-orange) transparent transparent transparent !important;
}

/* ============================================================================
   SELECT2 : STYLES DU DROPDOWN (LISTE DÉROULANTE)
   ============================================================================ */

/* Conteneur du dropdown Select2 */
.select2-dropdown {
    border: 2px solid #E5E7EB !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important; /* Ombre moderne */
    margin-top: 4px !important;
    overflow: hidden !important;
}

/* Conteneur des options avec scroll si nécessaire */
.select2-container--default .select2-results > .select2-results__options {
    max-height: 300px !important;
    padding: 4px 0 !important;
}

/* Style de chaque option dans le dropdown */
.select2-container--default .select2-results__option {
    padding: 14px 16px !important;
    font-size: 13px !important;
    color: #1F2937 !important;
    font-family: var(--font-secondary) !important;
    line-height: 1.6 !important;
    min-height: 48px !important;
    display: flex !important;
    align-items: center !important;
    transition: all 0.2s ease !important;
}

/* Option désactivée (placeholder) : gris et italique */
.select2-container--default .select2-results__option[aria-disabled="true"] {
    color: #9CA3AF !important;
    font-style: italic !important;
}

/* Option survolée ou sélectionnée : fond dégradé orange */
.select2-container--default .select2-results__option--highlighted[aria-selected],
.select2-container--default .select2-results__option[aria-selected="true"] {
    background: linear-gradient(135deg, rgba(255, 123, 44, 0.12) 0%, rgba(255, 123, 44, 0.08) 100%) !important;
    color: var(--color-orange) !important;
    font-weight: 600 !important;
}

/* Option actuellement sélectionnée : fond plus foncé */
.select2-container--default .select2-results__option[aria-selected="true"] {
    background: linear-gradient(135deg, rgba(255, 123, 44, 0.15) 0%, rgba(255, 123, 44, 0.1) 100%) !important;
}

@media (max-width: 1023px) {
    .main.pages > div > div[style*="grid-template-columns: 1fr 400px"] {
        grid-template-columns: 1fr !important;
    }
    
    div[style*="position: sticky"] {
        position: static !important;
    }
}

@media (max-width: 768px) {
    .main.pages.shop-cart-page {
        padding-top: 20px !important;
        padding-bottom: 60px !important;
    }
    
    .container {
        padding: 0 16px !important;
    }
    
    h1 {
        font-size: 24px !important;
    }
    
    div[style*="display: grid"][style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    div[style*="grid-template-columns: 1fr 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}
</style>
{%endblock script%}
