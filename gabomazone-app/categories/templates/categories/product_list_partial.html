{% load static %}
{% load cart_template_tags %}
{% load category_icons %}

<!-- Mise à jour du compteur (page Produits ou page vendeur) -->
{% if vendor_id %}
<span id="items-number" hx-swap-oob="true">{{ total_products }} produit{{ total_products|pluralize }}</span>
{% else %}
<div id="total-products-count" hx-swap-oob="true">{{ total_products }}</div>
{% endif %}

{% if not products_data %}
<p style="text-align: center; padding: 40px 24px; color: #6B7280; font-size: 15px; margin: 0;">Aucun produit trouvé</p>
{% else %}
{% for item in products_data %}
    {% with product=item.product product_images=item.product_images like_count=item.like_count is_peer_to_peer=item.is_peer_to_peer|default:False is_boosted=item.is_boosted|default:False %}
        {% with price=product.PRDPrice discount_price=product.PRDDiscountPrice %}
            <div class="flavoriz-product-card" style="cursor: pointer; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #F3F4F6; display: flex; flex-direction: column; height: 100%;">
                <div class="flavoriz-product-image-wrap" style="position: relative; overflow: hidden; background: linear-gradient(135deg, #FDF8F3 0%, #FFE5D4 100%); width: 100%; aspect-ratio: 1;">
                    <img src="/media/{{ product.product_image }}" alt="{{ product.product_name }}" class="flavoriz-product-image" data-images='{{ product_images|safe }}' loading="lazy" decoding="async" onclick="event.stopPropagation(); openImagePreview(JSON.parse(this.getAttribute('data-images')), 0, '{{ product.product_name|escapejs }}');" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.35s ease; cursor: zoom-in;" />
                    <button class="flavoriz-favorite-btn" data-product-id="{% if product.is_peer_to_peer %}peer_{{ product.id }}{% else %}{{ product.id }}{% endif %}" type="button" style="position: absolute; top: 8px; right: 8px; background: rgba(255, 255, 255, 0.95); border: none; border-radius: 16px; padding: 6px 10px; display: flex; align-items: center; gap: 4px; font-size: 10px; color: #6B7280; font-weight: 600; backdrop-filter: blur(4px); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease; z-index: 10;">
                        <i class="fi-rs-heart" style="font-size: 12px; transition: all 0.3s ease;"></i>
                        <span class="favorite-count">{{ like_count }}</span>
                    </button>
                    {% if product.is_peer_to_peer and product.condition %}
                    <div style="position: absolute; top: 8px; left: 8px; z-index: 10;">
                        <span class="peer-condition-badge peer-condition-badge-card peer-condition-{{ product.condition|condition_slug }}">{{ product.condition_display|default:product.condition }}</span>
                    </div>
                    {% elif is_boosted %}
                    <div style="position: absolute; top: 8px; left: 8px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #1F2937; padding: 6px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 8px rgba(255, 165, 0, 0.4); z-index: 10; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fi-rs-rocket" style="font-size: 12px;"></i>
                        <span>Boosté</span>
                    </div>
                    {% endif %}
                    {% if product.view_count and product.view_count > 0 %}
                    <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0, 0, 0, 0.6); color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px; backdrop-filter: blur(4px); z-index: 10;">
                        <i class="fi-rs-eye" style="font-size: 11px;"></i>
                        <span>{{ product.view_count|default:0 }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="flavoriz-product-body" style="padding: 16px; flex: 1; display: flex; flex-direction: column;">
                    {% if product.is_peer_to_peer %}
                        <h3 class="flavoriz-product-title" onclick="window.location.href='{% url 'accounts:peer-product-details' product.PRDSlug %}'" style="font-size: 13px; font-weight: 600; color: #1F2937; margin: 0 0 6px 0; line-height: 1.35; min-height: 36px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex-shrink: 0; cursor: pointer;">{{ product.product_name }}</h3>
                    {% else %}
                        <h3 class="flavoriz-product-title" onclick="window.location.href='{% url 'products:product-details' product.PRDSlug %}'" style="font-size: 13px; font-weight: 600; color: #1F2937; margin: 0 0 6px 0; line-height: 1.35; min-height: 36px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex-shrink: 0; cursor: pointer;">{{ product.product_name }}</h3>
                    {% endif %}
                    <div style="display: flex; align-items: baseline; gap: 6px; flex-wrap: wrap; flex-shrink: 0;">
                        <span class="flavoriz-product-price" style="font-size: 16px; font-weight: 700; color: var(--color-orange);">{{ price|format_price }} FCFA</span>
                        {% if discount_price and discount_price > 0 %}
                            <span style="font-size: 13px; color: #9CA3AF; text-decoration: line-through;">{{ discount_price|format_price }} FCFA</span>
                        {% endif %}
                    </div>
                    <div class="flavoriz-card-meta" style="display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 11px; color: #9CA3AF; font-weight: normal; margin-bottom: 4px; line-height: 1.3;">
                        <span style="min-width: 0; display: flex; align-items: center; gap: 3px;">
                            {% if product.is_peer_to_peer and product.seller_city %}
                            <i class="fi-rs-marker" style="font-size: 10px; flex-shrink: 0;"></i><span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ product.seller_city }}</span>
                            {% elif product.product_vendor %}
                            {% if product.product_vendor.city or product.product_vendor.country %}
                            <i class="fi-rs-marker" style="font-size: 10px; flex-shrink: 0;"></i><span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{% if product.product_vendor.city %}{{ product.product_vendor.city }}{% if product.product_vendor.country %}, {% endif %}{% endif %}{% if product.product_vendor.country %}{{ product.product_vendor.country }}{% endif %}</span>
                            {% else %}
                            <span></span>
                            {% endif %}
                            {% else %}
                            <span></span>
                            {% endif %}
                        </span>
                        {% if product.date %}<span style="flex-shrink: 0; color: #9CA3AF;">{{ product.date|relative_date }}</span>{% endif %}
                    </div>
                    <div style="display: flex; gap: 6px; margin-top: auto;">
                        <button class="flavoriz-product-card-btn" onclick="event.stopPropagation(); window.location.href='{% if product.is_peer_to_peer %}{% url 'accounts:peer-product-details' product.PRDSlug %}{% else %}{% url 'products:product-details' product.PRDSlug %}{% endif %}'" style="flex: 1; padding: 7px 12px; background: #1F2937; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">
                            <i class="fi-rs-eye" style="font-size: 13px;"></i>
                            <span>Voir</span>
                        </button>
                        {% if product.is_peer_to_peer %}
                        <button class="flavoriz-propose-offer-btn" data-product-id="{{ product.id }}" data-product-slug="{{ product.PRDSlug }}" data-product-price="{{ price|floatformat:0 }}" onclick="event.stopPropagation(); proposeOfferToSeller({{ product.id }}, '{{ product.PRDSlug }}', {{ price|floatformat:0 }});" type="button" title="Négocier le prix" style="padding: 7px 12px; background: white; color: #1F2937; border: 1px solid #1F2937; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); min-width: 48px;">
                            <i class="fi-rs-comment" style="font-size: 15px;"></i>
                        </button>
                        {% else %}
                        <button class="flavoriz-add-cart-btn" data-product-id="{{ product.id }}" data-product-price="{{ price|floatformat:0 }}" type="button" style="padding: 7px 12px; background: white; color: #1F2937; border: 1px solid #1F2937; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); min-width: 48px;">
                            <i class="fi-rs-shopping-bag" style="font-size: 15px;"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endwith %}
    {% endwith %}
{% endfor %}

{% if has_next %}
    <!-- Sentinel pour le scroll infini HTMX (lazy load au scroll) -->
    <div 
        hx-get="{% if vendor_id %}{% url 'suppliers:vendor-products-htmx' %}?page={{ next_page }}&order_by={{ order_by }}&vendor_id={{ vendor_id }}{% else %}{% url 'categories:shop-htmx' %}?page={{ next_page }}&order_by={{ order_by }}&cat_type={{ cat_type }}&cat_id={{ cat_id }}&product_type={{ request.GET.product_type|default:'all' }}{% endif %}"
        hx-trigger="revealed"
        hx-swap="beforeend"
        hx-target="#products-list"
        hx-indicator="#loading-indicator"
        style="height: 1px; margin: 0; padding: 0; visibility: hidden;"
    ></div>
    
    {% if vendor_id %}<span id="items-number" hx-swap-oob="true">{{ total_products }} produit{{ total_products|pluralize }}</span>{% else %}<div id="total-products-count" hx-swap-oob="true">{{ total_products }}</div>{% endif %}
    
    <!-- Bouton de secours "Charger plus" -->
    <div style="text-align: center; padding: 24px; grid-column: 1 / -1;">
        <button 
            hx-get="{% if vendor_id %}{% url 'suppliers:vendor-products-htmx' %}?page={{ next_page }}&order_by={{ order_by }}&vendor_id={{ vendor_id }}{% else %}{% url 'categories:shop-htmx' %}?page={{ next_page }}&order_by={{ order_by }}&cat_type={{ cat_type }}&cat_id={{ cat_id }}&product_type={{ request.GET.product_type|default:'all' }}{% endif %}"
            hx-target="#products-list"
            hx-swap="beforeend"
            hx-indicator="#loading-indicator"
            type="button"
            style="padding: 14px 32px; background: var(--color-orange); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3); display: inline-flex; align-items: center; gap: 8px;"
        >
            <i class="fi-rs-arrow-down"></i>
            <span>Charger plus</span>
        </button>
    </div>
{% else %}
    <!-- Fin de la liste -->
    <div style="text-align: center; padding: 24px; grid-column: 1 / -1; color: #6B7280; font-size: 14px;">
        <p style="margin: 0;">Tous les produits ont été chargés</p>
    </div>
    
    {% if vendor_id %}<span id="items-number" hx-swap-oob="true">{{ total_products }} produit{{ total_products|pluralize }}</span>{% else %}<div id="total-products-count" hx-swap-oob="true">{{ total_products }}</div>{% endif %}
{% endif %}
{% endif %}

<script>
    // Fonction pour proposer une offre au vendeur (articles peer-to-peer)
    function proposeOfferToSeller(productId, productSlug, productPrice) {
        {% if not user.is_authenticated %}
        // Rediriger vers la page de connexion
        window.location.href = '{% url "accounts:login" %}?next=' + encodeURIComponent(window.location.pathname);
        return;
        {% endif %}
        
        // Rediriger vers la création d'intention d'achat C2C
        const createIntentUrl = '{% url "c2c:create-purchase-intent" 0 %}'.replace('0', productId);
        window.location.href = createIntentUrl;
    }
    
    // Réinitialiser les event listeners après chaque chargement HTMX
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'products-list') {
            if (typeof window.attachProductEventListeners === 'function') {
                window.attachProductEventListeners();
            } else {
                console.warn('attachProductEventListeners non disponible après htmx:afterSwap');
            }
        }
    });
    
    // Appeler une fois au chargement initial si HTMX n'a pas encore déclenché
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.attachProductEventListeners === 'function') {
                window.attachProductEventListeners();
            }
        });
    } else {
        if (typeof window.attachProductEventListeners === 'function') {
            window.attachProductEventListeners();
        }
    }
</script>

