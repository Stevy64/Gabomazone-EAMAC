{% extends 'base.html' %}
{% load static %}

{%block head%}
{{ block.super }}
<style>
    /* Masquer le preloader immédiatement pour cette page */
    #preloader-active {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
    
    /* S'assurer qu'il n'y a qu'un seul header */
    body > header.flavoriz-header:not(:first-of-type),
    body > .flavoriz-header:not(:first-of-type),
    .flavoriz-header ~ .flavoriz-header,
    header.flavoriz-header + header.flavoriz-header {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
    }
    
    /* Forcer le header à rester visible et fixe */
    .flavoriz-header {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 9999 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        transform: translateY(0) !important;
    }
</style>
{%endblock head%}

{%block body%}
<!-- ===== Shop Page FLAVORIZ Design ===== -->
<main class="main pages" style="padding-top: 100px; padding-bottom: 100px; min-height: calc(100vh - 200px); background: linear-gradient(135deg, #FDF8F3 0%, #FFF9F5 100%);">
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 24px;">
        <!-- Breadcrumb -->
        <nav style="margin-bottom: 20px; font-size: 13px; color: #6B7280; display: flex; align-items: center; gap: 6px;">
            <a href="{%url 'home:index'%}" style="color: var(--color-orange); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;">
                <i class="fi-rs-home"></i> <span>Accueil</span>
            </a>
            <span style="color: #9CA3AF;">/</span>
            <span style="color: #6B7280; font-weight: 500;">Produits</span>
        </nav>

        <!-- Page Header -->
        <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
                <h1 style="font-size: 32px; font-weight: 700; color: #1F2937; margin: 0 0 6px 0; font-family: var(--font-primary);">Produits</h1>
                <p style="font-size: 14px; color: #6B7280; margin: 0;">Découvrez notre sélection de produits</p>
            </div>
        </div>
        
        <!-- Product Count & Sort -->
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; padding: 18px 24px; background: white; border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); border: 1px solid #F3F4F6; position: relative; z-index: 10;">
            <div id="product-num" style="font-size: 14px; color: #6B7280;">
                <p style="margin: 0; display: flex; align-items: center; gap: 6px;">
                    <i class="fi-rs-box" style="color: var(--color-orange); font-size: 16px;"></i>
                    <span>Nous avons trouvé <strong style="color: var(--color-orange); font-weight: 700;">0</strong> articles pour vous !</span>
                </p>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; position: relative; z-index: 10;">
                <!-- Filtres par type de produit -->
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px; background: #F9FAFB; border-radius: 10px; border: 1px solid #E5E7EB;">
                    <button type="button" class="product-type-filter-btn" data-type="all" onclick="filterByProductType('all')" style="padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; background: {% if request.GET.product_type == 'all' or not request.GET.product_type %}linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%){% else %}#F3F4F6{% endif %}; color: {% if request.GET.product_type == 'all' or not request.GET.product_type %}white{% else %}#6B7280{% endif %};">
                        <i class="fi-rs-apps" style="font-size: 14px; margin-right: 4px;"></i> Tous
                    </button>
                    <button type="button" class="product-type-filter-btn" data-type="shop" onclick="filterByProductType('shop')" style="padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; background: {% if request.GET.product_type == 'shop' %}linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%){% else %}#F3F4F6{% endif %}; color: {% if request.GET.product_type == 'shop' %}white{% else %}#6B7280{% endif %};">
                        <i class="fi-rs-shopping-bag" style="font-size: 14px; margin-right: 4px;"></i> Magasins
                    </button>
                    <button type="button" class="product-type-filter-btn" data-type="peer" onclick="filterByProductType('peer')" style="padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; background: {% if request.GET.product_type == 'peer' %}linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%){% else %}#F3F4F6{% endif %}; color: {% if request.GET.product_type == 'peer' %}white{% else %}#6B7280{% endif %};">
                        <i class="fi-rs-users" style="font-size: 14px; margin-right: 4px;"></i> Occasion
                    </button>
                </div>
                <span style="font-size: 13px; color: #6B7280; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                    <i class="fi-rs-apps-sort" style="font-size: 16px; color: var(--color-orange);"></i> Trier par:
                </span>
                <div style="position: relative; z-index: 10;">
                    <select class="sorting mySelect" id="mySelect" style="padding: 10px 16px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 13px; background: #FAFAFA; color: #1F2937; cursor: pointer; outline: none; transition: all 0.2s ease; font-family: var(--font-secondary); min-width: 200px;"
                            hx-get="{% url 'categories:shop-htmx' %}"
                            hx-target="#products-list"
                            hx-swap="innerHTML"
                            hx-trigger="change"
                            hx-include="[name='cat_type'], [name='cat_id'], [name='product_type']"
                            name="order_by">
                        <option value="-date" {% if request.GET.order_by == '-date' or not request.GET.order_by %}selected{% endif %}>Date, nouveau à ancien</option>
                        <option value="date" {% if request.GET.order_by == 'date' %}selected{% endif %}>Date, ancien à nouveau</option>
                        <option value="-like_count" {% if request.GET.order_by == '-like_count' %}selected{% endif %}>Plus populaires</option>
                        <option value="PRDPrice" {% if request.GET.order_by == 'PRDPrice' %}selected{% endif %}>Prix, bas à haut</option>
                        <option value="-PRDPrice" {% if request.GET.order_by == '-PRDPrice' %}selected{% endif %}>Prix, haut à bas</option>
                    </select>
                </div>
                <input type="hidden" name="cat_type" id="cat_type_input" value="all" />
                <input type="hidden" name="cat_id" id="cat_id_input" value="" />
                <input type="hidden" name="product_type" id="product_type_input" value="{{ request.GET.product_type|default:'all' }}" />
            </div>
        </div>

        <!-- Main Content -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 24px; align-items: start;">
            <!-- Collapsible Filters & Categories Card -->
            <div class="flavoriz-filters-card" style="background: white; border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); border: 1px solid #F3F4F6; overflow: hidden;">
                <!-- Header avec bouton toggle -->
                <div class="flavoriz-filters-header" style="padding: 18px 24px; border-bottom: 2px solid #F3F4F6; cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, rgba(255, 123, 44, 0.05) 0%, rgba(255, 123, 44, 0.02) 100%); transition: all 0.2s ease;" onclick="toggleFilters()">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fi-rs-filter" style="color: var(--color-orange); font-size: 20px;"></i>
                        <h3 style="font-size: 18px; font-weight: 700; color: #1F2937; margin: 0; font-family: var(--font-primary);">Filtres et Catégories</h3>
                    </div>
                    <i class="fi-rs-angle-down" id="filters-toggle-icon" style="color: var(--color-orange); font-size: 20px; transition: transform 0.3s ease;"></i>
                </div>
                
                <!-- Contenu dépliable -->
                <div class="flavoriz-filters-content" id="filters-content" style="display: none; padding: 24px;">
                    <!-- Catégories en grille -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1F2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fi-rs-apps" style="color: var(--color-orange); font-size: 18px;"></i>
                            <span>Catégories</span>
                        </h4>
                        <div class="categories-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            <!-- Bouton "Tous les produits" -->
                            <a href="#" class="category-filter-link active" data-cat-type="all" data-cat-id="" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 16px 12px; border-radius: 12px; text-decoration: none; color: #1F2937; transition: all 0.2s ease; font-size: 13px; font-weight: 500; background: linear-gradient(135deg, rgba(255, 123, 44, 0.12) 0%, rgba(255, 123, 44, 0.08) 100%); border: 2px solid rgba(255, 123, 44, 0.3); text-align: center; min-height: 100px;">
                                <i class="fi-rs-apps" style="color: var(--color-orange); font-size: 24px;"></i>
                                <span style="font-weight: 600; color: var(--color-orange); line-height: 1.3;">Tous les produits</span>
                            </a>
                            {% for super in supercategory|slice:":10"%}
                            <a href="#" class="category-filter-link" data-cat-type="super" data-cat-id="{{super.id}}" data-cat-slug="{{super.slug}}" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 16px 12px; border-radius: 12px; text-decoration: none; color: #1F2937; transition: all 0.2s ease; font-size: 13px; font-weight: 500; background: #FAFAFA; border: 2px solid #E5E7EB; text-align: center; min-height: 100px;">
                                {%if super.category_image%}
                                <img src="{{super.category_image.url}}" alt="{{super.name}}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #F3F4F6; flex-shrink: 0;" />
                                {%else%}
                                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--color-orange) 0%, #E65A1F 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(255, 123, 44, 0.3);">{{super.name|first|upper}}</div>
                                {%endif%}
                                <span style="line-height: 1.3; text-align: center;">{{super.name}}</span>
                            </a>
                            {% empty %}
                            <div style="grid-column: 1 / -1; padding: 20px; color: #9CA3AF; font-size: 13px; text-align: center;">Aucune catégorie disponible</div>
                            {% endfor %}
                        </div>
                        {%if supercategory.count >= 11  %}
                        <div class="more_categories" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E7EB; cursor: pointer; color: var(--color-orange); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease; justify-content: center;">
                            <i class="fi-rs-angle-down"></i>
                            <span>Voir plus de catégories...</span>
                        </div>
                        <div class="ul-category more_slide_open" style="display: none; margin-top: 16px;">
                            <div class="categories-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                                {%for super in supercategory|slice:"10:" %}
                                <a href="#" class="category-filter-link" data-cat-type="super" data-cat-id="{{super.id}}" data-cat-slug="{{super.slug}}" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 16px 12px; border-radius: 12px; text-decoration: none; color: #1F2937; transition: all 0.2s ease; font-size: 13px; font-weight: 500; background: #FAFAFA; border: 2px solid #E5E7EB; text-align: center; min-height: 100px;">
                                    {%if super.category_image%}
                                    <img src="{{super.category_image.url}}" alt="{{super.name}}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #F3F4F6; flex-shrink: 0;" />
                                    {%else%}
                                    <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--color-orange) 0%, #E65A1F 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(255, 123, 44, 0.3);">{{super.name|first|upper}}</div>
                                    {%endif%}
                                    <span style="line-height: 1.3; text-align: center;">{{super.name}}</span>
                                </a>
                                {%endfor%}
                            </div>
                        </div>
                        {%endif%}
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            <div>
                <div id="products-list" class="flavoriz-product-grid" style="display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 20px !important; margin-bottom: 24px !important; width: 100% !important; max-width: 100% !important; box-sizing: border-box !important; padding: 0 !important;"
                     hx-get="{% url 'categories:shop-htmx' %}?page=1&order_by={{ request.GET.order_by|default:'-date' }}&cat_type=all&cat_id=&product_type={{ request.GET.product_type|default:'all' }}"
                     hx-trigger="load"
                     hx-swap="innerHTML"
                     hx-target="this">
                    <!-- Products will be loaded here via HTMX -->
                    </div>
                
                <!-- Loading Spinner -->
                <div id="spinner-box" class="not-visible" style="text-align: center; padding: 40px;">
                    <div class="flavoriz-spinner" style="margin: 0 auto;"></div>
                    <p style="margin-top: 16px; color: #6B7280; font-size: 14px;">Chargement des produits...</p>
                                </div>
                
                <!-- Empty Box -->
                <div id="empty-box" class="not-visible" style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
                    <i class="fi-rs-shopping-bag" style="font-size: 64px; color: #D1D5DB; opacity: 0.5; margin-bottom: 16px;"></i>
                    <p style="font-size: 16px; font-weight: 600; color: #6B7280; margin: 0;">Aucun produit disponible !</p>
                            </div>

                <!-- Loading Indicator pour HTMX -->
                <div id="loading-indicator" class="htmx-indicator" style="text-align: center; padding: 24px; display: none;">
                    <div class="flavoriz-spinner" style="margin: 0 auto;"></div>
                    <p style="margin-top: 16px; color: #6B7280; font-size: 14px;">Chargement des produits...</p>
                                </div>
                </div>
            </div>
        </div>
    </main>

<style>
.not-visible {
    display: none !important;
}

#load-btn:hover {
    background: #E65A1F !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 123, 44, 0.4) !important;
}

/* Styles pour les catégories en grille */
.categories-grid a.category-filter-link:hover {
    background: linear-gradient(135deg, rgba(255, 123, 44, 0.1) 0%, rgba(255, 123, 44, 0.06) 100%) !important;
    color: var(--color-orange) !important;
    transform: translateY(-2px) !important;
    border-color: rgba(255, 123, 44, 0.3) !important;
    box-shadow: 0 4px 12px rgba(255, 123, 44, 0.15) !important;
}

.categories-grid a.category-filter-link.active {
    background: linear-gradient(135deg, rgba(255, 123, 44, 0.15) 0%, rgba(255, 123, 44, 0.1) 100%) !important;
    color: var(--color-orange) !important;
    border: 2px solid rgba(255, 123, 44, 0.5) !important;
    font-weight: 600 !important;
    box-shadow: 0 4px 12px rgba(255, 123, 44, 0.2) !important;
}

.categories-grid a.category-filter-link.active img,
.categories-grid a.category-filter-link.active div[style*="background: linear-gradient"] {
    border-color: var(--color-orange) !important;
    box-shadow: 0 2px 8px rgba(255, 123, 44, 0.3) !important;
}

/* Styles pour le header dépliable */
.flavoriz-filters-header:hover {
    background: linear-gradient(135deg, rgba(255, 123, 44, 0.08) 0%, rgba(255, 123, 44, 0.04) 100%) !important;
}

#filters-toggle-icon.rotated {
    transform: rotate(180deg);
}

.more_categories:hover {
    color: #E65A1F !important;
}

select.mySelect:focus {
    border-color: var(--color-orange) !important;
    box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1) !important;
    background: white !important;
}

/* Corriger le positionnement du dropdown personnalisé */
.flavoriz-custom-dropdown {
    position: relative !important;
    z-index: 10 !important;
    display: inline-block !important;
}

.flavoriz-dropdown-menu {
    position: absolute !important;
    z-index: 11 !important;
    max-width: 100% !important;
    overflow: visible !important;
}

/* S'assurer que le conteneur parent permet l'overflow */
.main.pages > div > div[style*="Product Count"] {
    overflow: visible !important;
    position: relative !important;
}

/* Responsive pour les catégories en grille */
@media (max-width: 768px) {
    .categories-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 10px !important;
    }
    
    .categories-grid a.category-filter-link {
        padding: 12px 8px !important;
        min-height: 90px !important;
        font-size: 12px !important;
    }
    
    .categories-grid a.category-filter-link img,
    .categories-grid a.category-filter-link div[style*="width: 48px"] {
        width: 40px !important;
        height: 40px !important;
        font-size: 16px !important;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .categories-grid {
        grid-template-columns: repeat(4, 1fr) !important;
    }
}

@media (max-width: 768px) {
    .main.pages {
        padding-top: 80px !important;
        padding-bottom: 60px !important;
    }
    
    h1 {
        font-size: 24px !important;
    }
    
    #products-list {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        width: 100% !important;
    }
    
    #products-list > * {
        width: 100% !important;
        min-width: 0 !important;
    }
    
    .flavoriz-product-image {
        height: 160px !important;
    }
    
    .flavoriz-product-body {
        padding: 12px !important;
    }
    
    .flavoriz-product-title {
        font-size: 13px !important;
        min-height: 36px !important;
        margin-bottom: 8px !important;
    }
    
    .flavoriz-product-card-btn {
        padding: 8px 12px !important;
        font-size: 12px !important;
    }
}

/* Amélioration des cartes produits */
.flavoriz-product-card {
    background: white !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border: 1px solid #F3F4F6 !important;
    cursor: pointer !important;
    display: flex !important;
    flex-direction: column !important;
}

.flavoriz-product-card:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
    border-color: rgba(255, 123, 44, 0.3) !important;
}

.flavoriz-product-card:hover .flavoriz-product-image {
    transform: scale(1.05) !important;
}

.flavoriz-product-card-btn:hover {
    background: var(--color-orange) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3) !important;
}

/* Styles de base pour la grille - FORCER 4 colonnes par défaut - PRIORITÉ MAXIMALE */
#products-list,
#products-list.flavoriz-product-grid,
div#products-list,
div#products-list.flavoriz-product-grid {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 20px !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    position: relative !important;
}

#products-list > *,
#products-list.flavoriz-product-grid > *,
div#products-list > *,
div#products-list.flavoriz-product-grid > * {
    width: 100% !important;
    min-width: 0 !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
}

/* Forcer la grille à 4 colonnes sur grand écran */
@media (min-width: 1200px) {
    #products-list,
    #products-list.flavoriz-product-grid {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 20px !important;
        display: grid !important;
        padding: 0 !important;
    }
}

/* 3 colonnes sur écran moyen */
@media (max-width: 1199px) and (min-width: 769px) {
    #products-list,
    #products-list.flavoriz-product-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 18px !important;
        display: grid !important;
        padding: 0 !important;
    }
}
</style>
{%endblock body%}

{%block script%}
{{ block.super }}
<script>
    // Masquer le preloader immédiatement
    (function() {
        function hidePreloader() {
            const preloader = document.getElementById('preloader-active');
            if (preloader) {
                preloader.style.display = 'none';
                preloader.style.opacity = '0';
                preloader.style.visibility = 'hidden';
            }
        }
        hidePreloader();
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', hidePreloader);
        } else {
            hidePreloader();
        }
        window.addEventListener('load', function() {
            setTimeout(hidePreloader, 100);
        });
    })();
        </script>
<script src="{% static 'assets/js/vendor/jquery-3.6.0.min.js'%}"></script>
<script src="{% static 'assets/js/filter.js'%}"></script>
<script>
    var categoryType = "all";
    var categoryID = null;
    
    // Forcer la grille à s'afficher correctement
    function forceGridLayout() {
        const productsList = document.getElementById('products-list');
        if (productsList) {
            const width = window.innerWidth;
            productsList.style.setProperty('display', 'grid', 'important');
            productsList.style.setProperty('width', '100%', 'important');
            productsList.style.setProperty('max-width', '100%', 'important');
            productsList.style.setProperty('box-sizing', 'border-box', 'important');
            
            if (width >= 1200) {
                productsList.style.setProperty('grid-template-columns', 'repeat(4, 1fr)', 'important');
                productsList.style.setProperty('gap', '24px', 'important');
            } else if (width >= 769) {
                productsList.style.setProperty('grid-template-columns', 'repeat(3, 1fr)', 'important');
                productsList.style.setProperty('gap', '20px', 'important');
            } else {
                productsList.style.setProperty('grid-template-columns', 'repeat(2, 1fr)', 'important');
                productsList.style.setProperty('gap', '12px', 'important');
            }
            
            // Forcer les enfants
            const children = productsList.children;
            for (let i = 0; i < children.length; i++) {
                children[i].style.setProperty('width', '100%', 'important');
                children[i].style.setProperty('min-width', '0', 'important');
                children[i].style.setProperty('max-width', '100%', 'important');
                children[i].style.setProperty('box-sizing', 'border-box', 'important');
            }
        }
    }
    
        // Fonction pour toggle les filtres
        function toggleFilters() {
            const content = document.getElementById('filters-content');
            const icon = document.getElementById('filters-toggle-icon');
            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                icon.classList.add('rotated');
                // Sauvegarder l'état dans localStorage
                localStorage.setItem('filtersExpanded', 'true');
            } else {
                content.style.display = 'none';
                icon.classList.remove('rotated');
                localStorage.setItem('filtersExpanded', 'false');
            }
        }
        
        // Toggle "Voir plus" categories
        $(document).ready(function() {
            // Restaurer l'état des filtres depuis localStorage
            const filtersExpanded = localStorage.getItem('filtersExpanded');
            if (filtersExpanded === 'true') {
                document.getElementById('filters-content').style.display = 'block';
                document.getElementById('filters-toggle-icon').classList.add('rotated');
            }
            
            // Forcer la grille au chargement
            forceGridLayout();
            
            // Forcer la grille au redimensionnement
            window.addEventListener('resize', forceGridLayout);
            
            // Observer les changements dans products-list
            const observer = new MutationObserver(function(mutations) {
                forceGridLayout();
            });
            const productsList = document.getElementById('products-list');
            if (productsList) {
                observer.observe(productsList, { childList: true, subtree: true });
            }
            
            $('.more_categories').on('click', function() {
                const $ul = $(this).next('.more_slide_open');
                const $icon = $(this).find('i');
                if ($ul.is(':visible')) {
                    $ul.slideUp(300);
                    $icon.removeClass('fi-rs-angle-up').addClass('fi-rs-angle-down');
                } else {
                    $ul.slideDown(300);
                    $icon.removeClass('fi-rs-angle-down').addClass('fi-rs-angle-up');
                }
            });
        
        // Filtrage HTMX des catégories (SPA-like)
        $(document).on('click', '.category-filter-link', function(e) {
            e.preventDefault();
            
            // Retirer l'état actif de tous les liens
            $('.category-filter-link').removeClass('active');
            $('.category-filter-link').each(function() {
                const $this = $(this);
                if (!$this.data('cat-id') || $this.data('cat-id') === '') {
                    // C'est "Tous les produits"
                    $this.css({
                        'background': 'linear-gradient(135deg, rgba(255, 123, 44, 0.12) 0%, rgba(255, 123, 44, 0.08) 100%)',
                        'border': '1px solid rgba(255, 123, 44, 0.3)',
                        'font-weight': '600',
                        'color': 'var(--color-orange)'
                    });
                } else {
                    $this.css({
                        'background': '',
                        'border': '',
                        'font-weight': '500',
                        'color': '#1F2937'
                    });
                }
            });
            
            // Ajouter l'état actif au lien cliqué
            $(this).addClass('active');
            $(this).css({
                'background': 'linear-gradient(135deg, rgba(255, 123, 44, 0.15) 0%, rgba(255, 123, 44, 0.1) 100%)',
                'border': '1px solid rgba(255, 123, 44, 0.4)',
                'font-weight': '600',
                'color': 'var(--color-orange)'
            });
            
            // Mettre à jour les champs cachés pour HTMX
            const catType = $(this).data('cat-type') || 'all';
            const catId = $(this).data('cat-id') || '';
            $('#cat_type_input').val(catType);
            $('#cat_id_input').val(catId);
            
            // Mettre à jour les variables globales (pour compatibilité)
            window.categoryType = catType;
            window.categoryID = catId;
            
            // Recharger les produits avec HTMX
            const orderBy = $('#mySelect').val();
            const productType = $('#product_type_input').val() || 'all';
            const url = '{% url "categories:shop-htmx" %}?page=1&order_by=' + orderBy + '&cat_type=' + catType + '&cat_id=' + catId + '&product_type=' + productType;
            htmx.ajax('GET', url, {
                target: '#products-list',
                swap: 'innerHTML'
            });
        });
        
        // Fonction pour filtrer par type de produit
        window.filterByProductType = function(type) {
            // Mettre à jour le champ caché
            $('#product_type_input').val(type);
            
            // Mettre à jour l'apparence des boutons
            $('.product-type-filter-btn').each(function() {
                const btnType = $(this).data('type');
                if (btnType === type) {
                    $(this).css({
                        'background': 'linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%)',
                        'color': 'white'
                    });
                } else {
                    $(this).css({
                        'background': '#F3F4F6',
                        'color': '#6B7280'
                    });
                }
            });
            
            // Recharger les produits avec HTMX
            const orderBy = $('#mySelect').val();
            const catType = $('#cat_type_input').val() || 'all';
            const catId = $('#cat_id_input').val() || '';
            const url = '{% url "categories:shop-htmx" %}?page=1&order_by=' + orderBy + '&cat_type=' + catType + '&cat_id=' + catId + '&product_type=' + type;
            htmx.ajax('GET', url, {
                target: '#products-list',
                swap: 'innerHTML'
            });
        };
    });
</script>
{%endblock script%}
