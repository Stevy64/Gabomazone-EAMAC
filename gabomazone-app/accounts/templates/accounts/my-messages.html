{% extends 'base.html' %}
{% load static %}
{% load cart_template_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'accounts/css/negotiation.css' %}">
{% endblock %}

{%block body%}
<style>
/* ============================================
   MOBILE-FIRST APPROACH - Styles par d√©faut pour mobile
   ============================================ */

/* Pr√©venir le d√©bordement horizontal sur toute la page */
body {
    overflow-x: hidden;
}

/* Layout principal - Mobile par d√©faut */
.main.pages {
    padding-top: 80px;
    padding-bottom: 40px;
    overflow-x: hidden;
}

.container {
    padding: 0 12px;
    max-width: 100%;
    margin: 0 auto;
    overflow-x: hidden;
    box-sizing: border-box;
}

/* Row - Mobile: colonnes empil√©es */
.row {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    box-sizing: border-box;
}

/* Sidebar - Mobile: pleine largeur, en haut */
.col-md-3 {
    flex: 0 0 100%;
    max-width: 100%;
    width: 100%;
    margin-bottom: 16px;
    order: 1;
    padding: 0;
    box-sizing: border-box;
}

.flavoriz-dashboard-menu {
    position: relative;
    top: 0;
    padding: 16px;
    border-radius: 12px;
    box-sizing: border-box;
    width: 100%;
}

.flavoriz-dashboard-menu ul {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 8px !important;
}

.flavoriz-dashboard-menu li a {
    padding: 10px 12px !important;
    font-size: 13px !important;
    flex-direction: column !important;
    gap: 6px !important;
    text-align: center !important;
}

.flavoriz-dashboard-menu li a i {
    font-size: 18px !important;
    width: auto !important;
}

/* Main content - Mobile: pleine largeur */
.col-md-9 {
    flex: 0 0 100%;
    max-width: 100%;
    width: 100%;
    order: 2;
    box-sizing: border-box;
}

.col-md-9 > div {
    padding: 16px 12px;
    border-radius: 16px;
    box-sizing: border-box;
    width: 100%;
    overflow: hidden;
}

/* Breadcrumb - Mobile: simplifi√© */
nav {
    font-size: 12px !important;
    flex-wrap: wrap !important;
    gap: 4px !important;
    margin-bottom: 16px !important;
}

/* Masquer uniquement le texte du fil d'Ariane (pas la barre du bas) */
main .container > nav a span {
    display: none !important;
}

nav span:not(:last-child) {
    display: none !important;
}

/* Header - Mobile */
.main-content-header h1 {
    font-size: 20px !important;
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 8px !important;
    margin-bottom: 12px !important;
}

.main-content-header h1 i {
    font-size: 22px !important;
}

.main-content-header p {
    font-size: 13px !important;
    line-height: 1.5 !important;
}

/* Conversations grid - Mobile: 1 colonne */
.conversations-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    width: 100%;
    box-sizing: border-box;
}
.msg-card {
    border-radius: 16px;
}

/* Cards de conversation - Mobile */
.conversation-card {
    padding: 12px;
    border-radius: 12px;
    box-sizing: border-box;
    width: 100%;
    overflow: hidden;
    word-wrap: break-word;
}

/* Avatar - Mobile */
.conversation-avatar {
    width: 48px;
    height: 48px;
    font-size: 18px;
}

/* Image produit - Mobile */
.conversation-product-img {
    width: 50px;
    height: 50px;
    min-width: 50px;
}

/* Textes - Mobile */
.conversation-user-name {
    font-size: 15px;
}

.conversation-product-name {
    font-size: 13px;
}

/* Pr√©venir le d√©bordement du texte dans les cartes */
.conversation-card p,
.conversation-card div {
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
}

.conversation-card strong {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Intentions d'achat grid - Mobile: 1 colonne */
.purchase-intents-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}

/* Cartes d'intentions - Mobile */
.intent-card {
    padding: 16px;
    border-radius: 12px;
}

/* Boutons dans intentions - Mobile: 2 colonnes */
.purchase-intents-grid > div > div:last-child {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
}

.purchase-intents-grid > div > div:last-child > button,
.purchase-intents-grid > div > div:last-child > span {
    flex: 1 1 calc(50% - 3px) !important;
    min-width: calc(50% - 3px) !important;
    font-size: 12px !important;
    padding: 8px !important;
}

/* ============================================
   DESKTOP - Styles pour √©crans >= 769px
   ============================================ */
@media (min-width: 769px) {
    .main.pages {
        padding-top: 100px;
        padding-bottom: 100px;
    }
    
    .container {
        padding: 0 24px;
        max-width: 1400px;
    }
    
    .row {
        flex-direction: row;
        gap: 24px;
        align-items: flex-start;
    }
    
    .col-md-3 {
        flex: 0 0 280px;
        max-width: 280px;
        width: 280px;
        margin-bottom: 0;
        order: 0;
    }
    
    .flavoriz-dashboard-menu {
        padding: 24px;
        border-radius: 20px;
        position: sticky;
        top: 120px;
    }
    
    .flavoriz-dashboard-menu ul {
        display: flex;
        flex-direction: column;
        grid-template-columns: none;
        gap: 4px;
    }
    
    .flavoriz-dashboard-menu li a {
        padding: 12px 16px;
        font-size: 14px;
        flex-direction: row;
        text-align: left;
        gap: 12px;
    }
    
    .flavoriz-dashboard-menu li a i {
        font-size: 16px;
        width: 20px;
    }
    
    .col-md-9 {
        flex: 1;
        min-width: 0;
        order: 0;
    }
    
    .col-md-9 > div {
        padding: 32px;
        border-radius: 20px;
    }
    
    nav {
        font-size: 13px !important;
        margin-bottom: 20px !important;
    }
    
    main .container > nav a span {
        display: inline !important;
    }
    
    main .container > nav span:not(:last-child) {
        display: inline !important;
    }
    
    .main-content-header h1 {
        font-size: 28px !important;
        flex-direction: row !important;
        align-items: center !important;
        margin-bottom: 8px !important;
    }
    
    .main-content-header h1 i {
        font-size: 32px !important;
    }
    
    .main-content-header p {
        font-size: 15px !important;
    }
    
    .conversations-grid {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }
    
    .conversation-card {
        padding: 20px;
    }
    
    .conversation-avatar {
        width: 56px;
        height: 56px;
        font-size: 20px;
    }
    
    .conversation-product-img {
        width: 60px;
        height: 60px;
    }
    
    .conversation-user-name {
        font-size: 16px;
    }
    
    .conversation-product-name {
        font-size: 14px;
    }
    
    .purchase-intents-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
    }
    
    .intent-card {
        padding: 20px;
    }
    
    .purchase-intents-grid > div > div:last-child {
        flex-wrap: nowrap !important;
        gap: 8px !important;
    }
    
    .purchase-intents-grid > div > div:last-child > button,
    .purchase-intents-grid > div > div:last-child > span {
        flex: 1 !important;
        min-width: auto !important;
        font-size: 13px !important;
        padding: 10px !important;
    }
}
</style>

<main class="main pages" style="min-height: calc(100vh - 200px); background: linear-gradient(135deg, #FDF8F3 0%, #FFF9F5 100%);">
    <div class="container">
        <!-- Breadcrumb -->
        <nav style="margin-bottom: 20px; font-size: 13px; color: #6B7280; display: flex; align-items: center; gap: 6px;">
            <a href="{% url 'home:index' %}" style="color: var(--color-orange); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;">
                <i class="fi-rs-home"></i> <span>Accueil</span>
            </a>
            <span style="color: #9CA3AF;">/</span>
            <span style="color: #6B7280; font-weight: 500;">Ma messagerie</span>
        </nav>

        <div class="row">
            <!-- Sidebar Menu (carte Mon compte, sans D√©connexion) -->
            <div class="col-md-3">
                {% include 'accounts/_mon_compte_card.html' with active_page='my-messages' %}
            </div>

            <!-- Main Content -->
            <div class="col-md-9">
                <div style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <!-- Header -->
                    <div class="main-content-header" style="margin-bottom: 32px;">
                        <h1 style="font-size: 28px; font-weight: 700; color: #1F2937; margin: 0 0 8px 0; display: flex; align-items: center; gap: 12px;">
                            <i class="fi-rs-comment" style="color: var(--color-orange); font-size: 32px;"></i>
                            Ma messagerie
                            {% if total_unread > 0 %}
                            <span style="background: #EF4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 16px; font-weight: 700; margin-left: 12px;">
                                {{ total_unread }} non lu{{ total_unread|pluralize }}
                            </span>
                            {% endif %}
                        </h1>
                        <p style="color: #6B7280; font-size: 15px; margin: 0; line-height: 1.6;">
                            G√©rez toutes vos conversations avec les vendeurs et acheteurs pour vos articles en occasion.
                        </p>
                    </div>

                    <!-- Messages -->
                    {% if messages %}
                    <div style="margin-bottom: 24px;">
                        {% for message in messages %}
                        <div class="alert alert-{{message.tags}}" style="padding: 16px 20px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; {% if message.tags == 'success' %}background: #D1FAE5; color: #065F46; border: 1px solid #10B981;{% elif message.tags == 'error' %}background: #FEE2E2; color: #991B1B; border: 1px solid #EF4444;{% else %}background: #FEF3C7; color: #92400E; border: 1px solid #F59E0B;{% endif %}">
                            <i class="fi-rs-{% if message.tags == 'success' %}check{% elif message.tags == 'error' %}cross-circle{% else %}info{% endif %}" style="font-size: 20px;"></i>
                            <span style="font-weight: 500;">{{message}}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Intentions d'achat (pour les vendeurs) -->
                    {% if purchase_intents and purchase_intents|length > 0 %}
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 18px; font-weight: 700; color: #1F2937; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fi-rs-money" style="color: var(--color-orange);"></i>
                            Intentions d'achat
                            {% if purchase_intents_unread > 0 %}
                            <span style="background: #EF4444; color: white; border-radius: 12px; padding: 2px 8px; font-size: 12px; font-weight: 700;">{{ purchase_intents_unread }}</span>
                            {% endif %}
                        </h3>
                        <div class="purchase-intents-grid">
                            {% for intent in purchase_intents %}
                            <div class="intent-card" onclick="openConversationChatbot({{ intent.product.id }}, null)" style="background: {% if not intent.seller_notified %}#FFF9E6{% else %}white{% endif %}; border: 2px solid {% if not intent.seller_notified %}var(--color-orange){% else %}#E5E7EB{% endif %}; transition: all 0.3s; cursor: pointer; position: relative;" onmouseover="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='{% if not intent.seller_notified %}var(--color-orange){% else %}#E5E7EB{% endif %}'; this.style.boxShadow='none'">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <h4 style="font-size: 16px; font-weight: 700; color: #1F2937; margin: 0 0 4px 0;">Intention #{{ intent.id }}</h4>
                                        <p style="font-size: 12px; color: #6B7280; margin: 0;">{{ intent.created_at|date:"d/m/Y √† H:i" }}</p>
                                    </div>
                                    {% if not intent.seller_notified %}
                                    <span style="width: 12px; height: 12px; background: var(--color-orange); border-radius: 50%; display: block;"></span>
                                    {% endif %}
                                </div>
                                <p style="font-size: 14px; color: #374151; margin: 0 0 12px 0;">
                                    <strong>{{ intent.buyer.get_full_name|default:intent.buyer.username }}</strong> souhaite n√©gocier l'achat de <strong>{{ intent.product.product_name|truncatechars:30 }}</strong>
                                </p>
                                <div style="background: #F9FAFB; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    <p style="margin: 0; font-size: 13px; color: #6B7280;">Prix initial propos√© :</p>
                                    <p style="margin: 4px 0 0 0; font-size: 18px; font-weight: 700; color: var(--color-orange);">
                                        {{ intent.initial_price|floatformat:0 }} FCFA
                                    </p>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    {% if intent.status == 'pending' or intent.status == 'negotiating' %}
                                    <button onclick="event.stopPropagation(); acceptPurchaseIntent({{ intent.id }})" style="flex: 1; padding: 10px; background: #10B981; color: white; border: none; border-radius: 8px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10B981'">
                                        <i class="fi-rs-check"></i> Accepter
                                    </button>
                                    <button onclick="event.stopPropagation(); rejectPurchaseIntent({{ intent.id }})" style="flex: 1; padding: 10px; background: #EF4444; color: white; border: none; border-radius: 8px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#DC2626'" onmouseout="this.style.background='#EF4444'">
                                        <i class="fi-rs-cross"></i> Refuser
                                    </button>
                                    {% elif intent.status == 'agreed' %}
                                    <span style="flex: 1; padding: 10px; background: #D1FAE5; color: #065F46; border-radius: 8px; text-align: center; font-size: 13px; font-weight: 600;">
                                        <i class="fi-rs-check"></i> Prix accept√©
                                    </span>
                                    {% elif intent.status == 'rejected' or intent.status == 'cancelled' %}
                                    <span style="flex: 1; padding: 10px; background: #FEE2E2; color: #991B1B; border-radius: 8px; text-align: center; font-size: 13px; font-weight: 600;">
                                        <i class="fi-rs-cross"></i> {% if intent.status == 'rejected' %}Refus√©e{% else %}Annul√©e{% endif %}
                                    </span>
                                    <button onclick="event.stopPropagation(); cancelPurchaseIntent({{ intent.id }})" style="flex: 1; padding: 10px; background: #6B7280; color: white; border: none; border-radius: 8px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#4B5563'" onmouseout="this.style.background='#6B7280'" title="Supprimer cette intention">
                                        <i class="fi-rs-trash"></i> Supprimer
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Liste des conversations -->
                    {% if conversations %}
                    <div class="conversations-grid">
                        {% for conversation in conversations %}
                        <div class="conversation-card msg-card" onclick="openConversationChatbot({{ conversation.product.id }}, {{ conversation.id }})" style="background: white; border-radius: 16px; border: 1px solid #E5E7EB; transition: all 0.25s ease; cursor: pointer; position: relative; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.06);" onmouseover="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 8px 24px rgba(255, 123, 44, 0.12)'" onmouseout="this.style.borderColor='#E5E7EB'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.06)'">
                            <!-- Actions : supprimer -->
                            <button onclick="event.stopPropagation(); deleteConversation({{ conversation.id }}, '{{ conversation.other_user.get_full_name|default:conversation.other_user.username|escapejs }}')" title="Supprimer la conversation" style="position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.95); border: none; border-radius: 10px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #9CA3AF; transition: all 0.2s; z-index: 10; box-shadow: 0 1px 4px rgba(0,0,0,0.08);" onmouseover="this.style.background='#FEE2E2'; this.style.color='#DC2626'" onmouseout="this.style.background='rgba(255,255,255,0.95)'; this.style.color='#9CA3AF'">
                                <i class="fi-rs-trash" style="font-size: 14px;"></i>
                            </button>
                            
                            <!-- Badge de statut C2C -->
                            {% if conversation.c2c_order %}
                            <div style="position: absolute; top: 8px; left: 8px; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; z-index: 10;
                                {% if conversation.c2c_order.status == 'completed' %}background: #D1FAE5; color: #065F46;
                                {% elif conversation.c2c_order.status == 'paid' or conversation.c2c_order.status == 'pending_delivery' %}background: #DBEAFE; color: #1E40AF;
                                {% elif conversation.c2c_order.status == 'pending_payment' %}background: #FEF3C7; color: #D97706;
                                {% else %}background: #F3F4F6; color: #6B7280;{% endif %}">
                                {% if conversation.c2c_order.status == 'completed' %}‚úì Termin√©
                                {% elif conversation.c2c_order.status == 'paid' %}üí≥ Pay√©
                                {% elif conversation.c2c_order.status == 'pending_delivery' %}üì¶ Livraison
                                {% elif conversation.c2c_order.status == 'pending_payment' %}‚è≥ Paiement
                                {% else %}{{ conversation.c2c_order.status }}{% endif %}
                            </div>
                            {% elif conversation.purchase_intent %}
                            <div style="position: absolute; top: 8px; left: 8px; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; background: #FFF7ED; color: var(--color-orange); z-index: 10;">
                                {% if conversation.purchase_intent.status == 'agreed' %}ü§ù Accord
                                {% elif conversation.purchase_intent.status == 'negotiating' %}üí¨ N√©go
                                {% else %}üì© Intent{% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- En-t√™te de conversation -->
                            <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 14px; margin-top: {% if conversation.c2c_order or conversation.purchase_intent %}32px{% else %}8px{% endif %}; padding-right: 36px;">
                                <div class="conversation-avatar" style="width: 52px; height: 52px; border-radius: 50%; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 20px; flex-shrink: 0;">
                                    {{ conversation.other_user.get_full_name|default:conversation.other_user.username|first|upper }}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <h4 class="conversation-user-name" style="margin: 0; font-weight: 700; font-size: 16px; color: #1F2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        {{ conversation.other_user.get_full_name|default:conversation.other_user.username }}
                                    </h4>
                                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #6B7280;">
                                        {% if conversation.user_role == 'seller' %}Acheteur{% else %}Vendeur{% endif %} ¬∑ {{ conversation.product.product_name|truncatechars:30 }}
                                    </p>
                                </div>
                                {% if conversation.unread_count > 0 %}
                                <span style="background: #EF4444; color: white; border-radius: 10px; min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; padding: 0 6px; flex-shrink: 0;">
                                    {{ conversation.unread_count }}
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Informations sur l'article -->
                            <div style="background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%); border-radius: 12px; padding: 14px; margin-bottom: 12px; display: flex; gap: 14px; align-items: center;">
                                <img class="conversation-product-img" src="{{ conversation.product.product_image.url }}" alt="{{ conversation.product.product_name }}" loading="lazy" decoding="async" style="width: 56px; height: 56px; object-fit: cover; border-radius: 10px; flex-shrink: 0;">
                                <div style="flex: 1; min-width: 0;">
                                    <h5 class="conversation-product-name" style="margin: 0 0 4px 0; font-weight: 700; font-size: 14px; color: #1F2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        {{ conversation.product.product_name|truncatechars:40 }}
                                    </h5>
                                    <p style="margin: 0; font-size: 14px; font-weight: 700; color: var(--color-orange);">
                                        {{ conversation.product.PRDPrice|format_price }} FCFA
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Dernier message -->
                            {% if conversation.last_message %}
                            <div style="margin-top: auto; padding-top: 14px; border-top: 1px solid #F3F4F6;">
                                <p style="margin: 0 0 4px 0; font-size: 13px; color: #6B7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.4;">
                                    {% if conversation.last_message.sender == user %}<span style="color: var(--color-orange); font-weight: 600;">Vous :</span> {% endif %}{{ conversation.last_message.message|truncatechars:55 }}
                                </p>
                                <p style="margin: 0; font-size: 11px; color: #9CA3AF;">
                                    {{ conversation.last_message.created_at|date:"d/m/Y √† H:i" }}
                                </p>
                            </div>
                            {% else %}
                            <div style="margin-top: auto; padding-top: 14px; border-top: 1px solid #F3F4F6;">
                                <p style="margin: 0; font-size: 13px; color: #9CA3AF; font-style: italic;">
                                    Aucun message
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 64px 24px; border-radius: 16px; background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);">
                        <i class="fi-rs-inbox" style="font-size: 56px; color: #D1D5DB; margin-bottom: 20px;"></i>
                        <h3 style="font-size: 20px; font-weight: 700; color: #6B7280; margin: 0 0 12px 0;">Aucune conversation</h3>
                        <p style="font-size: 15px; color: #9CA3AF; margin: 0;">Vos √©changes avec vendeurs et acheteurs appara√Ætront ici.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Chatbot Popup -->
<div id="chatbotPopup" style="display: none; position: fixed; bottom: 20px; right: 20px; width: 400px; max-width: calc(100vw - 40px); height: 600px; max-height: calc(100vh - 40px); background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); z-index: 10000; flex-direction: column; overflow: hidden;">
    <!-- Chatbot Header -->
    <div style="background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); padding: 20px; color: white; display: flex; align-items: center; justify-content: space-between; border-radius: 20px 20px 0 0;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fi-rs-comment" style="font-size: 24px;"></i>
            <div>
                <h3 style="margin: 0; font-size: 18px; font-weight: 700;">Messages</h3>
                <p id="chatbotProductName" style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;"></p>
            </div>
        </div>
        <button onclick="closeChatbot()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
            <i class="fi-rs-cross" style="font-size: 16px;"></i>
        </button>
    </div>
    
    <!-- Conversations List -->
    <div id="conversationsList" style="flex: 1; overflow-y: auto; padding: 16px; background: #F9FAFB; display: flex; flex-direction: column;">
        <div id="conversationsLoading" style="text-align: center; padding: 40px; color: #6B7280;">
            <i class="fi-rs-spinner" style="font-size: 32px; animation: spin 1s linear infinite;"></i>
            <p style="margin: 12px 0 0 0; font-size: 14px;">Chargement des conversations...</p>
        </div>
        <div id="conversationsContent" style="display: none;">
            <!-- Les conversations seront inject√©es ici -->
        </div>
        <div id="noConversations" style="display: none; text-align: center; padding: 60px 20px; color: #9CA3AF;">
            <i class="fi-rs-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
            <p style="margin: 0; font-size: 14px;">Aucune conversation pour cet article</p>
        </div>
    </div>
    
    <!-- Active Conversation View -->
    <div id="activeConversation" style="display: none; flex: 1; flex-direction: column; background: white; min-height: 0; overflow: hidden;">
        <!-- Conversation Header -->
        <div style="padding: 14px 16px; border-bottom: 1px solid #E5E7EB; display: flex; align-items: center; gap: 12px; background: #F9FAFB; flex-shrink: 0;">
            <button onclick="showConversationsList()" style="background: none; border: none; color: var(--color-orange); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: 10px;" onmouseover="this.style.background='rgba(255,123,44,0.1)'" onmouseout="this.style.background='none'">
                <i class="fi-rs-arrow-left" style="font-size: 18px;"></i>
            </button>
            <div style="flex: 1; min-width: 0;">
                <h4 id="activeConversationBuyer" style="margin: 0; font-size: 16px; font-weight: 700; color: #1F2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></h4>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #6B7280;">Acheteur</p>
            </div>
            <button id="deleteConversationBtnInPopup" onclick="deleteConversationFromPopup()" title="Supprimer la conversation" style="background: none; border: none; color: #9CA3AF; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: 10px; flex-shrink: 0;" onmouseover="this.style.background='#FEE2E2'; this.style.color='#DC2626'" onmouseout="this.style.background='none'; this.style.color='#9CA3AF'">
                <i class="fi-rs-trash" style="font-size: 16px;"></i>
            </button>
        </div>
        
        <!-- Scrollable Content: Messages + Negotiation -->
        <div style="flex: 1; min-height: 0; overflow-y: auto; display: flex; flex-direction: column;">
            <!-- Messages Container -->
            <div id="messagesContainer" style="padding: 16px; background: #F9FAFB; min-height: min-content;">
                <!-- Les messages seront inject√©s ici -->
            </div>
        
            <!-- Negotiation Section (si intention d'achat active) -->
            <div id="negotiationSection" style="display: none; padding: 16px; border-top: 1px solid #E5E7EB; background: #FFF9E6; flex-shrink: 0;">
                <div style="margin-bottom: 12px;">
                    <h5 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 700; color: #1F2937; display: flex; align-items: center; gap: 6px;">
                        <i class="fi-rs-money" style="color: var(--color-orange);"></i>
                        N√©gocier le prix
                    </h5>
                    <p style="margin: 0; font-size: 12px; color: #6B7280;">Proposez un nouveau prix pour cet article</p>
                </div>
                
                <!-- Historique des n√©gociations -->
                <div id="negotiationHistory" style="margin-bottom: 12px; max-height: 200px; overflow-y: auto;">
                    <!-- L'historique sera inject√© ici -->
                </div>
                
                <!-- Formulaire de proposition -->
                <form id="negotiationForm" onsubmit="submitNegotiation(event)" style="display: flex; gap: 8px; align-items: end; margin-bottom: 12px;">
                    <div style="flex: 1;">
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px;">Prix propos√© (FCFA)</label>
                        <input type="number" id="negotiationPrice" placeholder="Ex: 50000" min="1" step="1" required style="width: 100%; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 14px; outline: none; transition: all 0.3s; box-sizing: border-box;" onfocus="this.style.borderColor='var(--color-orange)'" onblur="this.style.borderColor='#E5E7EB'">
                    </div>
                    <button type="submit" style="padding: 10px 16px; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; white-space: nowrap;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <i class="fi-rs-check"></i> Proposer
                    </button>
                </form>
                
                <!-- Bouton pour accepter le prix final -->
                <button id="acceptFinalPriceBtn" style="display: none; width: 100%; padding: 12px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);" onmouseover="this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.5)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)'; this.style.transform='translateY(0)'">
                    <i class="fi-rs-check-circle"></i> Accepter le prix final et proc√©der au paiement
                </button>
            </div>
        </div>
        
        <!-- Section V√©rification de livraison (apr√®s paiement) -->
        <div id="verificationSection" style="display: none; padding: 16px; border-top: 1px solid #E5E7EB; flex-shrink: 0;">
            <!-- Contenu inject√© par JavaScript -->
        </div>
        
        <!-- Message Input (fixe en bas) -->
        <div style="padding: 16px; border-top: 1px solid #E5E7EB; background: white; flex-shrink: 0;">
            <div id="chatHelper" style="display: none; margin-bottom: 8px; font-size: 12px; color: #F97316; font-weight: 600;">Pendant la n√©gociation, proposez un prix dans la section jaune. Le chat libre sera disponible apr√®s accord.</div>
            <form id="messageForm" onsubmit="sendMessage(event)" style="display: flex; gap: 8px;">
                <input type="text" id="messageInput" placeholder="Tapez votre message..." style="flex: 1; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 14px; outline: none; transition: all 0.3s; box-sizing: border-box;" onfocus="this.style.borderColor='var(--color-orange)'" onblur="this.style.borderColor='#E5E7EB'">
                <button type="submit" style="padding: 12px 20px; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i class="fi-rs-paper-plane" style="font-size: 16px;"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.message-bubble {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 16px;
    margin-bottom: 12px;
    word-wrap: break-word;
}

.message-sent {
    background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.message-received {
    background: white;
    color: #1F2937;
    border: 1px solid #E5E7EB;
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

/* Am√©liorer le scroll dans le chatbot */
#activeConversation > div:first-child {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

/* Historique de n√©gociation avec scroll am√©lior√© */
#negotiationHistory {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 123, 44, 0.5) rgba(0, 0, 0, 0.1);
}

/* Style de la scrollbar pour webkit (Chrome, Safari) */
#negotiationHistory::-webkit-scrollbar {
    width: 6px;
}

#negotiationHistory::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
}

#negotiationHistory::-webkit-scrollbar-thumb {
    background: rgba(255, 123, 44, 0.5);
    border-radius: 3px;
}

#negotiationHistory::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 123, 44, 0.7);
}

/* S'assurer que le bouton vert est bien visible */
#acceptFinalPriceBtn {
    position: relative;
    z-index: 10;
}

@media (max-width: 768px) {
    #chatbotPopup {
        width: calc(100vw - 20px);
        height: calc(100vh - 20px);
        bottom: 10px;
        right: 10px;
        border-radius: 16px;
    }
    
    /* R√©duire les paddings sur mobile pour plus d'espace */
    #messagesContainer {
        padding: 12px !important;
    }
    
    #negotiationSection {
        padding: 12px !important;
    }
    
    #negotiationHistory {
        max-height: 150px !important;
    }
}
</style>

<script src="{% static 'accounts/js/negotiation.js' %}?v=3.7"></script>
<script>
// Token CSRF pour les requ√™tes POST (suppression message, etc.)
window.CSRF_TOKEN = "{{ csrf_token }}";
// Variables globales pour la conversation (accessibles depuis negotiation.js)
window.currentProductId = null;
window.currentConversationId = null;
let currentProductId = null;
let currentConversationId = null;
let conversationsData = [];

function openConversationChatbot(productId, conversationId) {
    currentProductId = productId;
    currentConversationId = conversationId;
    window.currentProductId = productId;
    window.currentConversationId = conversationId;
    const popup = document.getElementById('chatbotPopup');
    popup.style.display = 'flex';
    
    // Charger les conversations
    loadConversations(productId);
    
    // Afficher directement la conversation apr√®s chargement
    // Attendre que les conversations soient charg√©es
    const checkAndShowConversation = () => {
        if (conversationId && conversationsData.length > 0) {
            // V√©rifier que la conversation existe dans les donn√©es charg√©es
            const conv = conversationsData.find(c => c.id === conversationId);
            if (conv) {
                showActiveConversation(conversationId);
                return true;
            }
        }
        return false;
    };
    
    // Essayer imm√©diatement
    setTimeout(() => {
        if (!checkAndShowConversation()) {
            // Si la conversation n'existe pas encore, attendre un peu plus et r√©essayer
            setTimeout(() => {
                loadConversations(productId);
                setTimeout(() => {
                    if (!checkAndShowConversation()) {
                        showConversationsList();
                    }
                }, 500);
            }, 1000);
        }
    }, 500);
}

function openChatbot(productId) {
    currentProductId = productId;
    const popup = document.getElementById('chatbotPopup');
    popup.style.display = 'flex';
    
    // Charger les conversations
    loadConversations(productId);
    
    // Afficher la liste des conversations
    showConversationsList();
}

function closeChatbot() {
    const popup = document.getElementById('chatbotPopup');
    popup.style.display = 'none';
    currentProductId = null;
    currentConversationId = null;
    conversationsData = [];
}

function showConversationsList() {
    document.getElementById('conversationsList').style.display = 'flex';
    document.getElementById('activeConversation').style.display = 'none';
    currentConversationId = null;
    if (typeof stopNegotiationPolling === 'function') {
        stopNegotiationPolling();
    }
}

function showActiveConversation(conversationId) {
    document.getElementById('conversationsList').style.display = 'none';
    document.getElementById('activeConversation').style.display = 'flex';
    
    const conversation = conversationsData.find(c => c.id === conversationId);
    if (!conversation) return;
    
    currentConversationId = conversationId;
    document.getElementById('activeConversationBuyer').textContent = conversation.buyer_name;
    
    // Afficher les messages
    displayMessages(conversation.messages);
    // Scroll bas apr√®s affichage
    setTimeout(() => {
        const container = document.getElementById('messagesContainer');
        if (container) container.scrollTop = container.scrollHeight;
    }, 50);
    
    // Charger l'intention d'achat si elle existe avec l'historique des n√©gociations
    if (conversation.product_id && conversation.buyer_id && conversation.seller_id) {
        if (typeof loadPurchaseIntentForConversation === 'function') {
            loadPurchaseIntentForConversation(conversation.product_id, conversation.buyer_id, conversation.seller_id);
        }
    }
    
    // Stocker l'ID utilisateur actuel pour la fonction displayNegotiationHistory
    window.currentUserId = {{ user.id|default:0 }};
    
    // Marquer comme lu
    markConversationAsRead(conversationId);
}

function loadConversations(productId) {
    const loadingDiv = document.getElementById('conversationsLoading');
    const contentDiv = document.getElementById('conversationsContent');
    const noConversationsDiv = document.getElementById('noConversations');
    
    loadingDiv.style.display = 'block';
    contentDiv.style.display = 'none';
    noConversationsDiv.style.display = 'none';
    
    // Construire l'URL absolue sans doublon de slash
    const convBase = "{% url 'accounts:get-product-conversations' 0 %}";
    const apiUrl = convBase.replace('/0/', `/${productId}/`);
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                // Si erreur 404 ou autre, retourner une liste vide
                return { conversations: [] };
            }
            return response.json();
        })
        .then(data => {
            loadingDiv.style.display = 'none';
            conversationsData = data.conversations || [];
            
            // Si on a un conversationId en attente et qu'on vient de charger les conversations, essayer de l'afficher
            if (window.currentConversationId && conversationsData.length > 0) {
                const conv = conversationsData.find(c => c.id === window.currentConversationId);
                if (conv && typeof showActiveConversation === 'function') {
                    setTimeout(() => showActiveConversation(window.currentConversationId), 100);
                    return;
                }
            }
            
            if (conversationsData.length === 0) {
                noConversationsDiv.style.display = 'block';
            } else {
                contentDiv.style.display = 'block';
                displayConversationsList(conversationsData);
            }
        })
        .catch(error => {
            console.error('Error loading conversations:', error);
            loadingDiv.style.display = 'none';
            conversationsData = [];
            noConversationsDiv.style.display = 'block';
        });
}

function displayConversationsList(conversations) {
    const container = document.getElementById('conversationsContent');
    container.innerHTML = '';
    
    conversations.forEach(conv => {
        const item = document.createElement('div');
        item.className = 'conversation-item';
        item.style.cssText = 'background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s; border: 2px solid #E5E7EB;';
        item.onclick = () => showActiveConversation(conv.id);
        item.onmouseover = function() {
            this.style.borderColor = 'var(--color-orange)';
            this.style.boxShadow = '0 4px 12px rgba(255, 123, 44, 0.15)';
            this.style.transform = 'translateY(-2px)';
        };
        item.onmouseout = function() {
            this.style.borderColor = '#E5E7EB';
            this.style.boxShadow = 'none';
            this.style.transform = 'translateY(0)';
        };
        
        const unreadBadge = conv.unread_count > 0 
            ? `<span style="background: #EF4444; color: white; border-radius: 12px; padding: 2px 8px; font-size: 11px; font-weight: 700; margin-left: auto;">${conv.unread_count}</span>`
            : '';
        
        const lastMessage = conv.messages.length > 0 
            ? conv.messages[conv.messages.length - 1].message.substring(0, 50) + (conv.messages[conv.messages.length - 1].message.length > 50 ? '...' : '')
            : 'Aucun message';
        
        item.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                    ${conv.buyer_name.charAt(0).toUpperCase()}
                </div>
                <div style="flex: 1; min-width: 0;">
                    <h4 style="margin: 0; font-size: 15px; font-weight: 700; color: #1F2937;">${conv.buyer_name}</h4>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #6B7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${escapeHtml(lastMessage)}
                    </p>
                </div>
                ${unreadBadge}
            </div>
        `;
        
        container.appendChild(item);
    });
}

function displayMessages(messages) {
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '';
    
    if (!messages || messages.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#9CA3AF;">Aucun message</p>';
        return;
    }
    
    messages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message-bubble ${msg.is_sender ? 'message-sent' : 'message-received'}`;
        msgDiv.style.display = 'flex';
        msgDiv.style.flexDirection = 'column';
        msgDiv.style.alignItems = msg.is_sender ? 'flex-end' : 'flex-start';
        
        const deleteBtn = msg.is_sender
            ? `<button type="button" onclick="event.stopPropagation(); deleteMessage(${msg.id})" title="Supprimer ce message" style="margin-top:8px; padding:4px 10px; background:rgba(255,255,255,0.25); border:none; border-radius:8px; color:white; font-size:11px; cursor:pointer; display:inline-flex; align-items:center; gap:4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.4)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'"><i class="fi-rs-trash" style="font-size:11px;"></i> Supprimer</button>`
            : '';
        msgDiv.innerHTML = `
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">
                ${msg.sender || ''} ${msg.created_at ? '¬∑ ' + msg.created_at : ''}
            </div>
            <div style="font-size: 14px; line-height: 1.5; word-break: break-word;">${escapeHtml(msg.message)}</div>
            ${deleteBtn}
        `;
        
        container.appendChild(msgDiv);
    });
    
    // Scroll vers le bas (apr√®s rendu)
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 50);
}

function deleteMessage(messageId) {
    if (typeof GMModal !== 'undefined' && GMModal.show) {
        GMModal.show({
            type: 'warning',
            title: 'Supprimer le message',
            message: '√ätes-vous s√ªr de vouloir supprimer ce message ?',
            showCancel: true,
            confirmText: 'Supprimer',
            cancelText: 'Annuler',
            onConfirm: function() {
                doDeleteMessage(messageId);
            }
        });
    } else if (confirm('Supprimer ce message ?')) {
        doDeleteMessage(messageId);
    }
}
function doDeleteMessage(messageId) {
    const csrfToken = getCookie('csrftoken') || (typeof window.CSRF_TOKEN !== 'undefined' ? window.CSRF_TOKEN : '');
    const deleteUrl = "{% url 'accounts:delete-product-message' 0 %}".replace('/0/', `/${messageId}/`);
    fetch(deleteUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => {
        return response.json().then(data => ({ ok: response.ok, status: response.status, data: data }));
    })
    .then(({ ok, status, data }) => {
        if (ok && data.success && currentConversationId && typeof showActiveConversation === 'function') {
            showActiveConversation(currentConversationId);
        } else if (!ok || data.error) {
            const errMsg = (data && data.error) ? data.error : ('Erreur serveur (' + status + ')');
            if (typeof GMModal !== 'undefined' && GMModal.error) GMModal.error('Erreur', errMsg);
            else alert(errMsg);
        }
    })
    .catch(e => {
        console.error(e);
        if (typeof GMModal !== 'undefined' && GMModal.error) GMModal.error('Erreur', 'Erreur lors de la suppression');
        else alert('Erreur lors de la suppression');
    });
}

function deleteConversation(conversationId, otherUserName) {
    const msg = 'Supprimer toute la conversation avec ' + (otherUserName || 'cet utilisateur') + ' ? Les messages seront d√©finitivement effac√©s.';
    if (typeof GMModal !== 'undefined' && GMModal.show) {
        GMModal.show({
            type: 'warning',
            title: 'Supprimer la conversation',
            message: msg,
            showCancel: true,
            confirmText: 'Supprimer',
            cancelText: 'Annuler',
            onConfirm: function() {
                doDeleteConversation(conversationId);
            }
        });
    } else if (confirm(msg)) {
        doDeleteConversation(conversationId);
    }
}
function deleteConversationFromPopup() {
    if (currentConversationId) {
        const conv = conversationsData.find(c => c.id === currentConversationId);
        deleteConversation(currentConversationId, conv ? conv.buyer_name : null);
    }
}
function doDeleteConversation(conversationId) {
    fetch(`/delete-conversation/${conversationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeChatbot();
            location.reload();
        } else if (data.error && typeof GMModal !== 'undefined' && GMModal.error) {
            GMModal.error('Erreur', data.error);
        }
    })
    .catch(e => {
        console.error(e);
        if (typeof GMModal !== 'undefined' && GMModal.error) GMModal.error('Erreur', 'Erreur lors de la suppression');
    });
}

function sendMessage(event) {
    event.preventDefault();
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || !currentConversationId) return;
    
    const conversation = conversationsData.find(c => c.id === currentConversationId);
    if (!conversation) {
        GMModal.error('Erreur', 'Conversation introuvable');
        return;
    }
    
    // Utiliser le product_id de la conversation (ou 0 si non disponible - le backend utilisera conversation_id)
    const productId = conversation.product_id || currentProductId || 0;
    
    // Envoyer le message - URL sans pr√©fixe /accounts car accounts.urls mont√© √† la racine
    fetch(`/send-product-message/${productId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            conversation_id: currentConversationId,
            message: message
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Erreur lors de l\'envoi');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            input.value = '';
            // Recharger les conversations
            loadConversations(productId);
            // R√©afficher la conversation active
            setTimeout(() => showActiveConversation(currentConversationId), 300);
        } else {
            GMModal.error('Envoi √©chou√©', data.error || 'Le message n\'a pas pu √™tre envoy√©.');
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        GMModal.error('Erreur', error.message || 'Erreur lors de l\'envoi du message');
    });
}

function markConversationAsRead(conversationId) {
    const baseMarkUrl = "{% url 'accounts:mark-conversation-read' 0 %}";
    const markUrl = baseMarkUrl.replace('/0/', `/${conversationId}/`);
    fetch(markUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) return null;
        try { return response.json(); } catch (e) { return null; }
    })
    .then(data => {
        if (data && data.success) {
            updateMessageBadges();
        }
    })
    .catch(err => console.error('Error marking conversation read:', err));
}

function updateMessageBadges() {
    // Mise √† jour l√©g√®re : recharger les conversations pour les badges sans recharger la page
    if (currentProductId && typeof loadConversations === 'function') {
        loadConversations(currentProductId);
    }
}

/**
 * Active/d√©sactive la zone de saisie libre selon le statut de l'intention.
 * Pendant la n√©gociation (PENDING/NEGOTIATING), on force la saisie par le champ de prix uniquement.
 * Apr√®s paiement (PAID), on r√©active le chat libre.
 */
function updateChatControls(intentData) {
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.querySelector('#messageForm button[type="submit"]');
    const helper = document.getElementById('chatHelper');
    
    if (!messageInput || !sendBtn || !helper) return;
    
    const status = intentData && intentData.status ? intentData.status : null;
    const orderStatus = intentData ? intentData.order_status : null;
    const isAgreed = status === 'agreed';
    const isPaid = orderStatus && ['paid', 'pending_delivery', 'delivered', 'verified', 'completed'].includes(orderStatus);
    const isCompleted = orderStatus === 'completed';
    
    if (isCompleted) {
        // Transaction termin√©e ‚Üí D√âSACTIVER le chat compl√®tement
        messageInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5';
        sendBtn.style.cursor = 'not-allowed';
        messageInput.placeholder = "Transaction termin√©e - Le chat est d√©sactiv√©";
        helper.style.display = 'block';
        helper.innerHTML = 'üéâ Transaction termin√©e avec succ√®s ! Le chat est maintenant ferm√©.';
        helper.style.color = '#059669';
    } else if (isPaid) {
        // Paiement effectu√© mais pas termin√© ‚Üí activer le chat libre
        messageInput.disabled = false;
        sendBtn.disabled = false;
        sendBtn.style.opacity = '1';
        sendBtn.style.cursor = 'pointer';
        messageInput.placeholder = "Discutez du lieu et de l'heure de rencontre...";
        helper.style.display = 'block';
        helper.innerHTML = 'üí¨ Paiement confirm√© ! √âchangez pour convenir du lieu et de l\'heure de remise.';
        helper.style.color = '#2563EB';
    } else if (isAgreed) {
        // Prix accept√© mais pas pay√© ‚Üí bloquer tout
        messageInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5';
        sendBtn.style.cursor = 'not-allowed';
        messageInput.placeholder = "‚è≥ En attente du paiement...";
        helper.style.display = 'block';
        const currentUserId = window.currentUserId || 0;
        const isBuyer = intentData && intentData.buyer_id === currentUserId;
        helper.innerHTML = isBuyer 
            ? '‚úÖ Prix accept√© ! Cliquez sur le bouton vert pour proc√©der au paiement.'
            : '‚úÖ Prix accept√© ! En attente du paiement de l\'acheteur.';
        helper.style.color = '#10B981';
    } else {
        // N√©gociation en cours ‚Üí bloquer le chat libre
        messageInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5';
        sendBtn.style.cursor = 'not-allowed';
        messageInput.placeholder = "La discussion libre sera disponible apr√®s le paiement";
        helper.style.display = 'block';
        helper.innerHTML = 'üìù Utilisez le formulaire ci-dessus pour n√©gocier le prix';
        helper.style.color = '#6B7280';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ouvrir automatiquement le chatbot si c'est une proposition d'offre
document.addEventListener('DOMContentLoaded', function() {
    {% if auto_open_product_id and auto_open_conversation_id %}
    setTimeout(function() {
        if (typeof openConversationChatbot === 'function') {
            openConversationChatbot({{ auto_open_product_id }}, {{ auto_open_conversation_id }});
        }
    }, 500);
    {% endif %}
});

function acceptPurchaseIntent(intentId) {
    GMModal.show({
        type: 'confirm',
        title: 'Accepter l\'intention d\'achat',
        message: '√ätes-vous s√ªr de vouloir accepter cette intention d\'achat ? Vous pourrez ensuite n√©gocier le prix.',
        showCancel: true,
        confirmText: 'Accepter',
        cancelText: 'Annuler',
        onConfirm: function() {
            fetch(`/c2c/purchase-intent/${intentId}/accept/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Ouvrir automatiquement le chatbot avec la conversation pour d√©marrer la n√©gociation
                    if (data.product_id) {
                        // Attendre un peu pour que la conversation soit cr√©√©e c√¥t√© serveur
                        setTimeout(() => {
                            openConversationChatbot(data.product_id, data.conversation_id || null);
                        }, 500);
                    } else {
                        GMModal.success('Accept√©e !', 'Intention d\'achat accept√©e ! Vous pouvez maintenant n√©gocier le prix.', () => location.reload());
                    }
                } else {
                    GMModal.error('Erreur', data.error || 'Erreur lors de l\'acceptation');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                GMModal.error('Erreur', 'Erreur lors de l\'acceptation');
            });
        }
    });
}

function rejectPurchaseIntent(intentId) {
    GMModal.confirm(
        'Refuser l\'intention d\'achat',
        '√ätes-vous s√ªr de vouloir refuser cette intention d\'achat ?',
        function() {
            fetch(`/c2c/purchase-intent/${intentId}/reject/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    GMModal.success('Refus√©e', 'Intention d\'achat refus√©e.', () => location.reload());
                } else {
                    GMModal.error('Erreur', data.error || 'Erreur lors du refus');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                GMModal.error('Erreur', 'Erreur lors du refus');
            });
        }
    );
}

function cancelPurchaseIntent(intentId) {
    GMModal.show({
        type: 'warning',
        title: 'Supprimer l\'intention d\'achat',
        message: '√ätes-vous s√ªr de vouloir supprimer cette intention d\'achat ? Cette action est d√©finitive.',
        showCancel: true,
        confirmText: 'Supprimer',
        cancelText: 'Annuler',
        onConfirm: function() {
            fetch(`/c2c/purchase-intent/${intentId}/cancel/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    GMModal.success('Supprim√©e', 'Intention d\'achat supprim√©e.', () => location.reload());
                } else {
                    GMModal.error('Erreur', data.error || 'Erreur lors de la suppression');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                GMModal.error('Erreur', 'Erreur lors de la suppression');
            });
        }
    });
}

// Le CSS mobile-first g√®re maintenant le responsive nativement
// Plus besoin de JavaScript pour forcer les styles
</script>

{% endblock %}
