{% extends 'base.html' %}
{% load static %}
{% load cart_template_tags %}
{% load category_icons %}

{%block body%}
<style>
    /* Styles pour la page de détails article C2C */
    .flavoriz-product-detail {
        padding: 24px 0 60px 0;
        background: #FAFAFA;
        min-height: calc(100vh - 200px);
    }
    
    .flavoriz-product-detail-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    
    .flavoriz-breadcrumb {
        margin-bottom: 24px;
        font-size: 13px;
        color: #6B7280;
    }
    
    .flavoriz-breadcrumb a {
        color: var(--color-orange);
        text-decoration: none;
        transition: color 0.2s ease;
    }
    
    .flavoriz-breadcrumb a:hover {
        color: #E65A1F;
    }
    
    .flavoriz-product-detail-main {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 32px;
    }
    
    .flavoriz-product-detail-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        padding: 24px;
    }
    
    .flavoriz-product-gallery {
        position: relative;
    }
    
    .flavoriz-main-image {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        background: #FAFAFA;
        margin-bottom: 16px;
        cursor: zoom-in;
        position: relative;
    }
    
    .flavoriz-main-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .flavoriz-main-image:hover img {
        transform: scale(1.05);
    }
    
    .flavoriz-thumbnails {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }
    
    .flavoriz-thumbnail {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        background: #FAFAFA;
    }
    
    .flavoriz-thumbnail.active {
        border-color: var(--color-orange);
    }
    
    .flavoriz-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .flavoriz-product-info h1 {
        font-size: 24px;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 12px;
        line-height: 1.3;
    }
    
    .flavoriz-product-price-section {
        margin-bottom: 24px;
    }
    
    .flavoriz-current-price {
        font-size: 28px;
        font-weight: 700;
        color: var(--color-orange);
    }
    
    .flavoriz-product-description {
        color: #4B5563;
        line-height: 1.8;
        margin-bottom: 24px;
        font-size: 14px;
    }
    
    .flavoriz-peer-badge {
        display: inline-block;
        padding: 6px 12px;
        background: linear-gradient(135deg, rgba(255, 123, 44, 0.1) 0%, rgba(255, 123, 44, 0.05) 100%);
        color: var(--color-orange);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
    }
    
    .flavoriz-seller-info {
        background: #F9FAFB;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
    }
    
    .flavoriz-seller-info h3 {
        font-size: 15px;
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 12px;
    }
    
    .flavoriz-seller-detail {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        font-size: 14px;
        color: #4B5563;
    }
    
    .flavoriz-seller-detail i {
        color: var(--color-orange);
        width: 20px;
    }
    
    .flavoriz-contact-seller-btn {
        width: 100%;
        padding: 14px 28px;
        background: var(--color-orange);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3);
        margin-top: 16px;
    }
    
    .flavoriz-contact-seller-btn:hover {
        background: #E65A1F;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 123, 44, 0.4);
    }
    
    /* Style Ayoka listing - bloc Détails de l'annonce */
    .ayoka-listing-infos {
        background: #FFFFFF;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 24px;
    }
    .ayoka-listing-infos .ayoka-infos-title {
        font-size: 15px;
        font-weight: 700;
        color: #1F2937;
        padding: 16px 20px;
        background: #F9FAFB;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .ayoka-listing-infos .ayoka-infos-title i {
        color: var(--color-orange);
        font-size: 18px;
    }
    .ayoka-infos-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    .ayoka-infos-list li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        border-bottom: 1px solid #F3F4F6;
        font-size: 14px;
    }
    .ayoka-infos-list li:last-child {
        border-bottom: none;
    }
    .ayoka-infos-list .ayoka-infos-label {
        color: #6B7280;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .ayoka-infos-list .ayoka-infos-label i {
        color: #9CA3AF;
        font-size: 16px;
        width: 20px;
        text-align: center;
    }
    .ayoka-infos-list .ayoka-infos-value {
        color: #1F2937;
        font-weight: 600;
    }
    .ayoka-infos-list .ayoka-infos-value.status-ok {
        color: #059669;
    }
    
    .flavoriz-product-meta {
        display: none; /* Remplacé par ayoka-listing-infos */
    }
    
    .flavoriz-meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .flavoriz-meta-label {
        font-size: 12px;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .flavoriz-meta-value {
        font-size: 15px;
        color: #1F2937;
        font-weight: 600;
    }
    
    /* Bloc Description style Ayoka */
    .ayoka-description-block {
        background: #FFFFFF;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 24px;
    }
    .ayoka-description-block .ayoka-infos-title {
        font-size: 15px;
        font-weight: 700;
        color: #1F2937;
        padding: 16px 20px;
        background: #F9FAFB;
        border-bottom: 1px solid #E5E7EB;
    }
    .ayoka-description-block .ayoka-description-body {
        padding: 20px;
        color: #4B5563;
        line-height: 1.8;
        font-size: 14px;
    }
    
    /* Cartes Vendeur & Détails (style moderne + grille 2x2) */
    .peer-card {
        background: linear-gradient(145deg, #FFFFFF 0%, #F9FAFB 100%);
        border: 1px solid #E5E7EB;
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }
    .peer-card-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, rgba(255, 123, 44, 0.08) 0%, rgba(255, 123, 44, 0.03) 100%);
        border-bottom: 1px solid #E5E7EB;
        font-size: 16px;
        font-weight: 700;
        color: #1F2937;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .peer-card-header i {
        color: var(--color-orange);
        font-size: 20px;
    }
    .peer-card-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0;
    }
    .peer-card-cell {
        padding: 16px 20px;
        border-bottom: 1px solid #F3F4F6;
        border-right: 1px solid #F3F4F6;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .peer-card-cell:nth-child(2n) { border-right: none; }
    .peer-card-cell:nth-last-child(-n+2) { border-bottom: none; }
    .peer-card-label {
        font-size: 12px;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    .peer-card-value {
        font-size: 15px;
        font-weight: 600;
        color: #1F2937;
    }
    .peer-card-value.status-ok { color: #059669; }
    .peer-card-cta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px 20px;
        background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%);
        color: white;
        text-decoration: none;
        font-weight: 600;
        font-size: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(255, 123, 44, 0.25);
    }
    .peer-card-cta:hover { color: white; opacity: 0.95; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(255, 123, 44, 0.35); }
    .flavoriz-propose-offer-btn-top:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(255, 123, 44, 0.45); }
    
    /* Modal vendeur : toujours centré (desktop + mobile) */
    .peer-seller-modal-backdrop {
        display: none;
        position: fixed;
        inset: 0;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 9998;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    .peer-seller-modal-backdrop.is-open { display: flex !important; }
    .peer-seller-modal {
        background: white;
        border-radius: 20px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        overflow: hidden;
        margin: auto;
        flex-shrink: 0;
    }
    .peer-seller-modal-header {
        padding: 24px 24px 16px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .peer-seller-modal-header h3 { margin: 0; font-size: 20px; font-weight: 700; color: #1F2937; }
    .peer-seller-modal-close {
        background: none; border: none; padding: 8px; cursor: pointer; color: #6B7280; font-size: 24px; line-height: 1;
    }
    .peer-seller-modal-close:hover { color: #1F2937; }
    .peer-seller-modal-body {
        padding: 24px;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    .peer-seller-modal-stat {
        background: #F9FAFB;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
    }
    .peer-seller-modal-stat .val { font-size: 22px; font-weight: 700; color: var(--color-orange); display: block; margin-bottom: 4px; }
    .peer-seller-modal-stat .lbl { font-size: 12px; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; }
    .peer-seller-modal-footer {
        padding: 16px 24px 24px;
    }
    .peer-seller-modal-footer a {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        padding: 14px 24px; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%);
        color: white; text-decoration: none; font-weight: 600; border-radius: 12px;
        transition: all 0.3s ease; box-shadow: 0 4px 14px rgba(255, 123, 44, 0.3);
    }
    .peer-seller-modal-footer a:hover { color: white; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 123, 44, 0.4); }
    
    /* Mode smartphone : même disposition (titre + bouton à droite, grilles 2x2, modal adapté) */
    @media (max-width: 600px) {
        .flavoriz-product-info h1 { font-size: 18px !important; line-height: 1.35; }
        .flavoriz-product-title-row {
            flex-direction: row !important;
            align-items: center !important;
            gap: 12px !important;
        }
        .flavoriz-propose-offer-btn-top {
            padding: 10px 14px !important;
            font-size: 13px !important;
            white-space: nowrap !important;
        }
        .flavoriz-propose-offer-btn-top i { font-size: 16px !important; }
        .peer-card { border-radius: 14px; margin-bottom: 20px; }
        .peer-card-header { padding: 14px 16px; font-size: 15px; }
        .peer-card-header i { font-size: 18px; }
        .peer-card-grid { grid-template-columns: repeat(2, 1fr) !important; }
        .peer-card-cell { padding: 12px 14px; gap: 4px; }
        .peer-card-label { font-size: 11px; }
        .peer-card-value { font-size: 14px; }
        .peer-card-cta { padding: 14px 16px; font-size: 14px; }
        .peer-seller-modal-backdrop {
            padding: 12px;
            align-items: center !important;
            justify-content: center !important;
        }
        .peer-seller-modal-backdrop.is-open {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .peer-seller-modal {
            max-height: min(85vh, 90%);
            overflow-y: auto;
            border-radius: 16px;
            margin: auto !important;
        }
        .peer-seller-modal-header { padding: 20px 20px 14px; }
        .peer-seller-modal-header h3 { font-size: 18px; }
        .peer-seller-modal-body { padding: 20px; gap: 12px; grid-template-columns: repeat(2, 1fr); }
        .peer-seller-modal-stat { padding: 12px; }
        .peer-seller-modal-stat .val { font-size: 18px; }
        .peer-seller-modal-footer { padding: 14px 20px 20px; }
        .peer-seller-modal-footer a { padding: 12px 20px; font-size: 15px; }
    }
    
    .flavoriz-related-products {
        margin-top: 48px;
    }
    
    .flavoriz-section-title {
        font-size: 24px;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 24px;
    }
    
    @media (max-width: 968px) {
        .flavoriz-product-detail-content {
            grid-template-columns: 1fr;
            gap: 24px;
            padding: 20px;
        }
        
        .flavoriz-product-meta {
            grid-template-columns: 1fr;
        }
    }
</style>

<main class="main">
    <div class="flavoriz-product-detail">
        <div class="flavoriz-product-detail-container">
            <!-- Breadcrumb -->
            <div class="flavoriz-breadcrumb">
                <a href="{%url 'home:index'%}"><i class="fi-rs-home"></i> Accueil</a>
                <span> / </span>
                <a href="{% url 'categories:shop' %}">Boutique</a>
                <span> / </span>
                {% if peer_product.product_supercategory %}
                <a href="{% url 'categories:super-category' peer_product.product_supercategory.slug%}">{{peer_product.product_supercategory}}</a>
                <span> / </span>
                {% endif %}
                <span>{{peer_product.product_name|truncatechars:40}}</span>
            </div>
            
            <!-- Messages -->
            {% if messages %}
            {% for message in messages %}
            <div class="mt-20 alert align-middle alert-{{message.tags}}" style="padding: 12px 20px; border-radius: 8px; margin-bottom: 20px;">
                <span class="align-middle">{{message}}</span>
            </div>
            {% endfor %}
            {% endif %}
            
            <!-- Main Product Detail Card -->
            <div class="flavoriz-product-detail-main">
                <div class="flavoriz-product-detail-content">
                    <!-- Gallery -->
                    <div class="flavoriz-product-gallery">
                        <div class="flavoriz-main-image" id="main-image-container" style="cursor: zoom-in;">
                            {%if peer_product.product_image%}
                            <img src="{{peer_product.product_image.url}}" alt="{{peer_product.product_name}}" id="main-product-image" onclick="openPeerProductImagePreview()" />
                            {%else%}
                            <img src="{% static 'assets/imgs/shop/product-16-3.jpg'%}" alt="{{peer_product.product_name}}" id="main-product-image" onclick="openPeerProductImagePreview()" />
                            {%endif%}
                        </div>
                        
                        {% if peer_product.additional_image_1 or peer_product.additional_image_2 or peer_product.additional_image_3 %}
                        <div class="flavoriz-thumbnails">
                            {% if peer_product.product_image %}
                            <div class="flavoriz-thumbnail active" onclick="changeMainImage('{{peer_product.product_image.url}}', this)">
                                <img src="{{peer_product.product_image.url}}" alt="Thumbnail 1" />
                            </div>
                            {% endif %}
                            {% if peer_product.additional_image_1 %}
                            <div class="flavoriz-thumbnail {% if not peer_product.product_image and forloop.first %}active{% endif %}" onclick="changeMainImage('{{peer_product.additional_image_1.url}}', this)">
                                <img src="{{peer_product.additional_image_1.url}}" alt="Thumbnail 2" />
                            </div>
                            {% endif %}
                            {% if peer_product.additional_image_2 %}
                            <div class="flavoriz-thumbnail" onclick="changeMainImage('{{peer_product.additional_image_2.url}}', this)">
                                <img src="{{peer_product.additional_image_2.url}}" alt="Thumbnail 3" />
                            </div>
                            {% endif %}
                            {% if peer_product.additional_image_3 %}
                            <div class="flavoriz-thumbnail" onclick="changeMainImage('{{peer_product.additional_image_3.url}}', this)">
                                <img src="{{peer_product.additional_image_3.url}}" alt="Thumbnail 4" />
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Product Info (style Ayoka listing) -->
                    <div class="flavoriz-product-info">
                        {% if peer_product.condition %}
                        <span class="peer-condition-badge peer-condition-{{ peer_product.condition|condition_slug }}" style="margin-bottom: 12px; vertical-align: middle;">{{ peer_product.get_condition_display }}</span>
                        {% endif %}
                        <div class="flavoriz-product-title-row" style="display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; margin-bottom: 12px;">
                            <h1 style="flex: 1; min-width: 0; margin: 0;">{{ peer_product.product_name }}</h1>
                            {% if user.id != peer_product.seller.id %}
                            <button type="button" id="peer-propose-offer-btn-top" onclick="proposeOfferToSeller({{ peer_product.id }}, '{{ peer_product.PRDSlug }}', {{ peer_product.PRDPrice|floatformat:0 }})" class="flavoriz-propose-offer-btn-top" style="flex-shrink: 0; padding: 12px 20px; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 14px rgba(255, 123, 44, 0.35); transition: all 0.3s ease; white-space: nowrap;">
                                <i class="fi-rs-comment" style="font-size: 18px;"></i>
                                <span>Proposer une offre</span>
                            </button>
                            {% endif %}
                        </div>
                        
                        <div class="flavoriz-product-price-section">
                            <div style="display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap;">
                                <span class="flavoriz-current-price">{{peer_product.PRDPrice|format_price}} FCFA</span>
                            </div>
                        </div>
                        
                        <!-- Bloc Description (style Ayoka) -->
                        <div class="ayoka-description-block">
                            <div class="ayoka-infos-title">
                                <i class="fi-rs-document"></i>
                                <span>Description</span>
                            </div>
                            <div class="ayoka-description-body">
                                {{peer_product.product_description|safe|linebreaks}}
                            </div>
                        </div>
                        
                        <!-- Bloc Vendeur (grille 2x2 + style moderne) -->
                        <div class="peer-card peer-card-seller">
                            <div class="peer-card-header">
                                <i class="fi-rs-user"></i>
                                <span>Vendeur</span>
                            </div>
                            <div class="peer-card-grid">
                                <div class="peer-card-cell">
                                    <span class="peer-card-label">Vendeur</span>
                                    <button type="button" class="peer-seller-name-btn" onclick="openSellerModal()" style="background: none; border: none; padding: 0; color: var(--color-orange); font-weight: 600; cursor: pointer; font-size: 15px; text-align: left; display: inline-flex; align-items: center; gap: 6px;">
                                        {{ peer_product.seller.username }}
                                        <i class="fi-rs-angle-right" style="font-size: 14px; opacity: 0.8;"></i>
                                    </button>
                                </div>
                                <div class="peer-card-cell">
                                    <span class="peer-card-label">Ville</span>
                                    <span class="peer-card-value"><i class="fi-rs-marker" style="margin-right: 6px; color: var(--color-orange);"></i>{{ peer_product.seller_city|default:"—" }}</span>
                                </div>
                                <div class="peer-card-cell">
                                    <span class="peer-card-label">Note</span>
                                    <span class="peer-card-value"><i class="fi-rs-star" style="color: #FFD700; margin-right: 4px;"></i>{{ seller_stats.average_rating|floatformat:1|default:"0" }}/5</span>
                                </div>
                                <div class="peer-card-cell">
                                    <span class="peer-card-label">Avis reçus</span>
                                    <span class="peer-card-value">{{ seller_stats.total_reviews|default:0 }}</span>
                                </div>
                            </div>
                            <a href="{% url 'c2c:seller-profile' peer_product.seller.id %}" class="peer-card-cta">
                                <i class="fi-rs-user-check"></i>
                                <span>Voir le profil</span>
                            </a>
                        </div>
                        
                        <!-- Détails de l'annonce (grille 2x2 + style moderne) -->
                        <div class="peer-card peer-card-details">
                            <div class="peer-card-header">
                                <i class="fi-rs-info"></i>
                                <span>Détails de l'annonce</span>
                            </div>
                            <div class="peer-card-grid">
                                <div class="peer-card-cell">
                                    <span class="peer-card-label">Catégorie</span>
                                    <span class="peer-card-value">{{ peer_product.product_supercategory|default:"—" }}</span>
                                </div>
                                <div class="peer-card-cell">
                                    <span class="peer-card-label">Sous-catégorie</span>
                                    <span class="peer-card-value">{{ peer_product.product_subcategory|default:"—" }}</span>
                                </div>
                                <div class="peer-card-cell">
                                    <span class="peer-card-label">Date de publication</span>
                                    <span class="peer-card-value">{{ peer_product.date|date:"d/m/Y" }}</span>
                                </div>
                                <div class="peer-card-cell">
                                    <span class="peer-card-label">Statut</span>
                                    <span class="peer-card-value status-ok">Approuvé</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal infos vendeur -->
            <div id="seller-modal-backdrop" class="peer-seller-modal-backdrop" onclick="closeSellerModal(event)">
                <div class="peer-seller-modal" onclick="event.stopPropagation()">
                    <div class="peer-seller-modal-header">
                        <h3>{{ peer_product.seller.username }}</h3>
                        <button type="button" class="peer-seller-modal-close" onclick="closeSellerModal()" aria-label="Fermer">&times;</button>
                    </div>
                    <div class="peer-seller-modal-body">
                        <div class="peer-seller-modal-stat">
                            <span class="val">{{ seller_stats.average_rating|floatformat:1|default:"0" }}/5</span>
                            <span class="lbl">Note</span>
                        </div>
                        <div class="peer-seller-modal-stat">
                            <span class="val">{{ seller_products_count|default:0 }}</span>
                            <span class="lbl">Articles publiés</span>
                        </div>
                        <div class="peer-seller-modal-stat">
                            <span class="val">{{ seller_stats.total_reviews|default:0 }}</span>
                            <span class="lbl">Avis reçus</span>
                        </div>
                        <div class="peer-seller-modal-stat">
                            <span class="val" style="font-size: 16px;"><i class="fi-rs-marker" style="font-size: 14px; color: var(--color-orange); margin-right: 4px;"></i>{{ peer_product.seller_city|default:"—" }}</span>
                            <span class="lbl">Ville</span>
                        </div>
                    </div>
                    <div class="peer-seller-modal-footer">
                        <a href="{% url 'c2c:seller-profile' peer_product.seller.id %}">
                            <i class="fi-rs-user-check"></i>
                            <span>Voir le profil</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Similar Products -->
            {% if similar_products %}
            <div class="flavoriz-related-products">
                <h2 class="flavoriz-section-title">Articles similaires</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    {% for similar in similar_products %}
                    <div class="flavoriz-product-card" style="cursor: pointer; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: all 0.3s ease;" onclick="window.location.href='{% url 'accounts:peer-product-details' similar.PRDSlug %}'">
                        <div style="position: relative; overflow: hidden; background: #FAFAFA; width: 100%; padding-top: 72%;">
                            <img src="{{similar.product_image.url}}" alt="{{similar.product_name}}" loading="lazy" decoding="async" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" />
                        </div>
                        <div style="padding: 14px;">
                            <h3 style="font-size: 14px; font-weight: 600; color: #1F2937; margin: 0 0 10px 0; line-height: 1.4; min-height: 40px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{similar.product_name}}</h3>
                            <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 18px; font-weight: 700; color: var(--color-orange);">{{similar.PRDPrice|format_price}} FCFA</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</main>

<script>
// Construire la liste des images pour le zoom
const peerProductImages = [
    {% if peer_product.product_image %}'{{peer_product.product_image.url}}'{% endif %}
    {% if peer_product.additional_image_1 %}{% if peer_product.product_image %},{% endif %}'{{peer_product.additional_image_1.url}}'{% endif %}
    {% if peer_product.additional_image_2 %},'{{peer_product.additional_image_2.url}}'{% endif %}
    {% if peer_product.additional_image_3 %},'{{peer_product.additional_image_3.url}}'{% endif %}
].filter(img => img); // Filtrer les valeurs vides

let currentImageIndex = 0;

function changeMainImage(imageUrl, thumbnailElement) {
    const mainImage = document.getElementById('main-product-image');
    if (mainImage) {
        mainImage.src = imageUrl;
        // Mettre à jour l'index de l'image actuelle
        currentImageIndex = peerProductImages.indexOf(imageUrl);
        if (currentImageIndex === -1) currentImageIndex = 0;
    }
    
    // Mettre à jour les thumbnails actifs
    const thumbnails = document.querySelectorAll('.flavoriz-thumbnail');
    thumbnails.forEach(thumb => thumb.classList.remove('active'));
    if (thumbnailElement) {
        thumbnailElement.classList.add('active');
    }
}

// Fonction pour ouvrir le zoom d'image
function openPeerProductImagePreview() {
    if (typeof openImagePreview === 'function' && peerProductImages.length > 0) {
        openImagePreview(peerProductImages, currentImageIndex, '{{peer_product.product_name|escapejs}}');
    } else {
        // Fallback si openImagePreview n'est pas disponible
        const mainImage = document.getElementById('main-product-image');
        if (mainImage) {
            window.open(mainImage.src, '_blank');
        }
    }
}

// Fonction pour ajouter le produit peer-to-peer au panier
function addPeerProductToCart() {
    const productId = 'peer_{{peer_product.id}}';
    // Le prix doit être un nombre, pas une chaîne
    const productPrice = {{peer_product.PRDPrice|floatformat:0}};
    const qty = 1;
    
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('qyt', qty);
    formData.append('product_Price', productPrice);
    
    // Récupérer le token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        GMModal.error('Erreur', 'Token de sécurité non trouvé. Veuillez recharger la page.');
        return;
    }
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    const addBtn = document.getElementById('peer-add-to-cart-btn');
    if (addBtn) {
        addBtn.disabled = true;
        addBtn.style.opacity = '0.6';
    }
    
    fetch('{% url "orders:add-to-cart" %}', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        // Vérifier le type de contenu avant de parser
        const contentType = response.headers.get('content-type');
        
        // Si ce n'est pas du JSON, c'est probablement une redirection HTML
        if (!contentType || !contentType.includes('application/json')) {
            // Si le statut est OK mais pas JSON, rediriger vers le panier
            if (response.ok) {
                window.location.href = '{% url "orders:cart" %}';
                return null;
            } else {
                // Si erreur HTTP, essayer de lire le texte pour voir l'erreur
                return response.text().then(text => {
                    throw new Error('Réponse non-JSON: ' + text.substring(0, 200));
                });
            }
        }
        
        // Vérifier si la réponse est OK
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Erreur HTTP: ' + response.status);
            }).catch(() => {
                throw new Error('Erreur HTTP: ' + response.status);
            });
        }
        
        return response.json();
    })
    .then(data => {
        if (!data) return; // Déjà redirigé
        
        if (data.success) {
            // Rediriger vers le panier
            window.location.href = '{% url "orders:cart" %}';
        } else {
            if (data.requires_login) {
                window.location.href = '{% url "accounts:login" %}';
            } else {
                GMModal.error('Erreur', data.error || 'Erreur lors de l\'ajout au panier');
                if (addBtn) {
                    addBtn.disabled = false;
                    addBtn.style.opacity = '1';
                }
            }
        }
    })
    .catch(error => {
        console.error('Erreur détaillée:', error);
        const errorMessage = error.message || 'Erreur lors de l\'ajout au panier. Veuillez réessayer.';
        GMModal.error('Erreur', errorMessage);
        if (addBtn) {
            addBtn.disabled = false;
            addBtn.style.opacity = '1';
        }
    });
}

// Fonction pour proposer une offre au vendeur (remplace addPeerProductToCart)
function proposeOfferToSeller(productId, productSlug, productPrice) {
    {% if not user.is_authenticated %}
    // Rediriger vers la page de connexion
    window.location.href = '{% url "accounts:login" %}?next=' + encodeURIComponent(window.location.pathname);
    return;
    {% endif %}
    
    {% if user.is_authenticated %}
    // Vérifier si l'utilisateur n'est pas le vendeur
    {% if user.id == peer_product.seller.id %}
    GMModal.warning('Action non autorisée', 'Vous ne pouvez pas proposer une offre pour votre propre article.');
    return;
    {% endif %}
    {% endif %}
    
    // Rediriger vers la création d'intention d'achat C2C
    const createIntentUrl = '{% url "c2c:create-purchase-intent" 0 %}'.replace('0', productId);
    window.location.href = createIntentUrl;
}

function openSellerModal() {
    document.getElementById('seller-modal-backdrop').classList.add('is-open');
    document.body.style.overflow = 'hidden';
}
function closeSellerModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('seller-modal-backdrop').classList.remove('is-open');
    document.body.style.overflow = '';
}

// Initialiser l'index de l'image actuelle au chargement
document.addEventListener('DOMContentLoaded', function() {
    const mainImage = document.getElementById('main-product-image');
    if (mainImage && peerProductImages.length > 0) {
        currentImageIndex = peerProductImages.indexOf(mainImage.src);
        if (currentImageIndex === -1) currentImageIndex = 0;
    }
});
</script>

{%endblock body%}

