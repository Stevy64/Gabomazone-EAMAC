{% extends 'base.html' %}
{% load static %}
{% load cart_template_tags %}
{% load peer_filters %}

{%block body%}
<style>
    /* Styles pour la page de détails article C2C */
    .flavoriz-product-detail {
        padding: 24px 0 60px 0;
        background: #FAFAFA;
        min-height: calc(100vh - 200px);
    }
    
    .flavoriz-product-detail-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    
    .flavoriz-breadcrumb {
        margin-bottom: 24px;
        font-size: 13px;
        color: #6B7280;
    }
    
    .flavoriz-breadcrumb a {
        color: var(--color-orange);
        text-decoration: none;
        transition: color 0.2s ease;
    }
    
    .flavoriz-breadcrumb a:hover {
        color: #E65A1F;
    }
    
    .flavoriz-product-detail-main {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 32px;
    }
    
    .flavoriz-product-detail-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        padding: 24px;
    }
    
    .flavoriz-product-gallery {
        position: relative;
    }
    
    .flavoriz-main-image {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        background: #FAFAFA;
        margin-bottom: 16px;
        cursor: zoom-in;
        position: relative;
    }
    
    .flavoriz-main-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .flavoriz-main-image:hover img {
        transform: scale(1.05);
    }
    
    .flavoriz-thumbnails {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }
    
    .flavoriz-thumbnail {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        background: #FAFAFA;
    }
    
    .flavoriz-thumbnail.active {
        border-color: var(--color-orange);
    }
    
    .flavoriz-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .flavoriz-product-info h1 {
        font-size: 24px;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 12px;
        line-height: 1.3;
    }
    
    .flavoriz-product-price-section {
        margin-bottom: 24px;
    }
    
    .flavoriz-current-price {
        font-size: 28px;
        font-weight: 700;
        color: var(--color-orange);
    }
    
    .flavoriz-product-description {
        color: #4B5563;
        line-height: 1.8;
        margin-bottom: 24px;
        font-size: 14px;
    }
    
    .flavoriz-peer-badge {
        display: inline-block;
        padding: 6px 12px;
        background: linear-gradient(135deg, rgba(255, 123, 44, 0.1) 0%, rgba(255, 123, 44, 0.05) 100%);
        color: var(--color-orange);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
    }
    
    .flavoriz-seller-info {
        background: #F9FAFB;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
    }
    
    .flavoriz-seller-info h3 {
        font-size: 15px;
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 12px;
    }
    
    .flavoriz-seller-detail {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        font-size: 14px;
        color: #4B5563;
    }
    
    .flavoriz-seller-detail i {
        color: var(--color-orange);
        width: 20px;
    }
    
    .flavoriz-contact-seller-btn {
        width: 100%;
        padding: 14px 28px;
        background: var(--color-orange);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3);
        margin-top: 16px;
    }
    
    .flavoriz-contact-seller-btn:hover {
        background: #E65A1F;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 123, 44, 0.4);
    }
    
    /* Style Ayoka listing - bloc Détails de l'annonce */
    .ayoka-listing-infos {
        background: #FFFFFF;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 24px;
    }
    .ayoka-listing-infos .ayoka-infos-title {
        font-size: 15px;
        font-weight: 700;
        color: #1F2937;
        padding: 16px 20px;
        background: #F9FAFB;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .ayoka-listing-infos .ayoka-infos-title i {
        color: var(--color-orange);
        font-size: 18px;
    }
    .ayoka-infos-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    .ayoka-infos-list li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        border-bottom: 1px solid #F3F4F6;
        font-size: 14px;
    }
    .ayoka-infos-list li:last-child {
        border-bottom: none;
    }
    .ayoka-infos-list .ayoka-infos-label {
        color: #6B7280;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .ayoka-infos-list .ayoka-infos-label i {
        color: #9CA3AF;
        font-size: 16px;
        width: 20px;
        text-align: center;
    }
    .ayoka-infos-list .ayoka-infos-value {
        color: #1F2937;
        font-weight: 600;
    }
    .ayoka-infos-list .ayoka-infos-value.status-ok {
        color: #059669;
    }
    
    .flavoriz-product-meta {
        display: none; /* Remplacé par ayoka-listing-infos */
    }
    
    .flavoriz-meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .flavoriz-meta-label {
        font-size: 12px;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .flavoriz-meta-value {
        font-size: 15px;
        color: #1F2937;
        font-weight: 600;
    }
    
    /* Bloc Description style Ayoka */
    .ayoka-description-block {
        background: #FFFFFF;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 24px;
    }
    .ayoka-description-block .ayoka-infos-title {
        font-size: 15px;
        font-weight: 700;
        color: #1F2937;
        padding: 16px 20px;
        background: #F9FAFB;
        border-bottom: 1px solid #E5E7EB;
    }
    .ayoka-description-block .ayoka-description-body {
        padding: 20px;
        color: #4B5563;
        line-height: 1.8;
        font-size: 14px;
    }
    
    /* Bloc Vendeur style Ayoka */
    .ayoka-seller-block {
        background: #FFFFFF;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 24px;
    }
    .ayoka-seller-block .ayoka-infos-title {
        padding: 16px 20px;
        background: #F9FAFB;
        border-bottom: 1px solid #E5E7EB;
    }
    
    .flavoriz-related-products {
        margin-top: 48px;
    }
    
    .flavoriz-section-title {
        font-size: 24px;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 24px;
    }
    
    @media (max-width: 968px) {
        .flavoriz-product-detail-content {
            grid-template-columns: 1fr;
            gap: 24px;
            padding: 20px;
        }
        
        .flavoriz-product-meta {
            grid-template-columns: 1fr;
        }
    }
</style>

<main class="main">
    <div class="flavoriz-product-detail">
        <div class="flavoriz-product-detail-container">
            <!-- Breadcrumb -->
            <div class="flavoriz-breadcrumb">
                <a href="{%url 'home:index'%}"><i class="fi-rs-home"></i> Accueil</a>
                <span> / </span>
                <a href="{% url 'categories:shop' %}">Boutique</a>
                <span> / </span>
                {% if peer_product.product_supercategory %}
                <a href="{% url 'categories:super-category' peer_product.product_supercategory.slug%}">{{peer_product.product_supercategory}}</a>
                <span> / </span>
                {% endif %}
                <span>{{peer_product.product_name|truncatechars:40}}</span>
            </div>
            
            <!-- Messages -->
            {% if messages %}
            {% for message in messages %}
            <div class="mt-20 alert align-middle alert-{{message.tags}}" style="padding: 12px 20px; border-radius: 8px; margin-bottom: 20px;">
                <span class="align-middle">{{message}}</span>
            </div>
            {% endfor %}
            {% endif %}
            
            <!-- Main Product Detail Card -->
            <div class="flavoriz-product-detail-main">
                <div class="flavoriz-product-detail-content">
                    <!-- Gallery -->
                    <div class="flavoriz-product-gallery">
                        <div class="flavoriz-main-image" id="main-image-container" style="cursor: zoom-in;">
                            {%if peer_product.product_image%}
                            <img src="{{peer_product.product_image.url}}" alt="{{peer_product.product_name}}" id="main-product-image" onclick="openPeerProductImagePreview()" />
                            {%else%}
                            <img src="{% static 'assets/imgs/shop/product-16-3.jpg'%}" alt="{{peer_product.product_name}}" id="main-product-image" onclick="openPeerProductImagePreview()" />
                            {%endif%}
                        </div>
                        
                        {% if peer_product.additional_image_1 or peer_product.additional_image_2 or peer_product.additional_image_3 %}
                        <div class="flavoriz-thumbnails">
                            {% if peer_product.product_image %}
                            <div class="flavoriz-thumbnail active" onclick="changeMainImage('{{peer_product.product_image.url}}', this)">
                                <img src="{{peer_product.product_image.url}}" alt="Thumbnail 1" />
                            </div>
                            {% endif %}
                            {% if peer_product.additional_image_1 %}
                            <div class="flavoriz-thumbnail {% if not peer_product.product_image and forloop.first %}active{% endif %}" onclick="changeMainImage('{{peer_product.additional_image_1.url}}', this)">
                                <img src="{{peer_product.additional_image_1.url}}" alt="Thumbnail 2" />
                            </div>
                            {% endif %}
                            {% if peer_product.additional_image_2 %}
                            <div class="flavoriz-thumbnail" onclick="changeMainImage('{{peer_product.additional_image_2.url}}', this)">
                                <img src="{{peer_product.additional_image_2.url}}" alt="Thumbnail 3" />
                            </div>
                            {% endif %}
                            {% if peer_product.additional_image_3 %}
                            <div class="flavoriz-thumbnail" onclick="changeMainImage('{{peer_product.additional_image_3.url}}', this)">
                                <img src="{{peer_product.additional_image_3.url}}" alt="Thumbnail 4" />
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Product Info (style Ayoka listing) -->
                    <div class="flavoriz-product-info">
                        <span class="flavoriz-peer-badge">Article d'occasion</span>
                        {% if peer_product.condition %}
                        <span class="peer-condition-badge peer-condition-{{ peer_product.condition|condition_slug }}" style="margin-left: 8px; vertical-align: middle;">{{ peer_product.get_condition_display }}</span>
                        {% endif %}
                        <h1>{{peer_product.product_name}}</h1>
                        
                        <div class="flavoriz-product-price-section">
                            <div style="display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap;">
                                <span class="flavoriz-current-price">{{peer_product.PRDPrice|format_price}} FCFA</span>
                            </div>
                        </div>
                        
                        <!-- Bloc Description (style Ayoka) -->
                        <div class="ayoka-description-block">
                            <div class="ayoka-infos-title">
                                <i class="fi-rs-document"></i>
                                <span>Description</span>
                            </div>
                            <div class="ayoka-description-body">
                                {{peer_product.product_description|safe|linebreaks}}
                            </div>
                        </div>
                        
                        <!-- Bloc Vendeur (style Ayoka) -->
                        <div class="ayoka-seller-block">
                            <div class="ayoka-infos-title">
                                <i class="fi-rs-user"></i>
                                <span>Vendeur</span>
                            </div>
                            <div style="padding: 20px;">
                                <div class="flavoriz-seller-detail" style="margin-bottom: 12px;">
                                    <i class="fi-rs-user"></i>
                                    <span><strong>Vendeur:</strong> 
                                        <a href="{% url 'c2c:seller-profile' peer_product.seller.id %}" style="color: var(--color-orange); text-decoration: none; font-weight: 600;">
                                            {{peer_product.seller.username}}
                                        </a>
                                        {% if seller_stats %}
                                        <span style="margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;">
                                            <i class="fi-rs-star" style="color: #FFD700; font-size: 14px;"></i>
                                            <span style="font-weight: 600; color: #1F2937;">{{ seller_stats.average_rating|floatformat:1 }}</span>
                                            <span style="color: #6B7280; font-size: 12px;">({{ seller_stats.total_reviews }})</span>
                                        </span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flavoriz-seller-detail" style="margin-bottom: 12px;">
                                    <i class="fi-rs-marker"></i>
                                    <span><strong>Ville:</strong> {{peer_product.seller_city}}</span>
                                </div>
                                <div class="flavoriz-seller-detail" style="margin-bottom: 16px;">
                                    <i class="fi-rs-home"></i>
                                    <span><strong>Adresse:</strong> {{peer_product.seller_address}}</span>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <a href="{% url 'c2c:seller-profile' peer_product.seller.id %}" style="flex: 1; min-width: 0; padding: 14px 20px; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(255, 123, 44, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 123, 44, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 123, 44, 0.3)'">
                                        <i class="fi-rs-user-check" style="font-size: 16px;"></i>
                                        <span>Voir le profil</span>
                                    </a>
                                    <button id="peer-propose-offer-btn" onclick="proposeOfferToSeller({{ peer_product.id }}, '{{ peer_product.PRDSlug }}', {{ peer_product.PRDPrice|floatformat:0 }})" style="flex: 1; min-width: 0; padding: 14px 20px; background: white; border: 2px solid #1F2937; color: #1F2937; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);" onmouseover="this.style.background='#1F2937'; this.style.color='white'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='white'; this.style.color='#1F2937'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)'">
                                        <i class="fi-rs-comment" style="font-size: 16px;"></i>
                                        <span>Proposer une offre</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Détails de l'annonce (style Ayoka listing) -->
                        <div class="ayoka-listing-infos">
                            <div class="ayoka-infos-title">
                                <i class="fi-rs-info"></i>
                                <span>Détails de l'annonce</span>
                            </div>
                            <ul class="ayoka-infos-list">
                                <li>
                                    <span class="ayoka-infos-label"><i class="fi-rs-apps"></i> Catégorie</span>
                                    <span class="ayoka-infos-value">{{peer_product.product_supercategory|default:"—"}}</span>
                                </li>
                                <li>
                                    <span class="ayoka-infos-label"><i class="fi-rs-folder"></i> Sous-catégorie</span>
                                    <span class="ayoka-infos-value">{{peer_product.product_subcategory|default:"—"}}</span>
                                </li>
                                <li>
                                    <span class="ayoka-infos-label"><i class="fi-rs-calendar"></i> Date de publication</span>
                                    <span class="ayoka-infos-value">{{peer_product.date|date:"d/m/Y"}}</span>
                                </li>
                                <li>
                                    <span class="ayoka-infos-label"><i class="fi-rs-check-circle"></i> Statut</span>
                                    <span class="ayoka-infos-value status-ok">Approuvé</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Similar Products -->
            {% if similar_products %}
            <div class="flavoriz-related-products">
                <h2 class="flavoriz-section-title">Articles similaires</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    {% for similar in similar_products %}
                    <div class="flavoriz-product-card" style="cursor: pointer; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: all 0.3s ease;" onclick="window.location.href='{% url 'accounts:peer-product-details' similar.PRDSlug %}'">
                        <div style="position: relative; overflow: hidden; background: #FAFAFA; width: 100%; padding-top: 65%;">
                            <img src="{{similar.product_image.url}}" alt="{{similar.product_name}}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" />
                        </div>
                        <div style="padding: 14px;">
                            <h3 style="font-size: 14px; font-weight: 600; color: #1F2937; margin: 0 0 10px 0; line-height: 1.4; min-height: 40px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{similar.product_name}}</h3>
                            <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 18px; font-weight: 700; color: var(--color-orange);">{{similar.PRDPrice|format_price}} FCFA</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</main>

<script>
// Construire la liste des images pour le zoom
const peerProductImages = [
    {% if peer_product.product_image %}'{{peer_product.product_image.url}}'{% endif %}
    {% if peer_product.additional_image_1 %}{% if peer_product.product_image %},{% endif %}'{{peer_product.additional_image_1.url}}'{% endif %}
    {% if peer_product.additional_image_2 %},'{{peer_product.additional_image_2.url}}'{% endif %}
    {% if peer_product.additional_image_3 %},'{{peer_product.additional_image_3.url}}'{% endif %}
].filter(img => img); // Filtrer les valeurs vides

let currentImageIndex = 0;

function changeMainImage(imageUrl, thumbnailElement) {
    const mainImage = document.getElementById('main-product-image');
    if (mainImage) {
        mainImage.src = imageUrl;
        // Mettre à jour l'index de l'image actuelle
        currentImageIndex = peerProductImages.indexOf(imageUrl);
        if (currentImageIndex === -1) currentImageIndex = 0;
    }
    
    // Mettre à jour les thumbnails actifs
    const thumbnails = document.querySelectorAll('.flavoriz-thumbnail');
    thumbnails.forEach(thumb => thumb.classList.remove('active'));
    if (thumbnailElement) {
        thumbnailElement.classList.add('active');
    }
}

// Fonction pour ouvrir le zoom d'image
function openPeerProductImagePreview() {
    if (typeof openImagePreview === 'function' && peerProductImages.length > 0) {
        openImagePreview(peerProductImages, currentImageIndex, '{{peer_product.product_name|escapejs}}');
    } else {
        // Fallback si openImagePreview n'est pas disponible
        const mainImage = document.getElementById('main-product-image');
        if (mainImage) {
            window.open(mainImage.src, '_blank');
        }
    }
}

// Fonction pour ajouter le produit peer-to-peer au panier
function addPeerProductToCart() {
    const productId = 'peer_{{peer_product.id}}';
    // Le prix doit être un nombre, pas une chaîne
    const productPrice = {{peer_product.PRDPrice|floatformat:0}};
    const qty = 1;
    
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('qyt', qty);
    formData.append('product_Price', productPrice);
    
    // Récupérer le token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        GMModal.error('Erreur', 'Token de sécurité non trouvé. Veuillez recharger la page.');
        return;
    }
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    const addBtn = document.getElementById('peer-add-to-cart-btn');
    if (addBtn) {
        addBtn.disabled = true;
        addBtn.style.opacity = '0.6';
    }
    
    fetch('{% url "orders:add-to-cart" %}', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        // Vérifier le type de contenu avant de parser
        const contentType = response.headers.get('content-type');
        
        // Si ce n'est pas du JSON, c'est probablement une redirection HTML
        if (!contentType || !contentType.includes('application/json')) {
            // Si le statut est OK mais pas JSON, rediriger vers le panier
            if (response.ok) {
                window.location.href = '{% url "orders:cart" %}';
                return null;
            } else {
                // Si erreur HTTP, essayer de lire le texte pour voir l'erreur
                return response.text().then(text => {
                    throw new Error('Réponse non-JSON: ' + text.substring(0, 200));
                });
            }
        }
        
        // Vérifier si la réponse est OK
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Erreur HTTP: ' + response.status);
            }).catch(() => {
                throw new Error('Erreur HTTP: ' + response.status);
            });
        }
        
        return response.json();
    })
    .then(data => {
        if (!data) return; // Déjà redirigé
        
        if (data.success) {
            // Rediriger vers le panier
            window.location.href = '{% url "orders:cart" %}';
        } else {
            if (data.requires_login) {
                window.location.href = '{% url "accounts:login" %}';
            } else {
                GMModal.error('Erreur', data.error || 'Erreur lors de l\'ajout au panier');
                if (addBtn) {
                    addBtn.disabled = false;
                    addBtn.style.opacity = '1';
                }
            }
        }
    })
    .catch(error => {
        console.error('Erreur détaillée:', error);
        const errorMessage = error.message || 'Erreur lors de l\'ajout au panier. Veuillez réessayer.';
        GMModal.error('Erreur', errorMessage);
        if (addBtn) {
            addBtn.disabled = false;
            addBtn.style.opacity = '1';
        }
    });
}

// Fonction pour proposer une offre au vendeur (remplace addPeerProductToCart)
function proposeOfferToSeller(productId, productSlug, productPrice) {
    {% if not user.is_authenticated %}
    // Rediriger vers la page de connexion
    window.location.href = '{% url "accounts:login" %}?next=' + encodeURIComponent(window.location.pathname);
    return;
    {% endif %}
    
    {% if user.is_authenticated %}
    // Vérifier si l'utilisateur n'est pas le vendeur
    {% if user.id == peer_product.seller.id %}
    GMModal.warning('Action non autorisée', 'Vous ne pouvez pas proposer une offre pour votre propre article.');
    return;
    {% endif %}
    {% endif %}
    
    // Rediriger vers la création d'intention d'achat C2C
    const createIntentUrl = '{% url "c2c:create-purchase-intent" 0 %}'.replace('0', productId);
    window.location.href = createIntentUrl;
}

// Initialiser l'index de l'image actuelle au chargement
document.addEventListener('DOMContentLoaded', function() {
    const mainImage = document.getElementById('main-product-image');
    if (mainImage && peerProductImages.length > 0) {
        currentImageIndex = peerProductImages.indexOf(mainImage.src);
        if (currentImageIndex === -1) currentImageIndex = 0;
    }
});
</script>

{%endblock body%}

