{% extends 'base.html' %}
{% load static %}
{% load cart_template_tags %}

{%block body%}
<style>
/* Styles desktop pour le parcours de vente */
.sales-journey-toggle {
    display: none !important;
}

.sales-journey-title-desktop {
    display: flex !important;
}

.sales-journey-content {
    display: block !important;
    max-height: none !important;
    overflow: visible !important;
}

/* Styles responsive pour mobile */
@media (max-width: 768px) {
    .main.pages {
        padding-top: 90px !important;
        padding-bottom: 40px !important;
    }
    
    .container {
        padding: 0 16px !important;
    }
    
    /* Sidebar - mettre en haut sur mobile */
    .col-md-3 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
        margin-bottom: 20px;
        order: 1; /* Mettre la sidebar en premier (en haut) */
    }
    
    .col-md-9 {
        order: 2; /* Mettre le contenu principal après la sidebar */
    }
    
    .flavoriz-dashboard-menu {
        position: relative !important;
        top: 0 !important;
        padding: 20px !important;
        border-radius: 16px !important;
    }
    
    .flavoriz-dashboard-menu .mon-compte-grid {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
    }
    
    .flavoriz-dashboard-menu .mon-compte-grid li a {
        padding: 10px 12px !important;
        font-size: 13px !important;
        flex-direction: column !important;
        gap: 6px !important;
        text-align: center !important;
    }
    
    .flavoriz-dashboard-menu .mon-compte-grid li a i {
        font-size: 18px !important;
        width: auto !important;
    }
    
    /* Main content - pleine largeur sur mobile */
    .col-md-9 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
    }
    
    .main-content-wrapper {
        padding: 20px 16px !important;
        border-radius: 16px !important;
    }
    
    /* Breadcrumb responsive */
    nav {
        font-size: 12px !important;
        flex-wrap: wrap !important;
        gap: 4px !important;
    }
    
    /* Masquer uniquement le texte du fil d'Ariane (pas la barre du bas) */
    main .container > nav a span {
        display: none !important;
    }
    
    main .container > nav span:not(:last-child) {
        display: none !important;
    }
    
    /* Header */
    .main-content-header h1 {
        font-size: 22px !important;
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px !important;
    }
    
    .main-content-header h1 i {
        font-size: 24px !important;
    }
    
    .main-content-header p {
        font-size: 13px !important;
    }
    
    /* Parcours visuel - liste déroulante sur mobile */
    .sales-journey {
        padding: 16px !important;
        margin-bottom: 24px !important;
    }
    
    .sales-journey-toggle {
        display: flex !important;
    }
    
    .sales-journey-title-desktop {
        display: none !important;
    }
    
    .sales-journey-content {
        max-height: 0 !important;
        overflow: hidden !important;
        transition: max-height 0.3s ease-out !important;
    }
    
    .sales-journey-content.expanded {
        max-height: 2000px !important;
        transition: max-height 0.5s ease-in !important;
    }
    
    .sales-journey-icon {
        transform: rotate(0deg) !important;
        transition: transform 0.3s ease !important;
    }
    
    .sales-journey-icon.rotated {
        transform: rotate(180deg) !important;
    }
    
    .sales-journey-steps {
        flex-direction: column !important;
        gap: 16px !important;
        padding-top: 16px !important;
    }
    
    .sales-journey-steps .journey-line {
        display: none !important;
    }
    
    .journey-step {
        min-width: 100% !important;
        flex: 1 1 100% !important;
        padding: 12px !important;
        background: white !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
    }
    
    .journey-step > div:first-child {
        width: 50px !important;
        height: 50px !important;
    }
    
    .journey-step h4 {
        font-size: 13px !important;
    }
    
    .journey-step p {
        font-size: 11px !important;
    }
    
    /* Form sections */
    .form-section {
        margin-bottom: 24px !important;
    }
    
    .form-section-title {
        font-size: 18px !important;
        padding-bottom: 10px !important;
    }
    
    .form-section-title i {
        font-size: 18px !important;
    }
    .form-section-title {
        font-size: 18px !important;
    }
    
    /* Grids - une colonne sur mobile */
    .form-grid-2,
    .form-grid-3,
    .form-grid-4 {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }
    
    /* Listes déroulantes - amélioration pour mobile */
    select,
    .custom-select {
        font-size: 16px !important; /* Évite le zoom automatique sur iOS */
        padding: 14px 16px !important;
        min-height: 48px !important; /* Taille de touche recommandée */
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%236B7280' d='M7 10L2 5h10z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 16px center !important;
        background-size: 14px !important;
        padding-right: 45px !important;
        border-width: 2px !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
    }
    
    select:focus,
    .custom-select:focus {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%23FF7B2C' d='M7 10L2 5h10z'/%3E%3C/svg%3E") !important;
        box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1) !important;
    }
    
    /* Inputs de fichiers - amélioration pour mobile */
    input[type="file"] {
        font-size: 16px !important;
        padding: 16px !important;
        min-height: 56px !important;
        border-width: 2px !important;
        border-style: dashed !important;
        background: #FAFAFA !important;
    }
    
    input[type="file"]:focus {
        background: #FFFFFF !important;
        border-color: var(--color-orange) !important;
        border-width: 2px !important;
    }
    
    /* Labels */
    label {
        font-size: 14px !important;
        margin-bottom: 10px !important;
    }
    
    /* Textareas */
    textarea {
        font-size: 16px !important; /* Évite le zoom automatique sur iOS */
        min-height: 100px !important;
    }
    
    /* Inputs texte */
    input[type="text"],
    input[type="tel"],
    input[type="number"] {
        font-size: 16px !important; /* Évite le zoom automatique sur iOS */
        padding: 14px 16px !important;
        min-height: 48px !important;
    }
    
    /* Boutons */
    .form-buttons {
        flex-direction: column !important;
        gap: 12px !important;
    }
    
    .form-buttons button {
        width: 100% !important;
        padding: 16px !important;
        font-size: 16px !important;
        min-height: 48px !important;
    }
    
    /* Mes articles - grille responsive */
    .user-products-grid {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }
    
    /* Preview images */
    .image-preview {
        margin-top: 16px !important;
    }
    
    .image-preview img {
        max-height: 200px !important;
        width: 100% !important;
        object-fit: cover !important;
    }
    
    /* Espacement général */
    .main-content-wrapper > * {
        margin-bottom: 24px !important;
    }
    
    .main-content-wrapper > *:last-child {
        margin-bottom: 0 !important;
    }
}

/* Listes déroulantes modernes (style capture) */
.flavoriz-dropdown { position: relative; width: 100%; }
.flavoriz-dropdown-trigger {
    width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 10px;
    padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 14px;
    background: #FAFAFA; color: #1F2937; cursor: pointer; outline: none; transition: all 0.2s ease;
    text-align: left; min-height: 48px; box-sizing: border-box;
}
.flavoriz-dropdown-trigger:hover { border-color: #D1D5DB; background: #F9FAFB; }
.flavoriz-dropdown-trigger:focus { border-color: var(--color-orange); box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.12); }
.flavoriz-dropdown.open .flavoriz-dropdown-trigger {
    border-color: var(--color-orange); background: #fff; box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1);
}
.flavoriz-dropdown-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.flavoriz-dropdown-chevron { font-size: 16px; color: #6B7280; flex-shrink: 0; transition: transform 0.2s ease; }
.flavoriz-dropdown.open .flavoriz-dropdown-chevron { transform: rotate(180deg); color: var(--color-orange); }
.flavoriz-dropdown-panel {
    position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: #fff;
    border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.12), 0 2px 10px rgba(0,0,0,0.06);
    border: 1px solid #E5E7EB; max-height: 280px; overflow-y: auto; z-index: 1000; padding: 6px 0;
}
.flavoriz-dropdown-panel[hidden] { display: none !important; }
.flavoriz-dropdown-option {
    padding: 12px 16px; font-size: 14px; color: #1F2937; cursor: pointer;
    transition: background 0.15s ease, color 0.15s ease; border: none; width: 100%; text-align: left; background: none;
}
.flavoriz-dropdown-option:hover { background: #FDF8F3; color: var(--color-orange); }
.flavoriz-dropdown-option.selected { background: rgba(255, 123, 44, 0.1); color: var(--color-orange); font-weight: 600; }
.flavoriz-dropdown-option:focus { outline: none; background: #F3F4F6; }

/* Zones d'upload modernes */
.upload-zone { position: relative; }
.upload-zone-inner:hover { border-color: var(--color-orange) !important; background: linear-gradient(135deg, #FFF9F5 0%, #FFF5EE 100%) !important; }
.upload-zone-inner.upload-dragover { border-color: var(--color-orange) !important; background: linear-gradient(135deg, rgba(255, 123, 44, 0.12) 0%, rgba(255, 123, 44, 0.06) 100%) !important; box-shadow: 0 0 0 4px rgba(255, 123, 44, 0.15); }
.upload-zone-extra { position: relative; min-height: 120px; }
.upload-zone-extra:hover > div { border-color: var(--color-orange) !important; background: #FFF9F5 !important; }

/* Amélioration des listes déroulantes sur tous les écrans */
select,
.custom-select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%23FF7B2C' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    background-size: 16px;
    padding-right: 48px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 600;
    color: #1F2937;
    background-color: white;
}

select:hover,
.custom-select:hover {
    border-color: var(--color-orange) !important;
    box-shadow: 0 4px 12px rgba(255, 123, 44, 0.2) !important;
    transform: translateY(-1px);
    background-color: #FFF9F5;
}

select:focus,
.custom-select:focus {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%23FF7B2C' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    border-color: var(--color-orange) !important;
    box-shadow: 0 0 0 4px rgba(255, 123, 44, 0.15), 0 4px 12px rgba(255, 123, 44, 0.2) !important;
    background-color: #FFF9F5;
    outline: none;
}

.custom-select option {
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 500;
    color: #1F2937;
    background: white;
}

.custom-select option:hover {
    background: rgba(255, 123, 44, 0.1);
}

.custom-select option:checked {
    background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%);
    color: white;
    font-weight: 700;
}

/* Amélioration des inputs de fichiers */
input[type="file"] {
    position: relative;
    cursor: pointer;
    background: #FAFAFA !important;
    border: 2px dashed #E5E7EB !important;
    transition: all 0.3s ease !important;
}

input[type="file"]::file-selector-button {
    display: none;
}

input[type="file"]:hover {
    background: #F9FAFB !important;
    border-color: #D1D5DB !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
}

input[type="file"]:focus {
    background: #FFFFFF !important;
    border-color: var(--color-orange) !important;
    border-width: 2px !important;
    box-shadow: 0 0 0 3px rgba(255, 123, 44, 0.1) !important;
}

input[type="file"]:active {
    background: #F3F4F6 !important;
    transform: scale(0.98);
}

/* Zone de drop améliorée pour mobile */
@media (max-width: 768px) {
    input[type="file"] {
        text-align: center;
        position: relative;
    }
    
    /* Amélioration visuelle pour les zones de fichiers */
    .form-grid-4 > div {
        position: relative;
    }
    
    .form-grid-4 input[type="file"] {
        background: linear-gradient(135deg, #FAFAFA 0%, #F3F4F6 100%) !important;
        border: 2px dashed #D1D5DB !important;
    }
    
    .form-grid-4 input[type="file"]:focus {
        background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%) !important;
        border-color: var(--color-orange) !important;
        border-width: 2px !important;
    }
    
    /* Amélioration des previews d'images */
    .image-preview {
        text-align: center;
    }
    
    .image-preview img {
        max-height: 180px !important;
        width: auto !important;
        margin: 0 auto;
    }
}
</style>

<main class="main pages" style="padding-top: 100px; padding-bottom: 100px; min-height: calc(100vh - 200px); background: linear-gradient(135deg, #FDF8F3 0%, #FFF9F5 100%);">
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 24px;">
        <!-- Breadcrumb -->
        <nav style="margin-bottom: 20px; font-size: 13px; color: #6B7280; display: flex; align-items: center; gap: 6px;">
            <a href="{% url 'home:index' %}" style="color: var(--color-orange); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;">
                <i class="fi-rs-home"></i> <span>Accueil</span>
            </a>
            <span style="color: #9CA3AF;">/</span>
            <span style="color: #6B7280; font-weight: 500;">Vendre un article</span>
        </nav>

        <div class="row" style="display: flex; gap: 24px; align-items: start; flex-wrap: wrap;">
            <!-- Sidebar Menu (carte Mon compte, sans Déconnexion) -->
            <div class="col-md-3" style="flex: 0 0 280px; max-width: 280px; padding: 0;">
                {% include 'accounts/_mon_compte_card.html' with active_page='sell-product' %}
            </div>

            <!-- Main Content -->
            <div class="col-md-9" style="flex: 1; min-width: 0;">
                <div style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <!-- Header -->
                    <div class="main-content-header" style="margin-bottom: 32px;">
                        <h1 style="font-size: 28px; font-weight: 700; color: #1F2937; margin: 0 0 8px 0; display: flex; align-items: center; gap: 12px;">
                            <i class="fi-rs-shopping-cart-add" style="color: var(--color-orange); font-size: 32px;"></i>
                            Vendre un article en occasion
                        </h1>
                        <p style="color: #6B7280; font-size: 15px; margin: 0; line-height: 1.5;">
                            Publiez votre annonce. Commission 20%.
                        </p>
                    </div>

                    <!-- Parcours visuel des étapes -->
                    <div class="sales-journey" style="margin-bottom: 40px; padding: 24px; background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%); border-radius: 16px; border: 2px solid #E5E7EB;">
                        <button type="button" class="sales-journey-toggle" onclick="toggleSalesJourney()" style="width: 100%; display: none; align-items: center; justify-content: space-between; background: none; border: none; padding: 0; margin: 0 0 16px 0; cursor: pointer; text-align: left;">
                            <h3 style="font-size: 18px; font-weight: 700; color: #1F2937; margin: 0; display: flex; align-items: center; gap: 8px;">
                                <i class="fi-rs-list-check" style="color: var(--color-orange);"></i>
                                Parcours de vente
                            </h3>
                            <i class="fi-rs-angle-down sales-journey-icon" style="font-size: 20px; color: var(--color-orange); transition: transform 0.3s ease;"></i>
                        </button>
                        <h3 class="sales-journey-title-desktop" style="font-size: 18px; font-weight: 700; color: #1F2937; margin: 0 0 20px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fi-rs-list-check" style="color: var(--color-orange);"></i>
                            Parcours de vente
                        </h3>
                        <div class="sales-journey-content" style="display: block;">
                        <div class="sales-journey-steps" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; position: relative;">
                            <div class="journey-line" style="position: absolute; top: 30px; left: 60px; right: 60px; height: 3px; background: linear-gradient(90deg, var(--color-orange) 0%, #E5E7EB 100%); z-index: 0; border-radius: 2px;"></div>
                            <!-- 1. Publier l'annonce -->
                            <div class="journey-step" style="flex: 1; min-width: 120px; text-align: center; position: relative; z-index: 1;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3);">
                                    <i class="fi-rs-edit" style="color: white; font-size: 24px;"></i>
                                </div>
                                <h4 style="font-size: 14px; font-weight: 700; color: #1F2937; margin: 0 0 4px 0;">1. Publier l'annonce</h4>
                                <p style="font-size: 12px; color: #6B7280; margin: 0; line-height: 1.4;">Vous déposez votre annonce</p>
                            </div>
                            <!-- 2. Validation -->
                            <div class="journey-step" style="flex: 1; min-width: 120px; text-align: center; position: relative; z-index: 1;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #10B981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <i class="fi-rs-check" style="color: white; font-size: 24px;"></i>
                                </div>
                                <h4 style="font-size: 14px; font-weight: 700; color: #1F2937; margin: 0 0 4px 0;">2. Validation</h4>
                                <p style="font-size: 12px; color: #6B7280; margin: 0; line-height: 1.4;">Contrôle par l'équipe</p>
                            </div>
                            <!-- 3. En ligne -->
                            <div class="journey-step" style="flex: 1; min-width: 120px; text-align: center; position: relative; z-index: 1;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                    <i class="fi-rs-world" style="color: white; font-size: 24px;"></i>
                                </div>
                                <h4 style="font-size: 14px; font-weight: 700; color: #1F2937; margin: 0 0 4px 0;">3. En ligne</h4>
                                <p style="font-size: 12px; color: #6B7280; margin: 0; line-height: 1.4;">Annonce visible aux acheteurs</p>
                            </div>
                            <!-- 4. Négociation du prix -->
                            <div class="journey-step" style="flex: 1; min-width: 120px; text-align: center; position: relative; z-index: 1;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                                    <i class="fi-rs-money" style="color: white; font-size: 24px;"></i>
                                </div>
                                <h4 style="font-size: 14px; font-weight: 700; color: #1F2937; margin: 0 0 4px 0;">4. Négociation du prix</h4>
                                <p style="font-size: 12px; color: #6B7280; margin: 0; line-height: 1.4;">Accord avec l'acheteur</p>
                            </div>
                            <!-- 5. Achat et remise -->
                            <div class="journey-step" style="flex: 1; min-width: 120px; text-align: center; position: relative; z-index: 1;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                                    <i class="fi-rs-shopping-cart-check" style="color: white; font-size: 24px;"></i>
                                </div>
                                <h4 style="font-size: 14px; font-weight: 700; color: #1F2937; margin: 0 0 4px 0;">5. Achat et remise</h4>
                                <p style="font-size: 12px; color: #6B7280; margin: 0; line-height: 1.4;">Paiement et remise de l'article</p>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    {% if messages %}
                    <div style="margin-bottom: 24px;">
                        {% for message in messages %}
                        <div class="alert alert-{{message.tags}}" style="padding: 16px 20px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; {% if message.tags == 'success' %}background: #D1FAE5; color: #065F46; border: 1px solid #10B981;{% elif message.tags == 'error' %}background: #FEE2E2; color: #991B1B; border: 1px solid #EF4444;{% else %}background: #FEF3C7; color: #92400E; border: 1px solid #F59E0B;{% endif %}">
                            <i class="fi-rs-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}alert-circle{% else %}info{% endif %}" style="font-size: 20px;"></i>
                            <span style="font-weight: 500;">{{message}}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Formulaire -->
                    <form method="post" action="{% if is_edit %}{% url 'accounts:edit-peer-product' product.id %}{% else %}{% url 'accounts:sell-product' %}{% endif %}" enctype="multipart/form-data" id="addProductForm">
                        {% csrf_token %}
                        
                        {% if is_edit %}
                        <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 12px; border: 2px solid #F59E0B;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fi-rs-edit" style="font-size: 24px; color: #92400E;"></i>
                                <div>
                                    <h4 style="font-size: 16px; font-weight: 700; color: #92400E; margin: 0 0 4px 0;">Mode édition</h4>
                                    <p style="font-size: 13px; color: #78350F; margin: 0;">Vous modifiez l'article "{{ product.product_name }}". Les modifications nécessiteront une nouvelle validation.</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- 1. Photos (premier : design moderne pour inciter à l'upload) -->
                        <div class="form-section form-section-photos" style="margin-bottom: 32px;">
                            <h3 class="form-section-title" style="font-size: 20px; font-weight: 700; color: #1F2937; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 2px solid #F3F4F6;">
                                <i class="fi-rs-picture" style="color: var(--color-orange);"></i>
                                Photos de l'article
                            </h3>
                            <p style="font-size: 14px; color: #6B7280; margin: 0 0 20px 0;">Une belle photo principale augmente vos chances de vente. Ajoutez jusqu'à 5 photos.{% if is_edit %} Laissez vide pour conserver la photo actuelle.{% endif %}</p>
                            <!-- Image principale : zone drop moderne -->
                            <div class="upload-zone upload-zone-main" style="position: relative; margin-bottom: 20px;">
                                <input type="file" name="product_image" id="id_product_image_main" {% if not is_edit %}required{% endif %} accept="image/*" style="position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;">
                                <div class="upload-zone-inner" style="min-height: 220px; border: 2px dashed #D1D5DB; border-radius: 16px; background: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px; text-align: center; transition: all 0.25s ease;">
                                    <div id="preview_main_wrap" class="upload-preview-wrap" style="display: none; width: 100%; max-width: 280px;">
                                        <img id="preview_main" src="" alt="Aperçu" style="width: 100%; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); object-fit: cover; max-height: 220px;">
                                        <p style="font-size: 13px; color: var(--color-orange); font-weight: 600; margin: 10px 0 0 0;">Cliquez pour changer</p>
                                    </div>
                                    <div id="upload_main_placeholder" class="upload-placeholder">
                                        <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, rgba(255, 123, 44, 0.15) 0%, rgba(255, 123, 44, 0.08) 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                                            <i class="fi-rs-camera" style="font-size: 28px; color: var(--color-orange);"></i>
                                        </div>
                                        <p style="font-size: 16px; font-weight: 700; color: #1F2937; margin: 0 0 6px 0;">Image principale <span style="color: #EF4444;">*</span></p>
                                        <p style="font-size: 14px; color: #6B7280; margin: 0;">Glissez une photo ici ou cliquez pour choisir</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Images supplémentaires (optionnelles) -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px;">
                                <div class="upload-zone upload-zone-extra">
                                    <input type="file" name="additional_image_1" accept="image/*" style="position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;" onchange="previewImage(this, 'preview_1')">
                                    <div style="min-height: 120px; border: 2px dashed #E5E7EB; border-radius: 12px; background: #F9FAFB; display: flex; align-items: center; justify-content: center; padding: 16px; transition: all 0.2s ease; position: relative;">
                                        <div id="preview_1_wrap" style="display: none; position: absolute; inset: 0; padding: 8px;"><img id="preview_1" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                        <div id="placeholder_1" style="text-align: center;"><i class="fi-rs-add" style="font-size: 24px; color: #9CA3AF;"></i><span style="display: block; font-size: 11px; color: #9CA3AF; margin-top: 4px;">Photo 2</span></div>
                                    </div>
                                </div>
                                <div class="upload-zone upload-zone-extra">
                                    <input type="file" name="additional_image_2" accept="image/*" style="position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;" onchange="previewImage(this, 'preview_2')">
                                    <div style="min-height: 120px; border: 2px dashed #E5E7EB; border-radius: 12px; background: #F9FAFB; display: flex; align-items: center; justify-content: center; padding: 16px; transition: all 0.2s ease; position: relative;">
                                        <div id="preview_2_wrap" style="display: none; position: absolute; inset: 0; padding: 8px;"><img id="preview_2" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                        <div id="placeholder_2" style="text-align: center;"><i class="fi-rs-add" style="font-size: 24px; color: #9CA3AF;"></i><span style="display: block; font-size: 11px; color: #9CA3AF; margin-top: 4px;">Photo 3</span></div>
                                    </div>
                                </div>
                                <div class="upload-zone upload-zone-extra">
                                    <input type="file" name="additional_image_3" accept="image/*" style="position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;" onchange="previewImage(this, 'preview_3')">
                                    <div style="min-height: 120px; border: 2px dashed #E5E7EB; border-radius: 12px; background: #F9FAFB; display: flex; align-items: center; justify-content: center; padding: 16px; transition: all 0.2s ease; position: relative;">
                                        <div id="preview_3_wrap" style="display: none; position: absolute; inset: 0; padding: 8px;"><img id="preview_3" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                        <div id="placeholder_3" style="text-align: center;"><i class="fi-rs-add" style="font-size: 24px; color: #9CA3AF;"></i><span style="display: block; font-size: 11px; color: #9CA3AF; margin-top: 4px;">Photo 4</span></div>
                                    </div>
                                </div>
                                <div class="upload-zone upload-zone-extra">
                                    <input type="file" name="additional_image_4" accept="image/*" style="position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;" onchange="previewImage(this, 'preview_4')">
                                    <div style="min-height: 120px; border: 2px dashed #E5E7EB; border-radius: 12px; background: #F9FAFB; display: flex; align-items: center; justify-content: center; padding: 16px; transition: all 0.2s ease; position: relative;">
                                        <div id="preview_4_wrap" style="display: none; position: absolute; inset: 0; padding: 8px;"><img id="preview_4" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                        <div id="placeholder_4" style="text-align: center;"><i class="fi-rs-add" style="font-size: 24px; color: #9CA3AF;"></i><span style="display: block; font-size: 11px; color: #9CA3AF; margin-top: 4px;">Photo 5</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Informations de base -->
                        <div class="form-section" style="margin-bottom: 32px;">
                            <h3 class="form-section-title" style="font-size: 20px; font-weight: 700; color: #1F2937; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 2px solid #F3F4F6;">
                                <i class="fi-rs-info" style="color: var(--color-orange);"></i>
                                Informations de base
                            </h3>
                            
                            <div class="form-grid-2" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        Nom du produit <span style="color: #EF4444;">*</span>
                                    </label>
                                    <input type="text" name="product_name" required maxlength="150" placeholder="Ex: iPhone 13 Pro Max" value="{% if is_edit %}{{ product.product_name }}{% endif %}" style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 14px; transition: all 0.3s; outline: none;" onfocus="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 0 0 3px rgba(255, 123, 44, 0.1)'" onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none'">
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        Prix (FCFA) <span style="color: #EF4444;">*</span>
                                    </label>
                                    <input type="number" name="PRDPrice" required min="1" step="0.01" placeholder="Ex: 200000" value="{% if is_edit %}{{ product.PRDPrice }}{% endif %}" style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 14px; transition: all 0.3s; outline: none;" onfocus="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 0 0 3px rgba(255, 123, 44, 0.1)'" onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none'">
                                    <p style="font-size: 12px; color: #6B7280; margin: 6px 0 0 0;">
                                        Commission: 20% | Vous recevrez: 80%
                                    </p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                    Description <span style="color: #EF4444;">*</span>
                                </label>
                                <textarea name="product_description" required rows="4" placeholder="Décrivez votre article en détail..." style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 14px; transition: all 0.3s; outline: none; resize: vertical; font-family: inherit;" onfocus="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 0 0 3px rgba(255, 123, 44, 0.1)'" onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none'">{% if is_edit %}{{ product.product_description }}{% endif %}</textarea>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                    État de l'article <span style="color: #EF4444;">*</span>
                                </label>
                                <div class="flavoriz-dropdown" id="dropdown-condition-wrap" style="max-width: 320px;">
                                    <input type="hidden" name="condition" id="condition_value" value="{% if is_edit %}{{ product.condition|default:'BON ETAT' }}{% else %}BON ETAT{% endif %}" required>
                                    <button type="button" class="flavoriz-dropdown-trigger" id="dropdown-condition-trigger" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="flavoriz-dropdown-label" id="dropdown-condition-label">{% if is_edit %}{{ product.get_condition_display|default:"Bon état" }}{% else %}Bon état{% endif %}</span>
                                        <i class="fi-rs-angle-small-down flavoriz-dropdown-chevron"></i>
                                    </button>
                                    <div class="flavoriz-dropdown-panel" id="dropdown-condition-panel" role="listbox" hidden>
                                        <div class="flavoriz-dropdown-option{% if is_edit and product.condition == 'NEUF' %} selected{% endif %}" role="option" data-value="NEUF" data-label="Neuf" tabindex="0">Neuf</div>
                                        <div class="flavoriz-dropdown-option{% if is_edit and product.condition == 'COMME NEUF' %} selected{% endif %}" role="option" data-value="COMME NEUF" data-label="Comme neuf" tabindex="0">Comme neuf</div>
                                        <div class="flavoriz-dropdown-option{% if not is_edit or product.condition == 'BON ETAT' or not product.condition %} selected{% endif %}" role="option" data-value="BON ETAT" data-label="Bon état" tabindex="0">Bon état</div>
                                        <div class="flavoriz-dropdown-option{% if is_edit and product.condition == 'UTILISABLE' %} selected{% endif %}" role="option" data-value="UTILISABLE" data-label="Utilisable" tabindex="0">Utilisable</div>
                                    </div>
                                </div>
                                <p style="font-size: 12px; color: #6B7280; margin: 6px 0 0 0;">
                                    Indiquez l'état général de votre article pour les acheteurs.
                                </p>
                            </div>
                        </div>

                        <!-- Catégories -->
                        <div class="form-section" style="margin-bottom: 32px;">
                            <h3 class="form-section-title" style="font-size: 20px; font-weight: 700; color: #1F2937; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 2px solid #F3F4F6;">
                                <i class="fi-rs-money" style="color: var(--color-orange);"></i>
                                Catégories
                            </h3>
                            
                            <div class="form-grid-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        Super catégorie
                                    </label>
                                    <div class="flavoriz-dropdown" id="dropdown-super-wrap">
                                        <input type="hidden" name="product_supercategory" id="super_category" value="{% if is_edit %}{{ selected_super|default:'' }}{% endif %}">
                                        <button type="button" class="flavoriz-dropdown-trigger" id="dropdown-super-trigger" aria-haspopup="listbox" aria-expanded="false">
                                            <span class="flavoriz-dropdown-label" id="dropdown-super-label">Sélectionner...</span>
                                            <i class="fi-rs-angle-small-down flavoriz-dropdown-chevron"></i>
                                        </button>
                                        <div class="flavoriz-dropdown-panel" id="dropdown-super-panel" role="listbox" hidden>
                                            <div class="flavoriz-dropdown-option" role="option" data-value="" data-label="Sélectionner..." tabindex="0">Sélectionner...</div>
                                            {% for cat in super_categories %}
                                            <div class="flavoriz-dropdown-option{% if is_edit and selected_super == cat.id %} selected{% endif %}" role="option" data-value="{{ cat.id }}" data-label="{{ cat.name }}" tabindex="0">{{ cat.name }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        Catégorie principale
                                    </label>
                                    <div class="flavoriz-dropdown" id="dropdown-main-wrap">
                                        <input type="hidden" name="product_maincategory" id="main_category" value="{% if is_edit %}{{ selected_main|default:'' }}{% endif %}">
                                        <button type="button" class="flavoriz-dropdown-trigger" id="dropdown-main-trigger" aria-haspopup="listbox" aria-expanded="false">
                                            <span class="flavoriz-dropdown-label" id="dropdown-main-label">Sélectionner...</span>
                                            <i class="fi-rs-angle-small-down flavoriz-dropdown-chevron"></i>
                                        </button>
                                        <div class="flavoriz-dropdown-panel" id="main_category_panel" role="listbox" hidden>
                                            <div class="flavoriz-dropdown-option" role="option" data-value="" data-label="Sélectionner..." tabindex="0">Sélectionner...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        Sous-catégorie
                                    </label>
                                    <div class="flavoriz-dropdown" id="dropdown-sub-wrap">
                                        <input type="hidden" name="product_subcategory" id="sub_category" value="{% if is_edit %}{{ selected_sub|default:'' }}{% endif %}">
                                        <button type="button" class="flavoriz-dropdown-trigger" id="dropdown-sub-trigger" aria-haspopup="listbox" aria-expanded="false">
                                            <span class="flavoriz-dropdown-label" id="dropdown-sub-label">Sélectionner...</span>
                                            <i class="fi-rs-angle-small-down flavoriz-dropdown-chevron"></i>
                                        </button>
                                        <div class="flavoriz-dropdown-panel" id="sub_category_panel" role="listbox" hidden>
                                            <div class="flavoriz-dropdown-option" role="option" data-value="" data-label="Sélectionner..." tabindex="0">Sélectionner...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informations de contact -->
                        <div class="form-section" style="margin-bottom: 32px;">
                            <h3 class="form-section-title" style="font-size: 20px; font-weight: 700; color: #1F2937; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 2px solid #F3F4F6;">
                                <i class="fi-rs-phone-call" style="color: var(--color-orange);"></i>
                                Informations de contact
                            </h3>
                            
                            <div class="form-grid-2" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        Téléphone <span style="color: #EF4444;">*</span>
                                    </label>
                                    <input type="tel" name="seller_phone" required placeholder="Ex: +241 01 23 45 67" value="{% if is_edit %}{{ product.seller_phone }}{% endif %}" style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 14px; transition: all 0.3s; outline: none;" onfocus="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 0 0 3px rgba(255, 123, 44, 0.1)'" onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none'">
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        Ville <span style="color: #EF4444;">*</span>
                                    </label>
                                    <input type="text" name="seller_city" required placeholder="Ex: Libreville" value="{% if is_edit %}{{ product.seller_city }}{% endif %}" style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 14px; transition: all 0.3s; outline: none;" onfocus="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 0 0 3px rgba(255, 123, 44, 0.1)'" onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none'">
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                    Adresse complète <span style="color: #EF4444;">*</span>
                                </label>
                                <textarea name="seller_address" required rows="3" placeholder="Votre adresse complète pour la livraison..." style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 14px; transition: all 0.3s; outline: none; resize: vertical; font-family: inherit;" onfocus="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 0 0 3px rgba(255, 123, 44, 0.1)'" onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none'">{% if is_edit %}{{ product.seller_address }}{% endif %}</textarea>
                            </div>
                        </div>

                        <!-- Bouton de soumission -->
                        <div class="form-buttons" style="display: flex; justify-content: flex-end; gap: 16px; padding-top: 24px; border-top: 2px solid #F3F4F6;">
                            {% if is_edit %}
                            <a href="{% url 'accounts:sell-product' %}" style="padding: 14px 28px; background: white; color: #6B7280; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                                <i class="fi-rs-arrow-left"></i>
                                Annuler
                            </a>
                            {% else %}
                            <button type="reset" style="padding: 14px 28px; background: white; color: #6B7280; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                Réinitialiser
                            </button>
                            {% endif %}
                            <button type="submit" style="padding: 14px 32px; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(255, 123, 44, 0.3); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255, 123, 44, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 123, 44, 0.3)'">
                                <i class="fi-rs-check"></i>
                                {% if is_edit %}Enregistrer les modifications{% else %}Publier l'article{% endif %}
                            </button>
                        </div>
                    </form>


                    <!-- Mes articles -->
                    {% if user_products %}
                    <div style="margin-top: 48px; padding-top: 32px; border-top: 2px solid #F3F4F6;">
                        <h3 style="font-size: 20px; font-weight: 700; color: #1F2937; margin: 0 0 24px 0; display: flex; align-items: center; gap: 10px;">
                            <i class="fi-rs-list" style="color: var(--color-orange);"></i>
                            Mes articles publiés ({{ user_products|length }})
                        </h3>
                        <div class="user-products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            {% for product in user_products %}
                            <div style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #E5E7EB; transition: all 0.3s; position: relative; display: flex; flex-direction: column;" onmouseover="this.style.borderColor='var(--color-orange)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none'">
                                <div style="margin-bottom: 12px; position: relative;">
                                    <img src="{{ product.product_image.url }}" alt="{{ product.product_name }}" style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px;">
                                    {% if product.is_boosted %}
                                    <div style="position: absolute; top: 8px; left: 8px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #1F2937; padding: 6px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 8px rgba(255, 165, 0, 0.4); z-index: 10; text-transform: uppercase; letter-spacing: 0.5px;">
                                        <i class="fi-rs-rocket" style="font-size: 12px;"></i>
                                        <span>Boosté</span>
                                    </div>
                                    {% endif %}
                                    {% if product.status == 'APPROVED' %}
                                    <a href="{% url 'accounts:peer-product-details' product.PRDSlug %}" target="_blank" style="position: absolute; top: 8px; right: 8px; background: rgba(255, 255, 255, 0.95); padding: 6px 10px; border-radius: 6px; color: var(--color-orange); text-decoration: none; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                        <i class="fi-rs-eye"></i> Voir
                                    </a>
                                    {% endif %}
                                </div>
                                <h4 style="font-size: 16px; font-weight: 700; color: #1F2937; margin: 0 0 8px 0; line-height: 1.4;">{{ product.product_name|truncatechars:50 }}</h4>
                                <p style="font-size: 18px; font-weight: 700; color: var(--color-orange); margin: 0 0 12px 0;">{{ product.PRDPrice|format_price }} FCFA</p>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                                    {% if product.status == 'PENDING' %}
                                    <span style="padding: 6px 12px; background: #FEF3C7; color: #92400E; border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                        <i class="fi-rs-clock" style="font-size: 12px;"></i> En attente
                                    </span>
                                    {% elif product.status == 'APPROVED' %}
                                    <span style="padding: 6px 12px; background: #D1FAE5; color: #065F46; border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                        <i class="fi-rs-check" style="font-size: 12px;"></i> Approuvé
                                    </span>
                                    {% elif product.status == 'REJECTED' %}
                                    <span style="padding: 6px 12px; background: #FEE2E2; color: #991B1B; border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                        <i class="fi-rs-cross" style="font-size: 12px;"></i> Rejeté
                                    </span>
                                    {% elif product.status == 'SOLD' %}
                                    <span style="padding: 6px 12px; background: #DBEAFE; color: #1E40AF; border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                        <i class="fi-rs-shopping-bag" style="font-size: 12px;"></i> Vendu
                                    </span>
                                    {% endif %}
                                    {% if product.view_count > 0 %}
                                    <span style="padding: 6px 12px; background: #F3F4F6; color: #6B7280; border-radius: 6px; font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 4px;">
                                        <i class="fi-rs-eye" style="font-size: 12px;"></i> {{ product.view_count }}
                                    </span>
                                    {% endif %}
                                </div>
                                <p style="font-size: 12px; color: #6B7280; margin: 0 0 16px 0;">Publié le {{ product.date|date:"d/m/Y à H:i" }}</p>
                                
                                <!-- Actions CRUD -->
                                <div style="display: flex; gap: 8px; margin-top: auto; padding-top: 16px; border-top: 1px solid #E5E7EB;">
                                    <a href="{% url 'accounts:edit-peer-product' product.id %}" style="flex: 1; padding: 10px 16px; background: linear-gradient(135deg, var(--color-orange) 0%, #FF9A5C 100%); color: white; border-radius: 8px; font-size: 13px; font-weight: 600; text-decoration: none; text-align: center; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 123, 44, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <i class="fi-rs-edit" style="font-size: 14px;"></i> Modifier
                                    </a>
                                    <button type="button" onclick="confirmDelete({{ product.id }}, '{{ product.product_name|escapejs }}')" style="flex: 1; padding: 10px 16px; background: #FEE2E2; color: #DC2626; border: 2px solid #FEE2E2; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;" onmouseover="this.style.background='#DC2626'; this.style.color='white'; this.style.borderColor='#DC2626'" onmouseout="this.style.background='#FEE2E2'; this.style.color='#DC2626'; this.style.borderColor='#FEE2E2'">
                                        <i class="fi-rs-trash" style="font-size: 14px;"></i> Supprimer
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</main>

<script>
// Fonction pour toggle le parcours de vente sur mobile
function toggleSalesJourney() {
    const content = document.querySelector('.sales-journey-content');
    const icon = document.querySelector('.sales-journey-icon');
    
    if (content && icon) {
        content.classList.toggle('expanded');
        icon.classList.toggle('rotated');
    }
}

function previewImage(input, previewId) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = document.getElementById(previewId);
        if (img) {
            img.src = e.target.result;
            if (img.tagName === 'IMG') {
                const wrap = document.getElementById(previewId + '_wrap');
                const num = previewId.replace('preview_', '');
                const placeholder = document.getElementById('placeholder_' + num);
                if (wrap) wrap.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';
            }
        }
    };
    reader.readAsDataURL(input.files[0]);
}

(function() {
    var mainInput = document.getElementById('id_product_image_main');
    var mainPreview = document.getElementById('preview_main');
    var mainWrap = document.getElementById('preview_main_wrap');
    var mainPlaceholder = document.getElementById('upload_main_placeholder');
    if (mainInput && mainPreview && mainWrap && mainPlaceholder) {
        {% if is_edit and product.product_image %}
        mainPreview.src = '{{ product.product_image.url }}';
        mainWrap.style.display = 'block';
        mainPlaceholder.style.display = 'none';
        {% endif %}
        mainInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                var r = new FileReader();
                r.onload = function(e) {
                    mainPreview.src = e.target.result;
                    mainWrap.style.display = 'block';
                    mainPlaceholder.style.display = 'none';
                };
                r.readAsDataURL(this.files[0]);
            }
        });
        var zone = mainInput.closest('.upload-zone-main');
        if (zone) {
            var inner = zone.querySelector('.upload-zone-inner');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(ev) {
                zone.addEventListener(ev, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (ev === 'dragover' || ev === 'dragenter') inner.classList.add('upload-dragover');
                    else if (ev === 'dragleave' || ev === 'drop') inner.classList.remove('upload-dragover');
                    if (ev === 'drop' && e.dataTransfer.files.length) {
                        mainInput.files = e.dataTransfer.files;
                        mainInput.dispatchEvent(new Event('change'));
                    }
                });
            });
        }
    }
})();

function buildDropdownOption(value, label, selected) {
    const div = document.createElement('div');
    div.className = 'flavoriz-dropdown-option' + (selected ? ' selected' : '');
    div.setAttribute('role', 'option');
    div.dataset.value = value;
    div.dataset.label = label;
    div.setAttribute('tabindex', '0');
    div.textContent = label;
    return div;
}

function loadMainCategories(superCategoryId) {
    const mainInput = document.getElementById('main_category');
    const mainLabel = document.getElementById('dropdown-main-label');
    const mainPanel = document.getElementById('main_category_panel');
    const subInput = document.getElementById('sub_category');
    const subLabel = document.getElementById('dropdown-sub-label');
    const subPanel = document.getElementById('sub_category_panel');
    
    mainInput.value = '';
    mainLabel.textContent = 'Sélectionner...';
    subInput.value = '';
    subLabel.textContent = 'Sélectionner...';
    subPanel.innerHTML = '<div class="flavoriz-dropdown-option" role="option" data-value="" data-label="Sélectionner..." tabindex="0">Sélectionner...</div>';
    
    if (!superCategoryId) {
        mainPanel.innerHTML = '<div class="flavoriz-dropdown-option" role="option" data-value="" data-label="Sélectionner..." tabindex="0">Sélectionner...</div>';
        return;
    }
    
    fetch(`/categories/get-main-categories/?super_category_id=${superCategoryId}`)
        .then(response => response.json())
        .then(data => {
            mainPanel.innerHTML = '';
            const opt0 = buildDropdownOption('', 'Sélectionner...', false);
            mainPanel.appendChild(opt0);
            const selectedMain = {% if is_edit and selected_main %}{{ selected_main }}{% else %}null{% endif %};
            data.categories.forEach(cat => {
                const opt = buildDropdownOption(cat.id, cat.name, selectedMain === cat.id);
                mainPanel.appendChild(opt);
            });
            if (selectedMain) {
                const chosen = data.categories.find(c => c.id === selectedMain);
                if (chosen) {
                    mainInput.value = chosen.id;
                    mainLabel.textContent = chosen.name;
                }
            }
            subPanel.innerHTML = '<div class="flavoriz-dropdown-option" role="option" data-value="" data-label="Sélectionner..." tabindex="0">Sélectionner...</div>';
            {% if is_edit and selected_main %}
            if ({{ selected_main }}) {
                loadSubCategories({{ selected_main }});
            }
            {% endif %}
        })
        .catch(error => console.error('Error:', error));
}

function loadSubCategories(mainCategoryId) {
    const subInput = document.getElementById('sub_category');
    const subLabel = document.getElementById('dropdown-sub-label');
    const subPanel = document.getElementById('sub_category_panel');
    
    subInput.value = '';
    subLabel.textContent = 'Sélectionner...';
    
    if (!mainCategoryId) {
        subPanel.innerHTML = '<div class="flavoriz-dropdown-option" role="option" data-value="" data-label="Sélectionner..." tabindex="0">Sélectionner...</div>';
        return;
    }
    
    fetch(`/categories/get-sub-categories/?main_category_id=${mainCategoryId}`)
        .then(response => response.json())
        .then(data => {
            subPanel.innerHTML = '';
            const opt0 = buildDropdownOption('', 'Sélectionner...', false);
            subPanel.appendChild(opt0);
            const selectedSub = {% if is_edit and selected_sub %}{{ selected_sub }}{% else %}null{% endif %};
            data.categories.forEach(cat => {
                const opt = buildDropdownOption(cat.id, cat.name, selectedSub === cat.id);
                subPanel.appendChild(opt);
            });
            if (selectedSub) {
                const chosen = data.categories.find(c => c.id === selectedSub);
                if (chosen) {
                    subInput.value = chosen.id;
                    subLabel.textContent = chosen.name;
                }
            }
            })
        .catch(error => console.error('Error:', error));
}

function initDropdowns() {
    document.querySelectorAll('.flavoriz-dropdown').forEach(wrap => {
        const trigger = wrap.querySelector('.flavoriz-dropdown-trigger');
        const panel = wrap.querySelector('.flavoriz-dropdown-panel');
        const input = wrap.querySelector('input[type="hidden"]');
        const label = wrap.querySelector('.flavoriz-dropdown-label');
        if (!trigger || !panel) return;
        
        trigger.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = wrap.classList.toggle('open');
            panel.hidden = !isOpen;
            if (isOpen) trigger.setAttribute('aria-expanded', 'true');
            else trigger.setAttribute('aria-expanded', 'false');
        });
        
        panel.addEventListener('click', function(e) {
            const opt = e.target.closest('.flavoriz-dropdown-option');
            if (!opt) return;
            e.stopPropagation();
            const value = opt.dataset.value;
            const labelText = opt.dataset.label || opt.textContent;
            if (input) input.value = value;
            if (label) label.textContent = labelText;
            panel.querySelectorAll('.flavoriz-dropdown-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            wrap.classList.remove('open');
            panel.hidden = true;
            trigger.setAttribute('aria-expanded', 'false');
            if (wrap.id === 'dropdown-super-wrap' && value) loadMainCategories(value);
            if (wrap.id === 'dropdown-main-wrap' && value) loadSubCategories(value);
        });
    });
    
    document.addEventListener('click', function() {
        document.querySelectorAll('.flavoriz-dropdown.open').forEach(wrap => {
            wrap.classList.remove('open');
            const panel = wrap.querySelector('.flavoriz-dropdown-panel');
            if (panel) panel.hidden = true;
            const t = wrap.querySelector('.flavoriz-dropdown-trigger');
            if (t) t.setAttribute('aria-expanded', 'false');
        });
    });
}

// URL de base pour la suppression (générée par Django)
const DELETE_PRODUCT_URL_BASE = '{% url "accounts:delete-peer-product" 0 %}'.replace('0', '');

// Fonction pour confirmer la suppression
function confirmDelete(productId, productName) {
    if (confirm(`Êtes-vous sûr de vouloir supprimer l'article "${productName}" ?\n\nCette action est irréversible.`)) {
        // Créer un formulaire pour la suppression
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = DELETE_PRODUCT_URL_BASE + productId + '/';
        
        // Ajouter le token CSRF
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        } else {
            // Récupérer le token depuis les cookies
            const cookies = document.cookie.split(';');
            let csrfValue = null;
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    csrfValue = value;
                    break;
                }
            }
            if (csrfValue) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfValue;
                form.appendChild(csrfInput);
            }
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

window.addEventListener('DOMContentLoaded', function() {
    initDropdowns();
    {% if is_edit and selected_super %}
    var superInput = document.getElementById('super_category');
    if (superInput && superInput.value) {
        var superWrap = document.getElementById('dropdown-super-wrap');
        var superOpt = superWrap && superWrap.querySelector('.flavoriz-dropdown-option.selected');
        if (superOpt) document.getElementById('dropdown-super-label').textContent = superOpt.dataset.label || superOpt.textContent;
        loadMainCategories(superInput.value);
    }
    {% endif %}
});
</script>

<!-- Modal de confirmation de suppression -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
        <h3 style="font-size: 20px; font-weight: 700; color: #1F2937; margin: 0 0 16px 0;">Confirmer la suppression</h3>
        <p style="font-size: 15px; color: #6B7280; margin: 0 0 24px 0; line-height: 1.6;">Êtes-vous sûr de vouloir supprimer cet article ? Cette action est irréversible.</p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="document.getElementById('deleteModal').style.display='none'" style="padding: 12px 24px; background: #F3F4F6; color: #6B7280; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">Annuler</button>
            <form id="deleteForm" method="POST" style="display: inline;">
                {% csrf_token %}
                <button type="submit" style="padding: 12px 24px; background: #DC2626; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">Supprimer</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

